<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>태극도 법식 안내 및 시뮬레이터</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Noto+Serif+KR:wght@500;600;700&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'k-bg': '#fdfbf7',
                        'k-text': '#1a1a1a',
                        'theme-color': '#2c3e50',
                        'theme': '#2c3e50', // 시뮬레이터용 테마색 통합
                        'sub': '#78716c',
                        stone: {
                            50: '#fafaf9', 100: '#f5f5f4', 200: '#e7e5e4', 300: '#d6d3d1',
                            400: '#a8a29e', 500: '#78716c', 600: '#57534e', 700: '#44403c',
                            800: '#292524', 900: '#1c1917',
                        }
                    },
                    fontFamily: {
                        serif: ['"Noto Serif KR"', 'serif'],
                        sans: ['"Noto Sans KR"', 'sans-serif'],
                    },
                    boxShadow: {
                        'card': '0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03)',
                    }
                }
            }
        }
    </script>
    
    <style>
        body {
            background-color: #fdfbf7;
            background-image: radial-gradient(#e6e2d3 1px, transparent 1px);
            background-size: 24px 24px;
            word-break: keep-all; 
        }
        ::selection { background-color: #2c3e50; color: #ffffff; }
        
        /* 로더 애니메이션 */
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #2c3e50;
            width: 32px; height: 32px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* 시뮬레이터 전용 스타일 */
        .white-box {
            @apply bg-white border-2 border-stone-200 rounded-xl shadow-card;
        }
        .badge-theme {
            @apply bg-theme-color/10 text-theme-color text-xs font-bold px-2 py-1 rounded border border-theme-color/20;
        }
        .interactive-item {
            @apply border-2 border-stone-200 hover:border-theme-color transition-all active:scale-95;
        }
    </style>
</head>
<body class="text-k-text font-sans min-h-screen flex flex-col items-center py-6 px-4 sm:px-6">
  
    <!-- 메인 컨테이너 -->
    <main class="w-full max-w-4xl bg-white/90 backdrop-blur-md border-2 border-stone-200 shadow-xl rounded-xl overflow-hidden relative transition-all duration-500">
        
        <!-- 상단 컨트롤 -->
        <div class="absolute top-6 right-6 sm:top-8 sm:right-8 z-20 flex items-center gap-3">
            <a href="index.html" class="flex items-center gap-2 px-4 py-2 bg-white border-2 border-stone-200 rounded-full shadow-card text-stone-600 hover:text-k-text hover:border-theme-color transition-all duration-300 group">
                <i data-lucide="home" class="w-5 h-5"></i>
                <span class="hidden sm:inline font-serif text-base font-bold pt-0.5 group-hover:underline decoration-theme-color underline-offset-4 decoration-2">홈으로</span>
            </a>
        </div>
  
        <!-- 헤더 영역 -->
        <header class="pt-16 pb-8 px-6 sm:px-12 text-center sm:text-left bg-white">
            <div class="flex flex-col sm:items-start items-center">
                <p class="text-sm font-bold text-theme-color/80 mb-2 tracking-widest font-serif">도인(道人)들을 위한 안내</p>
                
                <div class="flex items-center gap-3 mb-2">
                    <i data-lucide="book-open" class="w-8 h-8 text-theme-color"></i>
                    <h1 class="text-4xl sm:text-5xl font-serif font-bold tracking-tight text-theme-color">
                        태극도 법식(法式)
                    </h1>
                </div>
                <div class="w-24 h-1 bg-theme-color mt-4 mb-6 rounded-full"></div>
                
                <p class="text-stone-700 font-medium text-lg sm:text-xl break-keep leading-relaxed">
                    도인들이 갖추어야 할 기본 예법과<br class="hidden sm:block"> 마음가짐을 안내합니다.
                </p>
            </div>
        </header>
  
        <!-- 탭 네비게이션 -->
        <nav class="sticky top-0 z-10 bg-white/95 backdrop-blur border-b-2 border-stone-200 px-4 sm:px-8 py-4 overflow-x-auto shadow-sm">
            <div class="flex gap-3 min-w-max sm:justify-start items-center" id="category-container">
                <div class="px-5 py-2.5 text-stone-400 text-base font-bold">로딩 중...</div>
            </div>
        </nav>
  
        <!-- 컨텐츠 리스트 영역 -->
        <section id="content-list" class="p-4 sm:p-8 space-y-6 bg-stone-50 min-h-[500px]">
            <div class="py-32 text-center flex flex-col items-center justify-center">
                <div class="loader mb-6"></div>
                <p class="text-stone-600 font-serif text-lg font-bold">데이터를 불러오고 있습니다...</p>
            </div>
        </section>

        <!-- SECTION: SIMULATOR (기본적으로 숨김) -->
        <section id="view-simulator" class="hidden p-4 sm:p-8 space-y-8 bg-stone-50 min-h-[500px]">
            <div class="white-box p-6 sm:p-8">
                <div class="flex items-center gap-2 mb-4">
                    <span class="badge-theme">교육</span>
                    <h2 class="text-2xl font-serif font-bold text-k-text">공부방 입실 시뮬레이터</h2>
                </div>
                <div class="space-y-6">
                    <p class="text-lg text-sub font-medium leading-relaxed">
                        복잡한 입실 동선을 시각적으로 익혀보세요.<br>
                        회원과 내수는 뒤로 물러나고, 들어오는 공부자는 기존 인원의 뒤로 돌아갑니다.
                    </p>
                    
                    <div class="bg-stone-50 border border-stone-200 rounded-lg p-6 text-base text-k-text font-medium leading-loose">
                        <ul class="list-disc pl-5 space-y-3">
                            <li><strong class="text-theme-color bg-white px-2 py-0.5 rounded border border-stone-200 shadow-sm">과한 인사 지양</strong> 입실 후에는 과한 인사를 하지 않습니다. 좌배(坐拜)로 시작해서 좌배로 끝날 수 있도록 합니다.</li>
                            <li><strong class="text-theme-color bg-white px-2 py-0.5 rounded border border-stone-200 shadow-sm">회원에게 속도 맞춤</strong> 옆의 회원이 자리에 앉으면 행동을 정돈합니다. 모든 속도는 회원에게 맞춰야 합니다.</li>
                            <li><strong class="text-theme-color bg-white px-2 py-0.5 rounded border border-stone-200 shadow-sm">교대 시 거리 확보</strong> 회원과 내수가 뒤로 물러날 때, 다음 공부자가 지나갈 수 있는 충분한 거리를 확보해야 합니다.</li>
                        </ul>
                    </div>
                </div>
            </div>
          
            <!-- 시뮬레이터 캔버스 및 조작 버튼 -->
            <div class="white-box p-6 flex flex-col items-center">
                <div class="relative w-full max-w-[500px] aspect-square bg-[#F5F5DC] border-4 border-[#8D6E63] rounded-lg mb-6 overflow-hidden shadow-inner">
                    <div class="absolute top-0 left-[60%] -translate-x-1/2 w-1/3 h-3 bg-[#5D4037] rounded-b-md shadow-sm"></div>
                    <div class="absolute top-4 left-[60%] -translate-x-1/2 text-[#5D4037] text-sm font-bold bg-[#F5F5DC]/80 px-2 rounded">향 탁자 (앞)</div>
                    <div class="absolute top-1/2 left-0 -translate-y-1/2 w-3 h-20 bg-[#3E2723] rounded-r shadow-md"></div>
                    <div class="absolute top-1/2 left-5 -translate-y-1/2 text-[#3E2723] text-sm font-bold -rotate-90">출입문</div>
                    <canvas id="simCanvas" width="500" height="500" class="w-full h-full"></canvas>
                </div>
          
                <div class="w-full max-w-[500px] flex flex-col gap-4">
                    <div class="bg-stone-50 p-6 rounded-xl border border-stone-200 min-h-[120px] flex items-center justify-center text-center shadow-sm">
                        <p id="step-description" class="text-lg font-bold text-k-text transition-all break-keep leading-relaxed">시뮬레이션을 시작하려면 아래 버튼을 누르세요.</p>
                    </div>
          
                    <div class="flex justify-between gap-3">
                        <button onclick="simController.prev()" class="interactive-item flex-1 py-4 text-lg text-k-text rounded-lg font-bold bg-white">◀ 이전</button>
                        <button onclick="simController.play()" class="interactive-item flex-1 py-4 text-lg text-white rounded-lg font-bold bg-theme-color border-theme-color hover:bg-stone-800">▶ 재생/정지</button>
                        <button onclick="simController.next()" class="interactive-item flex-1 py-4 text-lg text-k-text rounded-lg font-bold bg-white">다음 ▶</button>
                    </div>
                    <button onclick="simController.reset()" class="w-full py-3 text-sub font-medium hover:text-theme-color text-sm underline decoration-stone-300 underline-offset-4">↺ 처음으로 리셋</button>
                </div>
            </div>
        </section>
  
        <!-- 관리자 패널 -->
        <section id="admin-panel" class="hidden border-t-4 border-theme-color bg-stone-100 p-6 sm:p-10">
            <!-- 관리자 UI 생략 (기존 코드와 동일) -->
            <div class="flex items-center justify-between mb-8">
                <h3 class="font-serif text-2xl font-bold text-k-text flex items-center gap-3">
                    <div class="p-2 bg-theme-color text-white rounded-lg">
                        <i data-lucide="settings" class="w-6 h-6"></i>
                    </div>
                    관리자 패널
                </h3>
                <button onclick="window.resetForm()" class="text-sm font-bold text-stone-500 hover:text-theme-color underline">입력 초기화</button>
            </div>
            
            <form id="post-form" class="space-y-6 bg-white p-6 rounded-xl border-2 border-stone-200 shadow-card">
                <input type="hidden" id="edit-mode-id" value="">
                <div class="grid grid-cols-1 sm:grid-cols-4 gap-6">
                    <div class="sm:col-span-1">
                        <label class="block text-sm font-bold text-stone-600 mb-2">카테고리</label>
                        <select id="input-category" class="w-full h-12 bg-stone-50 border-2 border-stone-300 rounded-lg px-3 text-base font-bold text-k-text focus:border-theme-color outline-none"></select>
                    </div>
                    <div class="sm:col-span-3">
                        <label class="block text-sm font-bold text-stone-600 mb-2">제목</label>
                        <input type="text" id="input-title" placeholder="제목을 입력하세요" class="w-full h-12 bg-stone-50 border-2 border-stone-300 rounded-lg px-4 text-lg font-bold focus:border-theme-color outline-none">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-bold text-stone-600 mb-2">내용</label>
                    <textarea id="input-desc" rows="6" placeholder="상세 내용을 입력하세요." class="w-full bg-stone-50 border-2 border-stone-300 rounded-lg p-4 focus:border-theme-color outline-none"></textarea>
                </div>
                <div class="p-4 bg-stone-50 rounded-lg border-2 border-stone-200">
                    <label class="block text-sm font-bold text-stone-600 mb-2">파일 첨부</label>
                    <input type="file" id="input-file" accept="image/*,video/*" multiple class="w-full text-sm">
                    <div id="file-preview-info" class="mt-3 text-sm text-theme-color font-bold hidden flex flex-col gap-2">
                        <span id="file-name-display"></span>
                        <div id="file-thumbnails" class="flex flex-wrap gap-2"></div>
                    </div>
                </div>
                <button type="submit" id="submit-btn" class="w-full py-4 bg-theme-color text-white rounded-xl hover:bg-stone-800 transition-all font-bold text-lg">게시글 저장하기</button>
            </form>
        </section>
    </main>
  
    <footer class="mt-10 mb-20 text-center text-stone-500 text-sm font-medium">
        <p class="font-serif text-lg text-stone-400 mb-1">Taegeukdo Guide for Do-in</p>
        <p>&copy; 2024 태극도 법식 안내. All rights reserved.</p>
    </footer>

    <!-- 플로팅 버튼 -->
    <div class="fixed bottom-8 right-8 z-40 flex flex-col gap-3">
        <button onclick="window.scrollTo({top: 0, behavior: 'smooth'})" class="p-3 bg-white border-2 border-stone-200 rounded-full shadow-card text-theme-color hover:bg-theme-color hover:text-white transition-all" aria-label="맨 위로"><i data-lucide="arrow-up" class="w-6 h-6"></i></button>
        <button onclick="window.scrollTo({top: document.body.scrollHeight, behavior: 'smooth'})" class="p-3 bg-white border-2 border-stone-200 rounded-full shadow-card text-theme-color hover:bg-theme-color hover:text-white transition-all" aria-label="맨 아래로"><i data-lucide="arrow-down" class="w-6 h-6"></i></button>
    </div>

    <!-- 관리자 모드 토글 -->
    <div class="fixed bottom-8 left-8 z-50 flex items-center gap-2 bg-white pl-4 pr-2 py-2 rounded-full shadow-lg border-2 border-stone-200 scale-90 opacity-80 hover:opacity-100 transition-all">
        <span class="text-xs font-bold text-stone-500">관리자 모드</span>
        <button id="admin-toggle" class="relative inline-flex h-6 w-10 items-center rounded-full bg-stone-300 transition-colors focus:outline-none">
            <span id="toggle-circle" class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform translate-x-1 shadow-sm"></span>
        </button>
    </div>

    <!-- 모달류 생략 (기존과 동일) -->
    <div id="password-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-96 max-w-[90%] border-2 border-stone-200">
            <h3 class="font-serif font-bold text-2xl mb-3 text-k-text flex items-center gap-2"><i data-lucide="lock" class="w-6 h-6"></i> 관리자 인증</h3>
            <input type="password" id="admin-password-input" class="w-full h-12 border-2 rounded-lg text-center font-bold mb-4 focus:border-theme-color outline-none" placeholder="비밀번호">
            <p id="password-error" class="text-sm font-bold text-red-600 mb-4 opacity-0 text-center">비밀번호가 올바르지 않습니다.</p>
            <div class="flex justify-end gap-3">
                <button onclick="window.closePasswordModal()" class="px-5 py-2.5 text-sm font-bold text-stone-500">취소</button>
                <button onclick="window.checkPassword()" class="px-6 py-2.5 bg-theme-color text-white rounded-lg font-bold">확인</button>
            </div>
        </div>
    </div>
    <div id="image-modal" class="hidden fixed inset-0 z-[70] flex items-center justify-center bg-black/90 cursor-zoom-out" onclick="window.closeImageModal()"><img id="modal-image" class="max-w-[95%] max-h-[95%] object-contain rounded-lg shadow-2xl"></div>

    <!-- 삭제 확인 모달 -->
    <div id="delete-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-96 max-w-[90%] border-2 border-stone-200 text-center">
            <div class="w-16 h-16 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-4 text-red-600">
                <i data-lucide="trash-2" class="w-8 h-8"></i>
            </div>
            <h3 class="font-serif font-bold text-2xl mb-2 text-k-text">게시글 삭제</h3>
            <p class="text-stone-600 font-medium mb-6">정말로 이 게시글을 삭제하시겠습니까?</p>
            <div class="flex gap-3">
                <button onclick="window.closeDeleteModal()" class="flex-1 py-3 text-base font-bold text-stone-600 bg-stone-100 hover:bg-stone-200 rounded-lg transition-colors">취소</button>
                <button id="confirm-delete-btn" class="flex-1 py-3 text-base font-bold bg-red-600 text-white rounded-lg hover:bg-red-700 shadow-md transition-colors">삭제</button>
            </div>
        </div>
    </div>

    <!-- Firebase 및 로직 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
  
        const FIX_ORDER = ['시립', '법배', '평배', '향남읍', '좌배', '국궁', '좌·우진보', '법좌', '수련방법', '점호의례', '봉심의례', '부정기휘법'];
        const YOUR_FIREBASE_CONFIG = {
            apiKey: "AIzaSyAoUdyZJQjcT81_2YKzX1rzMJlNAoHcbAw",
            authDomain: "taegeuk-rules.firebaseapp.com",
            projectId: "taegeuk-rules",
            storageBucket: "taegeuk-rules.firebasestorage.app",
            messagingSenderId: "388014641769",
            appId: "1:388014641769:web:f9fd06f30a222663b448f8"
        };
  
        window.isAdminMode = false;
        window.currentCategory = '전체';
        let localContents = [];
        let localCategories = [];
        let db, auth;
        let appId = 'tgd-guide-public';

        // 수정 및 삭제를 위한 상태 변수 복원
        window.editingId = null;
        window.deleteTargetId = null;

        // 시뮬레이터 캔버스 관련
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas ? canvas.getContext('2d') : null;
        const C_MEMBER = '#d97706';
        const C_OESU = '#2563eb';
        const C_NAESU = '#dc2626';

        const simSteps = [
            {
                text: "1. 공부 진행 중 (현재 시간)",
                setup: (s) => {
                    s.p_oesu = {x: 200, y: 150, label: '현 외수', c: C_OESU};
                    s.p_member = {x: 300, y: 150, label: '현 회원', c: C_MEMBER};
                    s.p_naesu = {x: 400, y: 150, label: '현 내수', c: C_NAESU};
                    s.n_oesu = {x: 40, y: 150, label: '다음 외수', c: C_OESU, alpha: 1};   
                    s.n_member = {x: 40, y: 200, label: '다음 회원', c: C_MEMBER, alpha: 1}; 
                    s.n_naesu = {x: 40, y: 320, label: '다음 내수', c: C_NAESU, alpha: 1};   
                }
            },
            {
                text: "2. 교대 준비: 회원과 내수 후퇴",
                desc: "종이 울리면 회원과 내수는 뒤로 물러나 앞자리를 비웁니다. 외수는 가만히 있습니다.",
                animate: (s, p) => {
                    s.p_member.y = lerp(150, 350, p);
                    s.p_naesu.y = lerp(150, 350, p);
                }
            },
            {
                text: "3. 다음 회원 입장",
                desc: "다음 회원이 들어와 외수 뒤를 돌아 중앙 자리로 갑니다.",
                animate: (s, p) => {
                    if(p < 0.2) {
                        const lp = p / 0.2;
                        s.n_member.x = lerp(40, 120, lp);
                        s.n_member.y = lerp(200, 250, lp);
                    } else if (p < 0.5) {
                        const lp = (p - 0.2) / 0.3;
                        s.n_member.x = lerp(120, 300, lp);
                        s.n_member.y = 250;
                    } else {
                        const lp = (p - 0.5) / 0.5;
                        s.n_member.x = 300;
                        s.n_member.y = lerp(250, 150, lp);
                    }
                }
            },
            {
                text: "4. 다음 내수 입장",
                desc: "다음 내수가 들어와 기존 인원들의 등 뒤를 지나, 오른쪽 끝으로 크게 돌아 자리로 갑니다.",
                animate: (s, p) => {
                    if(p < 0.15) {
                        const lp = p / 0.15;
                        s.n_naesu.x = lerp(40, 120, lp);
                        s.n_naesu.y = lerp(320, 250, lp);
                    } else if (p < 0.35) {
                        const lp = (p - 0.15) / 0.2;
                        s.n_naesu.x = lerp(120, 180, lp);
                        s.n_naesu.y = lerp(250, 450, lp); 
                    } else if (p < 0.65) {
                        const lp = (p - 0.35) / 0.3;
                        s.n_naesu.x = lerp(180, 460, lp);
                        s.n_naesu.y = 450;
                    } else if (p < 0.85) {
                        const lp = (p - 0.65) / 0.2;
                        s.n_naesu.x = 460;
                        s.n_naesu.y = lerp(450, 150, lp);
                    } else {
                        const lp = (p - 0.85) / 0.15;
                        s.n_naesu.x = lerp(460, 400, lp);
                        s.n_naesu.y = 150;
                    }
                }
            },
            {
                text: "5. 외수 교대",
                desc: "이전 외수가 뒤로 물러나고, 다음 외수가 문을 닫으며 들어와 앉습니다.",
                animate: (s, p) => {
                    if(p < 0.3) {
                        const lp = p / 0.3;
                        s.p_oesu.y = lerp(150, 350, lp);
                    } else {
                        s.p_oesu.y = 350;
                        const lp = (p - 0.3) / 0.7;
                        if(lp < 0.3) {
                            s.n_oesu.x = lerp(40, 120, lp/0.3);
                            s.n_oesu.y = lerp(150, 250, lp/0.3);
                        } else {
                            s.n_oesu.x = lerp(120, 200, (lp-0.3)/0.7);
                            s.n_oesu.y = lerp(250, 150, (lp-0.3)/0.7);
                        }
                    }
                }
            },
            {
                text: "완료: 공부 시작 / 퇴실",
                desc: "새로운 조가 자리를 잡았습니다. 이전 조는 퇴실합니다.",
                animate: (s, p) => {
                    s.p_member.alpha = 1 - p;
                    s.p_oesu.alpha = 1 - p;
                    s.p_naesu.alpha = 1 - p;
                }
            }
        ];

        function lerp(start, end, t) { return start * (1 - t) + end * t; }

        window.simController = {
            stepIndex: 0,
            progress: 0,
            isPlaying: false,
            lastTime: 0,
            state: {},
            init: function() {
                this.reset();
                requestAnimationFrame((t) => this.loop(t));
            },
            reset: function() {
                this.stepIndex = 0;
                this.progress = 0;
                this.isPlaying = false;
                simSteps[0].setup(this.state);
                this.draw();
                this.updateText();
            },
            next: function() {
                if (this.stepIndex < simSteps.length - 1) {
                    if(simSteps[this.stepIndex].animate) simSteps[this.stepIndex].animate(this.state, 1.0);
                    this.stepIndex++;
                    this.progress = 0;
                    this.updateText();
                    this.draw();
                }
            },
            prev: function() {
                if (this.stepIndex > 0) {
                    this.stepIndex--;
                    this.progress = 0;
                    simSteps[0].setup(this.state);
                    for(let i=1; i<this.stepIndex; i++) {
                        if(simSteps[i].animate) simSteps[i].animate(this.state, 1.0);
                    }
                    this.updateText();
                    this.draw();
                }
            },
            play: function() {
                this.isPlaying = !this.isPlaying;
            },
            updateText: function() {
                const el = document.getElementById('step-description');
                const step = simSteps[this.stepIndex];
                el.innerHTML = `<span class="block text-sm text-theme-color font-bold mb-2 uppercase">Step ${this.stepIndex}</span>${step.text}<br><span class="text-base font-normal text-sub">${step.desc || ''}</span>`;
            },
            loop: function(timestamp) {
                const dt = timestamp - this.lastTime;
                this.lastTime = timestamp;
                // 시뮬레이터 탭이 보일 때만 애니메이션 진행
                if (this.isPlaying && window.currentCategory === '시뮬레이터') {
                    this.progress += dt * 0.0005;
                    if (this.progress >= 1) {
                        this.progress = 1;
                        if(this.stepIndex < simSteps.length - 1) {
                            this.next();
                        } else {
                            this.isPlaying = false;
                        }
                    }
                    if(simSteps[this.stepIndex].animate) {
                        simSteps[this.stepIndex].animate(this.state, this.progress);
                    }
                    this.draw();
                }
                requestAnimationFrame((t) => this.loop(t));
            },
            draw: function() {
                if(!ctx) return;
                ctx.clearRect(0, 0, 500, 500);
                ctx.fillStyle = '#f5f5f4'; ctx.fillRect(0, 0, 100, 500);
                ctx.strokeStyle = '#e7e5e4'; ctx.lineWidth = 1; ctx.beginPath();
                for(let i=100; i<500; i+=50) { ctx.moveTo(i, 0); ctx.lineTo(i, 500); }
                for(let i=0; i<500; i+=50) { ctx.moveTo(100, i); ctx.lineTo(500, i); }
                ctx.stroke();
                ctx.strokeStyle = '#57534e'; ctx.lineWidth = 4; ctx.beginPath();
                ctx.moveTo(100, 0); ctx.lineTo(100, 230); ctx.moveTo(100, 270); ctx.lineTo(100, 500);
                ctx.stroke();
                
                const drawBall = (obj) => {
                    if (!obj || obj.alpha === 0) return;
                    ctx.globalAlpha = obj.alpha !== undefined ? obj.alpha : 1;
                    ctx.fillStyle = obj.c;
                    ctx.beginPath(); ctx.arc(obj.x, obj.y, 22, 0, Math.PI * 2); ctx.fill();
                    ctx.strokeStyle = '#fff'; ctx.lineWidth = 3; ctx.stroke();
                    ctx.fillStyle = '#fff'; ctx.font = 'bold 11px Noto Sans KR'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                    let short = obj.label.includes('회원') ? '회' : (obj.label.includes('외수') ? '외' : '내');
                    ctx.fillText(obj.label.includes('다음') ? '다음' : '기존', obj.x, obj.y - 9);
                    ctx.fillText(short, obj.x, obj.y + 7);
                    ctx.globalAlpha = 1;
                };
                drawBall(this.state.p_oesu);
                drawBall(this.state.p_member);
                drawBall(this.state.p_naesu);
                drawBall(this.state.n_member);
                drawBall(this.state.n_naesu);
                drawBall(this.state.n_oesu);
            }
        };

        // 초기화 루틴
        async function initialize() {
            try {
                const app = initializeApp(YOUR_FIREBASE_CONFIG);
                auth = getAuth(app);
                db = getFirestore(app);
                subscribeToData();
            } catch (error) {
                console.warn("Offline mode", error);
            }
            if (localStorage.getItem('isAdminMode') === 'true') toggleAdminState(true);
            simController.init();
        }

        function subscribeToData() {
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'posts'), (snapshot) => {
                localContents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderContents();
            });
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'categories'), (snapshot) => {
                let cats = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                localCategories = cats.sort((a,b) => FIX_ORDER.indexOf(a.name) - FIX_ORDER.indexOf(b.name)).map(c => c.name);
                renderCategories();
                renderCategorySelect();
                renderContents();
            });
        }

        window.setCategory = (c) => { 
            window.currentCategory = c; 
            renderCategories(); 
            
            const listEl = document.getElementById('content-list');
            const simEl = document.getElementById('view-simulator');
            
            if (c === '시뮬레이터') {
                listEl.classList.add('hidden');
                simEl.classList.remove('hidden');
                simController.reset();
            } else {
                listEl.classList.remove('hidden');
                simEl.classList.add('hidden');
                renderContents();
            }
        };

        function renderCategories() {
            const displayCategories = ['전체', ...localCategories, '시뮬레이터'];
            const container = document.getElementById('category-container');
            container.innerHTML = displayCategories.map(cat => `
                <button onclick="window.setCategory('${cat}')" 
                    class="px-5 py-2.5 rounded-full text-base font-bold border-2 transition-all ${
                        window.currentCategory === cat 
                        ? 'bg-theme-color text-white border-theme-color scale-105 shadow-md' 
                        : 'bg-white text-stone-500 border-stone-200 hover:border-theme-color hover:text-theme-color'
                    }">${cat === '시뮬레이터' ? '✨ ' + cat : cat}</button>
            `).join('');
        }

        // 기존 게시글 렌더링 로직 (제공해주신 코드 그대로 유지)
        function renderContents() {
            const contentListEl = document.getElementById('content-list');
            contentListEl.innerHTML = '';
            let filtered = window.currentCategory === '전체' ? [...localContents] : localContents.filter(item => item.category === window.currentCategory);
            
            // 정렬
            filtered.sort((a, b) => {
                if (window.currentCategory === '전체') {
                    const idxA = FIX_ORDER.indexOf(a.category);
                    const idxB = FIX_ORDER.indexOf(b.category);
                    if (idxA !== idxB) return (idxA === -1 ? 999 : idxA) - (idxB === -1 ? 999 : idxB);
                }
                return (b.createdAt || 0) - (a.createdAt || 0);
            });

            if (filtered.length === 0 && window.currentCategory !== '시뮬레이터') {
                contentListEl.innerHTML = '<div class="py-32 text-center text-stone-400 font-bold font-serif">등록된 안내 글이 없습니다.</div>';
                return;
            }

            filtered.forEach(item => {
                const div = document.createElement('div');
                div.className = 'p-6 sm:p-8 bg-white border-2 border-stone-200 rounded-xl shadow-card transition-all group relative mb-6 hover:border-theme-color';
                const images = item.images || (item.image ? [item.image] : []);
                let mediaHtml = images.length > 0 ? `<div class="mb-6"><img src="${images[0]}" class="w-full max-h-[500px] rounded-xl object-contain bg-stone-100 border border-stone-200"></div>` : '';
                
                div.innerHTML = `
                    ${mediaHtml}
                    <div class="flex items-center gap-3 mb-4">
                        <span class="text-sm font-bold text-theme-color bg-theme-color/10 px-3 py-1 rounded-full border border-theme-color/20">${item.category}</span>
                    </div>
                    <h2 class="text-2xl sm:text-3xl font-serif font-bold mb-4 text-k-text group-hover:text-theme-color">${item.title}</h2>
                    <p class="text-stone-700 leading-loose text-base sm:text-lg font-medium whitespace-pre-line">${item.desc}</p>
                    ${window.isAdminMode ? `
                        <div class="absolute top-6 right-6 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="window.editPost('${item.id}')" class="p-2 bg-white border-2 rounded-lg text-stone-500 hover:text-theme-color"><i data-lucide="edit-2" class="w-5 h-5"></i></button>
                            <button onclick="window.openDeleteModal('${item.id}')" class="p-2 bg-white border-2 rounded-lg text-stone-500 hover:text-red-600"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                        </div>
                    ` : ''}
                `;
                contentListEl.appendChild(div);
            });
            lucide.createIcons();
        }

        function renderCategorySelect() {
            const sel = document.getElementById('input-category');
            if(sel) sel.innerHTML = localCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
        }

        // 관리자 모드 관련
        window.checkPassword = async () => {
            if (document.getElementById('admin-password-input').value === "taegeuk1909#") {
                await signInAnonymously(auth);
                toggleAdminState(true);
                window.closePasswordModal();
            } else {
                document.getElementById('password-error').classList.remove('opacity-0');
            }
        };

        function toggleAdminState(enable) {
            window.isAdminMode = enable;
            localStorage.setItem('isAdminMode', enable);
            const btn = document.getElementById('admin-toggle');
            const circle = document.getElementById('toggle-circle');
            const panel = document.getElementById('admin-panel');
            if (enable) {
                btn.classList.replace('bg-stone-300', 'bg-theme-color');
                circle.classList.add('translate-x-5');
                panel.classList.remove('hidden');
            } else {
                btn.classList.replace('bg-theme-color', 'bg-stone-300');
                circle.classList.remove('translate-x-5');
                panel.classList.add('hidden');
            }
            renderContents();
        }

        window.closePasswordModal = () => document.getElementById('password-modal').classList.add('hidden');
        document.getElementById('admin-toggle').addEventListener('click', () => {
            if (window.isAdminMode) toggleAdminState(false);
            else document.getElementById('password-modal').classList.remove('hidden');
        });

        // --- 누락된 게시글 작성, 수정, 삭제 로직 복원 ---
        const postFormEl = document.getElementById('post-form');
        const fileInput = document.getElementById('input-file');
        const submitBtn = document.getElementById('submit-btn');

        window.resetForm = () => { 
            window.editingId = null; 
            postFormEl.reset(); 
            document.getElementById('file-preview-info').classList.add('hidden');
            const thumbnailsContainer = document.getElementById('file-thumbnails');
            if(thumbnailsContainer) thumbnailsContainer.innerHTML = '';
            submitBtn.innerText = "게시글 저장하기";
        };

        function processFile(file, maxDim = 800, quality = 0.6) {
            return new Promise((resolve, reject) => {
                if (file.type.startsWith('video')) {
                    if (file.size > 700 * 1024) { reject("동영상 파일은 700KB 이하여야 합니다."); return; }
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = () => reject("동영상 파일 읽기 실패");
                    reader.readAsDataURL(file);
                } else if (file.type.startsWith('image')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let width = img.width; let height = img.height;
                            if (width > height) { if (width > maxDim) { height *= maxDim / width; width = maxDim; } } 
                            else { if (height > maxDim) { width *= maxDim / height; height = maxDim; } }
                            canvas.width = width; canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            resolve(canvas.toDataURL('image/jpeg', quality));
                        };
                        img.onerror = () => reject("지원하지 않는 이미지 형식이거나 손상된 파일입니다.");
                        img.src = e.target.result;
                    };
                    reader.onerror = () => reject("이미지 파일 읽기 실패");
                    reader.readAsDataURL(file);
                } else {
                    reject("지원하지 않는 파일 형식입니다.");
                }
            });
        }

        postFormEl.addEventListener('submit', async (e) => {
            e.preventDefault();
            const category = document.getElementById('input-category').value;
            const title = document.getElementById('input-title').value;
            const desc = document.getElementById('input-desc').value;
            const files = Array.from(fileInput.files);
            
            if (!title || !desc) return alert("제목과 내용을 입력해주세요.");
  
            submitBtn.disabled = true;
            submitBtn.innerText = "저장 중...";
  
            try {
                let processedImages = [];
                let totalSize = 0;
                
                const fileCount = files.length;
                const dynamicMaxDim = fileCount > 2 ? 600 : 800;
                const dynamicQuality = fileCount > 2 ? 0.5 : 0.6;
  
                for (const f of files) {
                    const dataUrl = await processFile(f, dynamicMaxDim, dynamicQuality);
                    totalSize += dataUrl.length;
                    processedImages.push(dataUrl);
                }
  
                if (totalSize > 900000) {
                    throw new Error(`파일 용량이 너무 큽니다. 여러 장일 경우 나누어서 올리거나, 더 적은 수의 사진을 선택해주세요.`);
                }
  
                let finalImages = processedImages;
                let finalDate = new Date().toISOString().split('T')[0].replace(/-/g, '.');
                let finalCreatedAt = Date.now();
  
                if (window.editingId) {
                    const existingPost = localContents.find(p => String(p.id) === String(window.editingId));
                    if (existingPost) {
                        if (finalImages.length === 0) {
                            finalImages = existingPost.images || (existingPost.image ? [existingPost.image] : []);
                        }
                        finalDate = existingPost.date || finalDate;
                        finalCreatedAt = existingPost.createdAt || finalCreatedAt;
                    }
                }
  
                const postData = {
                    category, title, desc,
                    images: finalImages,
                    date: finalDate,
                    createdAt: finalCreatedAt
                };
  
                if (window.editingId) {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'posts', window.editingId), postData);
                } else {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'posts'), postData);
                }
                window.resetForm();
                alert("저장되었습니다.");
            } catch (err) {
                alert("업로드 실패: " + (err.message || err));
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerText = "게시글 저장하기";
            }
        });

        window.editPost = (id) => {
            const p = localContents.find(x => String(x.id) === String(id));
            if (!p) return;
            window.editingId = id;
            document.getElementById('input-category').value = p.category;
            document.getElementById('input-title').value = p.title;
            document.getElementById('input-desc').value = p.desc;
            
            const images = p.images || (p.image ? [p.image] : []);
            const previewInfo = document.getElementById('file-preview-info');
            const nameDisplay = document.getElementById('file-name-display');
            const thumbnailsContainer = document.getElementById('file-thumbnails');
            
            if (images.length > 0) {
                previewInfo.classList.remove('hidden');
                nameDisplay.innerText = `기존 파일 ${images.length}개가 유지됩니다.`;
                thumbnailsContainer.innerHTML = images.map(src => `<img src="${src}" class="w-16 h-16 object-cover rounded-md border-2 border-stone-200 shadow-sm opacity-60">`).join('');
            } else {
                previewInfo.classList.add('hidden');
                thumbnailsContainer.innerHTML = '';
            }
            
            document.getElementById('admin-panel').scrollIntoView({ behavior: 'smooth' });
        };

        window.openDeleteModal = (id) => { 
            window.deleteTargetId = id; 
            document.getElementById('delete-modal').classList.remove('hidden'); 
        };
        window.closeDeleteModal = () => document.getElementById('delete-modal').classList.add('hidden');
        
        document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
            if (window.deleteTargetId) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'posts', window.deleteTargetId));
                window.closeDeleteModal();
            }
        });

        fileInput.addEventListener('change', () => {
            const files = Array.from(fileInput.files);
            const previewInfo = document.getElementById('file-preview-info');
            const nameDisplay = document.getElementById('file-name-display');
            const thumbnailsContainer = document.getElementById('file-thumbnails');
            
            thumbnailsContainer.innerHTML = ''; 
  
            if (files.length > 0) {
                previewInfo.classList.remove('hidden');
                nameDisplay.innerText = `${files.length}개의 파일이 선택되었습니다.`;
                
                files.forEach(file => {
                    if (file.type.startsWith('image')) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const img = document.createElement('img');
                            img.src = e.target.result;
                            img.className = 'w-16 h-16 object-cover rounded-md border-2 border-stone-200 shadow-sm';
                            thumbnailsContainer.appendChild(img);
                        };
                        reader.readAsDataURL(file);
                    }
                });
            } else {
                if (!window.editingId) previewInfo.classList.add('hidden');
            }
        });

        initialize();
        lucide.createIcons();
    </script>
<!-- 검색어 형광펜 및 자동 스크롤 기능 -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    // 1. 넘어온 링크에서 검색어(search) 정보를 꺼냅니다.
    const params = new URLSearchParams(window.location.search);
    const keyword = params.get('search');
    
    if (keyword) {
        // 2. 본문 내용 중 텍스트만 쏙쏙 골라냅니다.
        const walk = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT, null, false);
        let node;
        const textNodes = [];
        while (node = walk.nextNode()) {
            if (node.parentNode.nodeName !== 'SCRIPT' && node.parentNode.nodeName !== 'STYLE') {
                textNodes.push(node);
            }
        }
        
        let found = false;
        // 3. 골라낸 텍스트 중에 검색어가 있으면 노란색 형광펜(<mark>)을 칠합니다.
        textNodes.forEach(textNode => {
            if (textNode.nodeValue.includes(keyword)) {
                const span = document.createElement('span');
                const regex = new RegExp(`(${keyword})`, 'gi');
                span.innerHTML = textNode.nodeValue.replace(regex, '<mark style="background-color: #fef08a; color: #1a1a1a; padding: 0 2px; border-radius: 2px; font-weight: bold;">$1</mark>');
                textNode.parentNode.replaceChild(span, textNode);
                found = true;
            }
        });

        // 4. 형광펜이 칠해졌다면, 그 위치로 화면을 부드럽게 스크롤해 내려줍니다.
        if (found) {
            setTimeout(() => {
                const firstMark = document.querySelector('mark');
                if (firstMark) {
                    firstMark.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 100);
        }
    }
});
</script>
</body>
</html>
