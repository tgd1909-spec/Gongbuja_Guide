<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>태극도 법식 안내</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Noto+Serif+KR:wght@500;600;700&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'k-bg': '#fdfbf7',
                        'k-text': '#1a1a1a',
                        'theme-color': '#2c3e50',
                        stone: {
                            50: '#fafaf9', 100: '#f5f5f4', 200: '#e7e5e4', 300: '#d6d3d1',
                            400: '#a8a29e', 500: '#78716c', 600: '#57534e', 700: '#44403c',
                            800: '#292524', 900: '#1c1917',
                        }
                    },
                    fontFamily: {
                        serif: ['"Noto Serif KR"', 'serif'],
                        sans: ['"Noto Sans KR"', 'sans-serif'],
                    },
                    boxShadow: {
                        'card': '0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03)',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #fdfbf7;
            background-image: radial-gradient(#e6e2d3 1px, transparent 1px);
            background-size: 24px 24px;
            word-break: keep-all; 
        }
        ::selection { background-color: #2c3e50; color: #ffffff; }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #2c3e50;
            width: 32px; height: 32px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .new-badge { animation: pulse-theme 2s infinite; }
        @keyframes pulse-theme {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(44, 62, 80, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 6px rgba(44, 62, 80, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(44, 62, 80, 0); }
        }
    </style>
</head>
<body class="text-k-text font-sans min-h-screen flex flex-col items-center py-6 px-4 sm:px-6">

    <!-- 메인 컨테이너 -->
    <main class="w-full max-w-4xl bg-white/90 backdrop-blur-md border-2 border-stone-200 shadow-xl rounded-xl overflow-hidden relative transition-all duration-500">
        
        <!-- 상단 컨트롤 (홈 버튼) -->
        <div class="absolute top-6 right-6 sm:top-8 sm:right-8 z-20 flex items-center gap-3">
            <a href="index.html" class="flex items-center gap-2 px-4 py-2 bg-white border-2 border-stone-200 rounded-full shadow-card text-stone-600 hover:text-k-text hover:border-theme-color transition-all duration-300 group">
                <i data-lucide="home" class="w-5 h-5"></i>
                <span class="hidden sm:inline font-serif text-base font-bold pt-0.5 group-hover:underline decoration-theme-color underline-offset-4 decoration-2">홈으로</span>
            </a>
        </div>

        <!-- 헤더 영역 -->
        <header class="pt-16 pb-8 px-6 sm:px-12 text-center sm:text-left bg-white">
            <div class="flex flex-col sm:items-start items-center">
                <p class="text-sm font-bold text-theme-color/80 mb-2 tracking-widest font-serif">도인들을 위한 안내</p>
                
                <div class="flex items-center gap-3 mb-2">
                    <i data-lucide="book-open" class="w-8 h-8 text-theme-color"></i>
                    <h1 class="text-4xl sm:text-5xl font-serif font-bold tracking-tight text-theme-color">
                        태극도 법식(法式)
                    </h1>
                </div>
                <div class="w-24 h-1 bg-theme-color mt-4 mb-6 rounded-full"></div>
                
                <p class="text-stone-700 font-medium text-lg sm:text-xl break-keep leading-relaxed mb-6">
                    도인들이 갖추어야 할 기본 예법과<br class="hidden sm:block"> 도인으로서의 마음가짐을 안내합니다.
                </p>

                <!-- 시뮬레이터 토글 버튼 -->
                <button id="simulator-toggle-btn" onclick="window.toggleSimulator()" class="flex items-center gap-2 px-6 py-3 bg-theme-color text-white rounded-full shadow-md hover:bg-[#1a252f] transition-all transform hover:-translate-y-1 font-bold group">
                    <span id="simulator-toggle-icon"><i data-lucide="play-circle" class="w-5 h-5"></i></span>
                    <span id="simulator-toggle-text">입실 시뮬레이터 실행하기</span>
                </button>
            </div>
        </header>

        <!-- 탭 네비게이션 -->
        <nav class="sticky top-0 z-10 bg-white/95 backdrop-blur border-y-2 border-stone-200 px-4 sm:px-8 py-4 overflow-x-auto shadow-sm">
            <div class="flex gap-3 min-w-max sm:justify-start" id="category-container">
                <div class="px-5 py-2.5 text-stone-400 text-base font-bold">로딩 중...</div>
            </div>
        </nav>

        <!-- 시뮬레이터 영역 (초기 숨김) -->
        <section id="view-simulator" class="hidden p-4 sm:p-8 bg-stone-50 border-b-2 border-stone-200 space-y-8 animate-in slide-in-from-top-4 fade-in duration-500">
            <!-- 시뮬레이터 설명 박스 -->
            <div class="bg-white border-2 border-stone-200 rounded-xl p-6 sm:p-8 shadow-card">
                <div class="flex items-center gap-2 mb-4">
                    <span class="px-3 py-1 bg-theme-color/10 text-theme-color text-sm font-bold rounded-full border border-theme-color/20">교육</span>
                    <h2 class="text-2xl font-serif font-bold text-k-text">공부방 입실 시뮬레이터</h2>
                </div>
                <div class="space-y-6">
                    <p class="text-lg text-stone-600 font-medium leading-relaxed">
                        복잡한 입실 동선을 시각적으로 익혀보세요.<br class="hidden sm:block">
                        회원과 내수는 뒤로 물러나고, 들어오는 사람은 기존 사람들의 뒤로 돌아갑니다.
                    </p>
                    
                    <div class="bg-stone-50 border border-stone-200 rounded-lg p-6 text-base text-k-text font-medium leading-loose">
                        <ul class="list-disc pl-5 space-y-3">
                            <li><strong class="text-theme-color bg-white px-2 py-0.5 rounded border border-stone-200 shadow-sm">과한 인사 지양</strong> 입실 후에는 너무 과한 인사를 하지 않습니다. 좌배(坐拜)로 시작해서 좌배로 끝날 수 있도록 과한 부복(엎드려 절함)은 하지 않습니다.</li>
                            <li><strong class="text-theme-color bg-white px-2 py-0.5 rounded border border-stone-200 shadow-sm">회원에게 속도 맞춤</strong> 옆의 회원이 자리에 앉으면 청소를 멈추고 정돈합니다. 모든 행동의 속도는 회원에게 맞춰야 합니다.</li>
                            <li><strong class="text-theme-color bg-white px-2 py-0.5 rounded border border-stone-200 shadow-sm">교대 시 거리 확보</strong> 회원과 내수가 엉덩이를 뒤로 물릴 때, 다음 공부자가 지나갈 수 있는 거리를 확보하고 물러나야 합니다. 너무 뒤로 물러나면 벽과의 공간이 없어 통행이 어렵습니다.</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- 시뮬레이터 캔버스 및 조작 버튼 -->
            <div class="bg-white border-2 border-stone-200 rounded-xl p-6 sm:p-8 shadow-card flex flex-col items-center">
                <!-- 캔버스 영역 -->
                <div class="relative w-full max-w-[500px] aspect-square bg-[#F5F5DC] border-4 border-[#8D6E63] rounded-lg mb-6 overflow-hidden shadow-inner">
                    <div class="absolute top-0 left-[60%] -translate-x-1/2 w-1/3 h-3 bg-[#5D4037] rounded-b-md shadow-sm"></div>
                    <div class="absolute top-4 left-[60%] -translate-x-1/2 text-[#5D4037] text-sm font-bold bg-[#F5F5DC]/80 px-2 rounded">향 탁자 (앞)</div>
                    <div class="absolute top-1/2 left-0 -translate-y-1/2 w-3 h-20 bg-[#3E2723] rounded-r shadow-md"></div>
                    <div class="absolute top-1/2 left-5 -translate-y-1/2 text-[#3E2723] text-sm font-bold -rotate-90">출입문</div>
                    <canvas id="simCanvas" width="500" height="500" class="w-full h-full"></canvas>
                </div>

                <!-- 조작 버튼 영역 -->
                <div class="w-full max-w-[500px] flex flex-col gap-4">
                    <div class="bg-stone-50 p-6 rounded-xl border border-stone-200 min-h-[100px] flex items-center justify-center text-center shadow-sm">
                        <p id="step-description" class="text-lg font-bold text-k-text transition-all break-keep leading-relaxed">시뮬레이션을 시작하려면 아래 버튼을 누르세요.</p>
                    </div>

                    <div class="flex justify-between gap-3">
                        <button onclick="window.simController.prev()" class="flex-1 py-4 text-base sm:text-lg text-k-text rounded-lg font-bold bg-white border-2 border-stone-200 hover:border-theme-color hover:text-theme-color transition-all duration-300 transform hover:-translate-y-1 shadow-sm">◀ 이전</button>
                        <button onclick="window.simController.play()" class="flex-1 py-4 text-base sm:text-lg text-white rounded-lg font-bold bg-theme-color hover:bg-[#1a252f] transition-all duration-300 transform hover:-translate-y-1 shadow-md">▶ 재생/정지</button>
                        <button onclick="window.simController.next()" class="flex-1 py-4 text-base sm:text-lg text-k-text rounded-lg font-bold bg-white border-2 border-stone-200 hover:border-theme-color hover:text-theme-color transition-all duration-300 transform hover:-translate-y-1 shadow-sm">다음 ▶</button>
                    </div>
                    <button onclick="window.simController.reset()" class="w-full py-3 text-stone-500 font-medium hover:text-theme-color text-sm underline decoration-stone-300 underline-offset-4 transition-colors">↺ 처음으로 리셋</button>
                </div>
            </div>
        </section>

        <!-- 컨텐츠 리스트 영역 -->
        <section id="content-list" class="p-4 sm:p-8 space-y-6 bg-stone-50 min-h-[500px]">
            <div class="py-32 text-center flex flex-col items-center justify-center">
                <div class="loader mb-6"></div>
                <p class="text-stone-600 font-serif text-lg font-bold">데이터를 불러오고 있습니다...</p>
            </div>
        </section>

        <!-- 관리자 패널 (숨김 상태) -->
        <section id="admin-panel" class="hidden border-t-4 border-theme-color bg-stone-100 p-6 sm:p-10">
            <div class="flex items-center justify-between mb-8">
                <h3 class="font-serif text-2xl font-bold text-k-text flex items-center gap-3">
                    <div class="p-2 bg-theme-color text-white rounded-lg">
                        <i data-lucide="settings" class="w-6 h-6"></i>
                    </div>
                    관리자 패널
                </h3>
                <div class="flex gap-4">
                    <!-- 데이터 복구 버튼 (임시 추가) -->
                    <button onclick="window.forceRestoreData()" class="text-sm font-bold text-red-500 hover:text-red-700 underline decoration-2 underline-offset-4" title="로컬 저장소의 데이터를 파이어베이스로 밀어넣습니다.">데이터 강제 복구</button>
                    <button onclick="window.resetForm()" class="text-sm font-bold text-stone-500 hover:text-theme-color underline decoration-2 underline-offset-4">입력 초기화</button>
                </div>
            </div>

            <!-- 카테고리 관리 섹션 -->
            <div class="mb-10 p-6 bg-white rounded-xl border-2 border-stone-200 shadow-card">
                <label class="block text-sm font-bold text-stone-600 mb-4 flex items-center gap-2">
                    <i data-lucide="tags" class="w-4 h-4 text-theme-color"></i> 카테고리 관리
                </label>
                <div class="flex flex-wrap gap-3 mb-5" id="admin-category-list"></div>
                <div class="flex gap-3 h-12">
                    <input type="text" id="new-category-input" placeholder="새 카테고리 추가" 
                        class="flex-1 bg-stone-50 border-2 border-stone-300 rounded-lg px-4 text-base focus:outline-none focus:border-theme-color focus:bg-white transition-colors text-k-text placeholder-stone-400 font-medium"
                        onkeypress="if(event.key === 'Enter') window.addCategory()">
                    <button onclick="window.addCategory()" class="px-6 bg-theme-color text-white rounded-lg hover:bg-stone-800 text-base font-bold transition-colors whitespace-nowrap shadow-md">
                        추가
                    </button>
                </div>
            </div>
            
            <!-- 글쓰기 폼 -->
            <form id="post-form" class="space-y-6 bg-white p-6 rounded-xl border-2 border-stone-200 shadow-card">
                <input type="hidden" id="edit-mode-id" value="">
                
                <div class="grid grid-cols-1 sm:grid-cols-4 gap-6">
                    <div class="sm:col-span-1">
                        <label class="block text-sm font-bold text-stone-600 mb-2">카테고리 선택</label>
                        <select id="input-category" class="w-full h-12 bg-stone-50 border-2 border-stone-300 rounded-lg px-3 text-base font-bold text-k-text focus:outline-none focus:border-theme-color cursor-pointer appearance-none">
                        </select>
                    </div>
                    <div class="sm:col-span-3">
                        <label class="block text-sm font-bold text-stone-600 mb-2">제목</label>
                        <input type="text" id="input-title" placeholder="제목을 입력하세요" class="w-full h-12 bg-stone-50 border-2 border-stone-300 rounded-lg px-4 text-lg font-bold text-k-text focus:outline-none focus:border-theme-color focus:bg-white font-serif placeholder-stone-400">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-bold text-stone-600 mb-2">내용</label>
                    <textarea id="input-desc" rows="6" placeholder="상세 내용을 입력하세요." class="w-full bg-stone-50 border-2 border-stone-300 rounded-lg p-4 text-base text-k-text leading-relaxed focus:outline-none focus:border-theme-color focus:bg-white placeholder-stone-400"></textarea>
                </div>

                <div class="p-4 bg-stone-50 rounded-lg border-2 border-stone-200">
                    <label class="block text-sm font-bold text-stone-600 mb-2 flex items-center gap-2">
                        <i data-lucide="image" class="w-4 h-4"></i> 사진/영상 첨부
                    </label>
                    <input type="file" id="input-file" accept="image/*,video/*" multiple class="w-full bg-white border-2 border-stone-300 rounded-lg p-2 text-sm focus:outline-none focus:border-theme-color file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-bold file:bg-stone-200 file:text-stone-700 hover:file:bg-stone-300 cursor-pointer">
                    <div id="file-preview-info" class="mt-3 text-sm text-theme-color font-bold hidden flex items-center gap-2">
                        <i data-lucide="check-circle" class="w-4 h-4"></i><span id="file-name-display"></span>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-bold text-stone-600 mb-2">URL (선택)</label>
                    <input type="text" id="input-image-url" placeholder="https://..." class="w-full h-12 bg-stone-50 border-2 border-stone-300 rounded-lg px-4 text-base focus:outline-none focus:border-theme-color focus:bg-white text-k-text font-medium">
                </div>

                <div class="pt-4">
                    <button type="submit" id="submit-btn" class="w-full py-4 bg-theme-color text-white rounded-xl hover:bg-stone-800 transition-all transform hover:-translate-y-1 text-lg font-bold shadow-lg flex items-center justify-center gap-2">
                        <i data-lucide="pen-line" class="w-5 h-5"></i>
                        <span id="submit-btn-text">게시글 저장하기</span>
                    </button>
                </div>
            </form>
        </section>

    </main>

    <!-- 푸터 -->
    <footer class="mt-10 mb-20 text-center text-stone-500 text-sm font-medium">
        <p class="font-serif text-lg text-stone-400 mb-1">Taegeukdo Guide for Do-in</p>
        <p>&copy; 2024 태극도 법식 안내. All rights reserved.</p>
    </footer>

    <!-- 플로팅 버튼 -->
    <div class="fixed bottom-8 right-8 z-40 flex flex-col gap-3">
        <!-- Top Scroll -->
        <button onclick="window.scrollTo({top: 0, behavior: 'smooth'})" class="p-3 bg-white border-2 border-stone-200 rounded-full shadow-card text-theme-color hover:bg-theme-color hover:text-white transition-all transform hover:-translate-y-1" aria-label="맨 위로">
            <i data-lucide="arrow-up" class="w-6 h-6"></i>
        </button>
        <!-- Bottom Scroll -->
        <button onclick="window.scrollTo({top: document.body.scrollHeight, behavior: 'smooth'})" class="p-3 bg-white border-2 border-stone-200 rounded-full shadow-card text-theme-color hover:bg-theme-color hover:text-white transition-all transform hover:-translate-y-1" aria-label="맨 아래로">
            <i data-lucide="arrow-down" class="w-6 h-6"></i>
        </button>
    </div>

    <!-- 관리자 모드 토글 -->
    <div class="fixed bottom-8 left-8 z-50 flex items-center gap-2 bg-white pl-4 pr-2 py-2 rounded-full shadow-lg border-2 border-stone-200 scale-90 opacity-80 hover:opacity-100 transition-all">
        <span class="text-xs font-bold text-stone-500">관리자 모드</span>
        <button id="admin-toggle" class="relative inline-flex h-6 w-10 items-center rounded-full bg-stone-300 transition-colors focus:outline-none">
            <span id="toggle-circle" class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform translate-x-1 shadow-sm"></span>
        </button>
    </div>

    <!-- 이미지 확대 모달 -->
    <div id="image-modal" class="hidden fixed inset-0 z-[70] flex items-center justify-center bg-black/90 backdrop-blur-sm cursor-zoom-out" onclick="window.closeImageModal()">
        <img id="modal-image" src="" alt="확대 이미지" class="max-w-[95%] max-h-[95%] object-contain rounded-lg shadow-2xl transition-all scale-95 opacity-0">
    </div>

    <!-- 비밀번호 확인 모달 -->
    <div id="password-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm transition-opacity duration-300">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-96 max-w-[90%] border-2 border-stone-200">
            <h3 class="font-serif font-bold text-2xl mb-3 text-k-text flex items-center gap-2">
                <i data-lucide="lock" class="w-6 h-6 text-theme-color"></i> 관리자 인증
            </h3>
            <p class="text-sm font-bold text-stone-500 mb-6">관리자 비밀번호를 입력해주세요.</p>
            <input type="password" id="admin-password-input" 
                class="w-full h-12 bg-stone-50 border-2 border-stone-300 rounded-lg px-4 text-lg mb-3 focus:outline-none focus:border-theme-color focus:bg-white text-center tracking-widest font-bold text-k-text" 
                placeholder="비밀번호" 
                onkeypress="if(event.key === 'Enter') window.checkPassword()">
            <p id="password-error" class="text-sm font-bold text-red-600 mb-6 opacity-0 transition-opacity text-center">
                비밀번호가 올바르지 않습니다.
            </p>
            <div class="flex justify-end gap-3">
                <button onclick="window.closePasswordModal()" class="px-5 py-2.5 text-sm font-bold text-stone-500 hover:bg-stone-100 rounded-lg transition-colors">취소</button>
                <button onclick="window.checkPassword()" class="px-6 py-2.5 text-sm font-bold bg-theme-color text-white rounded-lg hover:bg-stone-800 shadow-md transition-colors">확인</button>
            </div>
        </div>
    </div>

    <!-- 삭제 확인 모달 -->
    <div id="delete-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-96 max-w-[90%] border-2 border-stone-200 text-center">
            <div class="w-16 h-16 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-4 text-red-600">
                <i data-lucide="trash-2" class="w-8 h-8"></i>
            </div>
            <h3 class="font-serif font-bold text-2xl mb-2 text-k-text">게시글 삭제</h3>
            <p class="text-stone-600 font-medium mb-6">정말로 이 게시글을 삭제하시겠습니까?</p>
            <div class="flex gap-3">
                <button onclick="window.closeDeleteModal()" class="flex-1 py-3 text-base font-bold text-stone-600 bg-stone-100 hover:bg-stone-200 rounded-lg transition-colors">취소</button>
                <button id="confirm-delete-btn" class="flex-1 py-3 text-base font-bold bg-red-600 text-white rounded-lg hover:bg-red-700 shadow-md transition-colors">삭제</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK 및 앱 로직 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ==========================================
        // 시뮬레이터(Simulator) 로직
        // ==========================================
        const canvas = document.getElementById('simCanvas');
        let ctx = null;
        if(canvas) ctx = canvas.getContext('2d');

        const C_MEMBER = '#d97706';
        const C_OESU = '#2563eb';
        const C_NAESU = '#dc2626';

        window.lerp = function(start, end, t) {
            return start * (1 - t) + end * t;
        }

        const simSteps = [
            {
                text: "1. 공부 진행 중 (현재 시간)",
                setup: (s) => {
                    s.p_oesu = {x: 200, y: 150, label: '현 외수', c: C_OESU};
                    s.p_member = {x: 300, y: 150, label: '현 회원', c: C_MEMBER};
                    s.p_naesu = {x: 400, y: 150, label: '현 내수', c: C_NAESU};
                    s.n_oesu = {x: 40, y: 150, label: '다음 외수', c: C_OESU, alpha: 1};   
                    s.n_member = {x: 40, y: 200, label: '다음 회원', c: C_MEMBER, alpha: 1}; 
                    s.n_naesu = {x: 40, y: 320, label: '다음 내수', c: C_NAESU, alpha: 1};   
                }
            },
            {
                text: "2. 교대 준비: 회원과 내수 후퇴",
                desc: "종이 울리면 회원과 내수는 뒤로 물러나 앞자리를 비웁니다. 외수는 가만히 있습니다.",
                animate: (s, p) => {
                    s.p_member.y = window.lerp(150, 350, p);
                    s.p_naesu.y = window.lerp(150, 350, p);
                }
            },
            {
                text: "3. 다음 회원 입장",
                desc: "다음 회원이 들어와 외수 뒤를 돌아 중앙 자리로 갑니다.",
                animate: (s, p) => {
                    if(p < 0.2) {
                        const lp = p / 0.2;
                        s.n_member.x = window.lerp(40, 120, lp);
                        s.n_member.y = window.lerp(200, 250, lp);
                    } else if (p < 0.5) {
                        const lp = (p - 0.2) / 0.3;
                        s.n_member.x = window.lerp(120, 300, lp);
                        s.n_member.y = 250;
                    } else {
                        const lp = (p - 0.5) / 0.5;
                        s.n_member.x = 300;
                        s.n_member.y = window.lerp(250, 150, lp);
                    }
                }
            },
            {
                text: "4. 다음 내수 입장",
                desc: "다음 내수가 들어와 기존 인원들의 등 뒤를 지나, 오른쪽 끝으로 크게 돌아 자리로 갑니다.",
                animate: (s, p) => {
                    if(p < 0.15) {
                        const lp = p / 0.15;
                        s.n_naesu.x = window.lerp(40, 120, lp);
                        s.n_naesu.y = window.lerp(320, 250, lp);
                    } else if (p < 0.35) {
                        const lp = (p - 0.15) / 0.2;
                        s.n_naesu.x = window.lerp(120, 180, lp);
                        s.n_naesu.y = window.lerp(250, 450, lp); 
                    } else if (p < 0.65) {
                        const lp = (p - 0.35) / 0.3;
                        s.n_naesu.x = window.lerp(180, 460, lp);
                        s.n_naesu.y = 450;
                    } else if (p < 0.85) {
                        const lp = (p - 0.65) / 0.2;
                        s.n_naesu.x = 460;
                        s.n_naesu.y = window.lerp(450, 150, lp);
                    } else {
                        const lp = (p - 0.85) / 0.15;
                        s.n_naesu.x = window.lerp(460, 400, lp);
                        s.n_naesu.y = 150;
                    }
                }
            },
            {
                text: "5. 외수 교대",
                desc: "이전 외수가 뒤로 물러나고, 다음 외수가 문을 닫으며 들어와 앉습니다.",
                animate: (s, p) => {
                    if(p < 0.3) {
                        const lp = p / 0.3;
                        s.p_oesu.y = window.lerp(150, 350, lp);
                    } else {
                        s.p_oesu.y = 350;
                        const lp = (p - 0.3) / 0.7;
                        if(lp < 0.3) {
                            s.n_oesu.x = window.lerp(40, 120, lp/0.3);
                            s.n_oesu.y = window.lerp(150, 250, lp/0.3);
                        } else {
                            s.n_oesu.x = window.lerp(120, 200, (lp-0.3)/0.7);
                            s.n_oesu.y = window.lerp(250, 150, (lp-0.3)/0.7);
                        }
                    }
                }
            },
            {
                text: "완료: 공부 시작 / 퇴실",
                desc: "새로운 조가 자리를 잡았습니다. 이전 조는 퇴실합니다.",
                animate: (s, p) => {
                    s.p_member.alpha = 1 - p;
                    s.p_oesu.alpha = 1 - p;
                    s.p_naesu.alpha = 1 - p;
                }
            }
        ];

        window.simController = {
            initialized: false,
            stepIndex: 0,
            progress: 0,
            isPlaying: false,
            lastTime: 0,
            state: {},
            init: function() {
                this.reset();
                requestAnimationFrame((t) => this.loop(t));
            },
            reset: function() {
                this.stepIndex = 0;
                this.progress = 0;
                this.isPlaying = false;
                simSteps[0].setup(this.state);
                this.draw();
                this.updateText();
            },
            next: function() {
                if (this.stepIndex < simSteps.length - 1) {
                    if(simSteps[this.stepIndex].animate) simSteps[this.stepIndex].animate(this.state, 1.0);
                    this.stepIndex++;
                    this.progress = 0;
                    this.updateText();
                    this.draw();
                }
            },
            prev: function() {
                if (this.stepIndex > 0) {
                    this.stepIndex--;
                    this.progress = 0;
                    simSteps[0].setup(this.state);
                    for(let i=1; i<this.stepIndex; i++) {
                        if(simSteps[i].animate) simSteps[i].animate(this.state, 1.0);
                    }
                    this.updateText();
                    this.draw();
                }
            },
            play: function() {
                this.isPlaying = !this.isPlaying;
            },
            updateText: function() {
                const el = document.getElementById('step-description');
                const step = simSteps[this.stepIndex];
                el.innerHTML = `<span class="block text-sm text-theme-color font-bold mb-2 tracking-widest">STEP ${this.stepIndex}</span>${step.text}<br><span class="text-base font-normal text-stone-500 mt-1 block">${step.desc || ''}</span>`;
            },
            loop: function(timestamp) {
                const dt = timestamp - this.lastTime;
                this.lastTime = timestamp;
                if (this.isPlaying) {
                    this.progress += dt * 0.0005;
                    if (this.progress >= 1) {
                        this.progress = 1;
                        if(this.stepIndex < simSteps.length - 1) {
                            this.next();
                        } else {
                            this.isPlaying = false;
                        }
                    }
                    if(simSteps[this.stepIndex].animate) {
                        simSteps[this.stepIndex].animate(this.state, this.progress);
                    }
                    this.draw();
                }
                requestAnimationFrame((t) => this.loop(t));
            },
            draw: function() {
                if(!ctx) return;
                ctx.clearRect(0, 0, 500, 500);
                
                ctx.fillStyle = '#f5f5f4'; 
                ctx.fillRect(0, 0, 100, 500);
                
                ctx.strokeStyle = '#e7e5e4'; 
                ctx.lineWidth = 1;
                ctx.beginPath();
                for(let i=100; i<500; i+=50) {
                    ctx.moveTo(i, 0); ctx.lineTo(i, 500);
                }
                for(let i=0; i<500; i+=50) {
                    ctx.moveTo(100, i); ctx.lineTo(500, i);
                }
                ctx.stroke();
                
                ctx.strokeStyle = '#57534e';
                ctx.lineWidth = 4;
                ctx.beginPath();
                ctx.moveTo(100, 0); ctx.lineTo(100, 230);
                ctx.moveTo(100, 270); ctx.lineTo(100, 500);
                ctx.stroke();
                
                const drawBall = (obj) => {
                    if (obj.alpha === 0) return;
                    ctx.globalAlpha = obj.alpha !== undefined ? obj.alpha : 1;
                    ctx.fillStyle = obj.c;
                    ctx.beginPath();
                    ctx.arc(obj.x, obj.y, 22, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.strokeStyle = '#fff';
                    ctx.lineWidth = 3;
                    ctx.stroke();
                    ctx.fillStyle = '#fff';
                    ctx.font = 'bold 11px Noto Sans KR'; 
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    let short = obj.label.includes('회원') ? '회' : (obj.label.includes('외수') ? '외' : '내');
                    ctx.fillText(obj.label.includes('다음') ? '다음' : '기존', obj.x, obj.y - 9);
                    ctx.fillText(short, obj.x, obj.y + 7);
                    ctx.globalAlpha = 1;
                };

                drawBall(this.state.p_oesu);
                drawBall(this.state.p_member);
                drawBall(this.state.p_naesu);
                drawBall(this.state.n_member);
                drawBall(this.state.n_naesu);
                drawBall(this.state.n_oesu);
            }
        };

        // 시뮬레이터 숨김/표시 토글 로직
        window.toggleSimulator = () => {
            const simEl = document.getElementById('view-simulator');
            const btnText = document.getElementById('simulator-toggle-text');
            const iconContainer = document.getElementById('simulator-toggle-icon');

            if (simEl.classList.contains('hidden')) {
                simEl.classList.remove('hidden');
                btnText.innerText = '입실 시뮬레이터 닫기';
                iconContainer.innerHTML = '<i data-lucide="x-circle" class="w-5 h-5"></i>';
                
                // 처음 열 때만 캔버스 초기화 (버그 방지)
                if(!window.simController.initialized && ctx) {
                    window.simController.init();
                    window.simController.initialized = true;
                }
                
                // 부드럽게 스크롤 이동
                simEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else {
                simEl.classList.add('hidden');
                btnText.innerText = '입실 시뮬레이터 실행하기';
                iconContainer.innerHTML = '<i data-lucide="play-circle" class="w-5 h-5"></i>';
            }
            
            // 새 아이콘 렌더링
            lucide.createIcons();
        };

        // ==========================================
        // 기존 게시판 및 Firebase 로직
        // ==========================================
        const FIX_ORDER = ['시립', '법배', '평배', '향납읍', '좌배', '국궁', '좌우진보', '법좌', '수련방법', '점호의례', '봉심의례', '부정기휘법'];

        const YOUR_FIREBASE_CONFIG = {
            apiKey: "AIzaSyAoUdyZJQjcT81_2YKzX1rzMJlNAoHcbAw",
            authDomain: "taegeuk-rules.firebaseapp.com",
            projectId: "taegeuk-rules",
            storageBucket: "taegeuk-rules.firebasestorage.app",
            messagingSenderId: "388014641769",
            appId: "1:388014641769:web:f9fd06f30a222663b448f8"
        };

        window.isAdminMode = false;
        window.currentCategory = '전체';
        window.editingId = null;
        window.deleteTargetId = null;
        
        let localContents = [];
        let localCategories = [];
        let localCategoriesObjects = [];

        const contentListEl = document.getElementById('content-list');
        const categoryContainerEl = document.getElementById('category-container');
        const adminPanelEl = document.getElementById('admin-panel');
        const postFormEl = document.getElementById('post-form');
        const adminToggleBtn = document.getElementById('admin-toggle');
        const toggleCircle = document.getElementById('toggle-circle');
        const adminCategoryListEl = document.getElementById('admin-category-list');
        const newCategoryInput = document.getElementById('new-category-input');
        const inputCategorySelect = document.getElementById('input-category');
        const fileInput = document.getElementById('input-file');
        const imageUrlInput = document.getElementById('input-image-url');
        const submitBtn = document.getElementById('submit-btn');
        const submitBtnText = document.getElementById('submit-btn-text');
        const passwordModal = document.getElementById('password-modal');
        const passwordInput = document.getElementById('admin-password-input');
        const passwordError = document.getElementById('password-error');
        const deleteModal = document.getElementById('delete-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');

        let db, auth;
        let useFirebase = false;
        let appId = 'tgd-guide-public';

        async function initialize() {
            loadLocalData();

            try {
                let firebaseConfig;

                if (typeof __firebase_config !== 'undefined' && typeof __app_id !== 'undefined') {
                    firebaseConfig = JSON.parse(__firebase_config);
                    appId = __app_id;
                    console.log("Canvas Firebase 연결");
                } 
                else if (YOUR_FIREBASE_CONFIG && YOUR_FIREBASE_CONFIG.apiKey) {
                    firebaseConfig = YOUR_FIREBASE_CONFIG;
                    appId = 'tgd-guide-public';
                    console.log("외부 Firebase 설정 연결");
                } 
                else {
                    throw new Error("환경 설정이 없습니다. (로컬 모드 전환)");
                }

                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                useFirebase = true;

                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                };
                
                await initAuth();

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        subscribeToData();
                    }
                });

            } catch (error) {
                console.warn("Firebase 연결 실패, 오프라인 모드로 전환합니다.", error);
                useFirebase = false;
                loadLocalData();
            }

            const savedAdminState = localStorage.getItem('isAdminMode') === 'true';
            if (savedAdminState) toggleAdminState(true);
        }

        function sortCategories(cats) {
            return cats.sort((a, b) => {
                const idxA = FIX_ORDER.indexOf(a.name);
                const idxB = FIX_ORDER.indexOf(b.name);
                if (idxA !== -1 && idxB !== -1) return idxA - idxB;
                if (idxA !== -1) return -1;
                if (idxB !== -1) return 1;
                return a.name.localeCompare(b.name);
            });
        }

        let permissionErrorAlerted = false;
        function handlePermissionError() {
            if (!permissionErrorAlerted) {
                permissionErrorAlerted = true;
                alert("데이터베이스 권한 오류가 발생했습니다.\n파이어베이스 콘솔에서 설정이 만료되었는지 확인해주세요.\n\n안전을 위해 현재 내 컴퓨터에 백업된 로컬 데이터로 전환합니다.");
                useFirebase = false;
                loadLocalData();
            }
        }

        window.forceRestoreData = async () => {
            if (!useFirebase || !auth.currentUser) {
                alert("파이어베이스에 연결되어 있지 않습니다.");
                return;
            }
            
            const localPostsData = localStorage.getItem('taegeukdo_posts');
            if (!localPostsData || localPostsData === "[]") {
                alert("복구할 수 있는 백업 데이터가 없습니다.");
                return;
            }

            try {
                const posts = JSON.parse(localPostsData);
                if (posts.length === 0) return alert("복구할 게시글이 없습니다.");
                
                if(!confirm(`내 컴퓨터에 저장된 ${posts.length}개의 게시글을 파이어베이스 서버로 복구하시겠습니까?`)) return;

                const batch = writeBatch(db);
                const postsCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'posts');
                
                posts.forEach(post => {
                    const docRef = doc(postsCollectionRef); 
                    const postData = { ...post };
                    delete postData.id; 
                    batch.set(docRef, postData);
                });

                await batch.commit();
                alert("데이터 강제 복구가 완료되었습니다!");
            } catch (err) {
                console.error("복구 실패:", err);
                alert("복구 중 오류가 발생했습니다: " + err.message);
            }
        }

        function subscribeToData() {
            if (!auth || !auth.currentUser) return;

            const postsCollection = collection(db, 'artifacts', appId, 'public', 'data', 'posts');
            onSnapshot(postsCollection, (snapshot) => {
                const incoming = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                if (incoming.length === 0 && localContents.length > 0) {
                    console.warn("파이어베이스 DB가 비어있어 컴퓨터의 임시 백업을 지우지 않고 보호합니다.");
                } else {
                    localContents = incoming;
                    saveLocalData();
                }
                renderContents();
            }, (err) => {
                console.error("Firestore Listen Error (Posts):", err);
                if (err.code === 'permission-denied') handlePermissionError();
            });

            const catsCollection = collection(db, 'artifacts', appId, 'public', 'data', 'categories');
            onSnapshot(catsCollection, (snapshot) => {
                const incomingCats = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                if (incomingCats.length === 0 && localCategories.length > 0) {
                    console.warn("파이어베이스 카테고리가 비어있어 로컬 데이터를 보호합니다.");
                } else {
                    localCategoriesObjects = sortCategories(incomingCats);
                    localCategories = localCategoriesObjects.map(c => c.name);
                    saveLocalData();
                }
                renderCategories();
                renderCategorySelect();
                renderAdminCategories();
                renderContents();
            }, (err) => {
                console.error("Firestore Listen Error (Categories):", err);
                if (err.code === 'permission-denied') handlePermissionError();
            });
        }

        function loadLocalData() {
            const savedContents = localStorage.getItem('taegeukdo_posts');
            const savedCategories = localStorage.getItem('taegeukdo_categories');

            if (savedContents && savedContents !== "[]") {
                try {
                    localContents = JSON.parse(savedContents);
                } catch (e) {
                    console.error("로컬 데이터 파싱 에러:", e);
                    localContents = [];
                }
            } else {
                localContents = [];
            }

            if (savedCategories && savedCategories !== "[]") {
                try {
                    localCategories = JSON.parse(savedCategories);
                } catch (e) {
                    console.error("로컬 카테고리 파싱 에러:", e);
                    localCategories = [...FIX_ORDER];
                }
            } else {
                localCategories = [...FIX_ORDER];
            }

            renderContents();
            renderCategories();
            renderCategorySelect();
            renderAdminCategories();
        }

        function saveLocalData() {
            try {
                const postsToSave = localContents.map(post => {
                   return post; 
                });
                localStorage.setItem('taegeukdo_posts', JSON.stringify(postsToSave));
                localStorage.setItem('taegeukdo_categories', JSON.stringify(localCategories));
            } catch (error) {
                console.error("로컬 스토리지 저장 용량 초과 에러:", error);
            }
        }

        function renderCategories() {
            const displayCategories = ['전체', ...localCategories];
            categoryContainerEl.innerHTML = displayCategories.map(cat => `
                <button onclick="window.setCategory('${cat}')" 
                    class="px-5 py-2.5 rounded-full text-base font-bold border-2 transition-all ${
                        window.currentCategory === cat 
                        ? 'bg-theme-color text-white border-theme-color scale-105 shadow-md' 
                        : 'bg-white text-stone-500 border-stone-200 hover:border-theme-color hover:text-theme-color'
                    }">${cat}</button>
            `).join('');
        }

        function renderCategorySelect() {
            inputCategorySelect.innerHTML = localCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
        }

        function renderAdminCategories() {
            adminCategoryListEl.innerHTML = ['전체', ...localCategories].map(cat => `
                <div class="flex items-center gap-1 px-4 py-2 bg-stone-100 border-2 border-stone-200 rounded-full text-sm font-bold text-stone-600">
                    <span>${cat}</span>
                    ${cat !== '전체' ? `<button onclick="window.deleteCategory('${cat}')" class="ml-2 text-stone-400 hover:text-red-600"><i data-lucide="x" class="w-4 h-4"></i></button>` : ''}
                </div>
            `).join('');
            lucide.createIcons();
        }

        function renderContents() {
            contentListEl.innerHTML = '';
            let filtered = window.currentCategory === '전체' ? [...localContents] : localContents.filter(item => item.category === window.currentCategory);

            filtered.sort((a, b) => {
                if (window.currentCategory === '전체') {
                    const idxA = FIX_ORDER.indexOf(a.category);
                    const idxB = FIX_ORDER.indexOf(b.category);
                    if (idxA !== idxB) return (idxA === -1 ? 999 : idxA) - (idxB === -1 ? 999 : idxB);
                }
                return (b.createdAt || 0) - (a.createdAt || 0);
            });

            if (filtered.length === 0) {
                contentListEl.innerHTML = '<div class="py-32 text-center text-stone-400 font-bold font-serif">등록된 안내 글이 없습니다.</div>';
                return;
            }

            filtered.forEach(item => {
                const div = document.createElement('div');
                div.className = 'p-6 sm:p-8 bg-white border-2 border-stone-200 rounded-xl shadow-card transition-all group relative mb-6 hover:border-theme-color';
                
                const images = item.images || (item.image ? [item.image] : []);
                let mediaHtml = images.length > 0 ? `
                    <div class="mb-6 w-full overflow-x-auto flex gap-3 pb-2 scrollbar-thin scrollbar-thumb-stone-300">
                        ${images.map(src => `<img src="${src}" class="h-48 rounded-lg object-cover cursor-zoom-in hover:opacity-90 transition-opacity" onclick="window.openImageModal('${src}')">`).join('')}
                    </div>` : '';

                let newBadge = '';
                if (isNew(item.date)) {
                    newBadge = `<span class="inline-flex items-center justify-center px-2 py-0.5 ml-2 text-xs font-bold text-white bg-theme-color rounded-md new-badge shadow-sm">NEW</span>`;
                }

                div.innerHTML = `
                    ${mediaHtml}
                    <div class="flex items-center gap-3 mb-4">
                        <span class="text-sm font-bold text-theme-color bg-theme-color/10 px-3 py-1 rounded-full border border-theme-color/20">${item.category}</span>
                        <span class="text-sm text-stone-400 font-bold">${item.date || ''}</span>
                        ${newBadge}
                    </div>
                    <h2 class="text-2xl sm:text-3xl font-serif font-bold mb-4 text-k-text leading-snug break-keep group-hover:text-theme-color">${item.title}</h2>
                    <p class="text-stone-700 leading-loose text-base sm:text-lg font-medium whitespace-pre-line break-keep">${item.desc}</p>
                    ${window.isAdminMode ? `
                        <div class="absolute top-6 right-6 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="window.editPost('${item.id}')" class="p-2 bg-white border-2 rounded-lg text-stone-500 hover:text-theme-color"><i data-lucide="edit-2" class="w-5 h-5"></i></button>
                            <button onclick="window.openDeleteModal('${item.id}')" class="p-2 bg-white border-2 rounded-lg text-stone-500 hover:text-red-600"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                        </div>
                    ` : ''}
                `;
                contentListEl.appendChild(div);
            });
            lucide.createIcons();
        }

        window.checkPassword = async () => {
            if (passwordInput.value === "taegeuk1909#") {
                try {
                    if(!auth || !auth.currentUser) await signInAnonymously(auth);
                    toggleAdminState(true);
                    window.closePasswordModal();
                } catch (e) {
                    console.error("Auth Error:", e);
                    alert("관리자 인증 중 오류가 발생했습니다.");
                }
            } else {
                passwordError.classList.remove('opacity-0');
            }
        };

        window.addCategory = async () => {
            const name = newCategoryInput.value.trim();
            if (!name || localCategories.includes(name)) return;
            
            if (useFirebase && auth && auth.currentUser) {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'categories'), { name });
            } else {
                localCategories.push(name);
                saveLocalData();
                renderCategories();
                renderCategorySelect();
                renderAdminCategories();
            }
            newCategoryInput.value = '';
        };

        window.deleteCategory = async (name) => {
            if (name === '전체' || !confirm(`'${name}' 삭제하시겠습니까?`)) return;
            const obj = localCategoriesObjects.find(c => c.name === name);
            if (useFirebase && obj && auth && auth.currentUser) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'categories', obj.id));
            } else {
                localCategories = localCategories.filter(c => c !== name);
                if (window.currentCategory === name) window.currentCategory = '전체';
                saveLocalData();
                renderCategories();
                renderCategorySelect();
                renderAdminCategories();
                renderContents();
            }
        };

        function processFile(file) {
            return new Promise((resolve, reject) => {
                if (file.type.startsWith('video')) {
                    if (file.size > 700 * 1024) {
                        reject("동영상은 700KB 이하만 가능합니다.");
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = () => reject("동영상을 읽을 수 없습니다.");
                    reader.readAsDataURL(file);
                } else if (file.type.startsWith('image')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let width = img.width;
                            let height = img.height;
                            const MAX_DIM = 800;
                            if (width > height) {
                                if (width > MAX_DIM) {
                                    height *= MAX_DIM / width;
                                    width = MAX_DIM;
                                }
                            } else {
                                if (height > MAX_DIM) {
                                    width *= MAX_DIM / height;
                                    height = MAX_DIM;
                                }
                            }
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            resolve(canvas.toDataURL('image/jpeg', 0.5));
                        };
                        img.onerror = () => reject("아이폰 사진(HEIC)이거나 지원하지 않는 파일 형식입니다.");
                        img.src = e.target.result;
                    };
                    reader.onerror = () => reject("사진을 읽을 수 없습니다.");
                    reader.readAsDataURL(file);
                } else {
                    reject("지원하지 않는 파일 형식입니다.");
                }
            });
        }

        postFormEl.addEventListener('submit', async (e) => {
            e.preventDefault();
            const category = document.getElementById('input-category').value;
            const title = document.getElementById('input-title').value;
            const desc = document.getElementById('input-desc').value;
            const files = Array.from(fileInput.files);
            const url = imageUrlInput.value.trim();

            if (!title || !desc) return alert("제목과 내용을 입력해주세요.");

            submitBtn.disabled = true;
            submitBtnText.innerText = "사진 압축 및 저장 중...";

            try {
                let processedImages = [];
                let totalSize = 0;

                for (const f of files) {
                    const dataUrl = await processFile(f);
                    totalSize += dataUrl.length;
                    processedImages.push(dataUrl);
                }

                if (totalSize > 900000) {
                    throw new Error("사진 용량이 너무 큽니다. 사진 장수를 줄여서 다시 시도해주세요.");
                }

                if (url) processedImages.push(url);

                let finalImages = processedImages;
                let finalDate = new Date().toISOString().split('T')[0].replace(/-/g, '.');
                let finalCreatedAt = Date.now();

                if (window.editingId) {
                    const existingPost = localContents.find(p => String(p.id) === String(window.editingId));
                    if (existingPost) {
                        if (finalImages.length === 0) {
                            finalImages = existingPost.images || (existingPost.image ? [existingPost.image] : []);
                        }
                        finalDate = existingPost.date || finalDate;
                        finalCreatedAt = existingPost.createdAt || finalCreatedAt;
                    }
                }

                const postData = {
                    category, title, desc,
                    images: finalImages,
                    date: finalDate,
                    createdAt: finalCreatedAt
                };

                if (window.editingId) {
                    if (useFirebase && auth && auth.currentUser) {
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'posts', window.editingId), postData);
                    } else {
                        const idx = localContents.findIndex(p => String(p.id) === String(window.editingId));
                        if (idx !== -1) {
                            localContents[idx] = { ...postData, id: window.editingId };
                            saveLocalData(); renderContents();
                        }
                    }
                } else {
                    if (useFirebase && auth && auth.currentUser) {
                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'posts'), postData);
                    } else {
                        postData.id = Date.now();
                        localContents.unshift(postData);
                        saveLocalData(); renderContents();
                    }
                }
                
                window.resetForm();
                alert("게시글이 성공적으로 등록되었습니다!");
            } catch (err) {
                alert("업로드 실패: " + (err.message || err));
            } finally {
                submitBtn.disabled = false;
                submitBtnText.innerText = "게시글 저장하기";
            }
        });

        window.editPost = (id) => {
            const p = localContents.find(x => String(x.id) === String(id));
            if (!p) return;
            window.editingId = id;
            document.getElementById('input-category').value = p.category;
            document.getElementById('input-title').value = p.title;
            document.getElementById('input-desc').value = p.desc;
            
            const images = p.images || (p.image ? [p.image] : []);
            const previewInfo = document.getElementById('file-preview-info');
            const nameDisplay = document.getElementById('file-name-display');
            
            if (images.length > 0) {
                previewInfo.classList.remove('hidden');
                nameDisplay.innerText = `기존 파일 ${images.length}개가 유지됩니다.`;
            } else {
                previewInfo.classList.add('hidden');
            }
            adminPanelEl.scrollIntoView({ behavior: 'smooth' });
        };

        window.openDeleteModal = (id) => { window.deleteTargetId = id; deleteModal.classList.remove('hidden'); };
        window.closeDeleteModal = () => deleteModal.classList.add('hidden');
        confirmDeleteBtn.addEventListener('click', async () => {
            if (window.deleteTargetId) {
                if (useFirebase && auth && auth.currentUser) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'posts', window.deleteTargetId));
                } else {
                    localContents = localContents.filter(p => String(p.id) !== String(window.deleteTargetId));
                    saveLocalData(); renderContents(); 
                }
                window.closeDeleteModal();
            }
        });

        window.setCategory = (c) => { window.currentCategory = c; renderCategories(); renderContents(); };
        window.resetForm = () => { 
            window.editingId = null; 
            postFormEl.reset(); 
            document.getElementById('file-preview-info').classList.add('hidden');
        };
        window.closePasswordModal = () => passwordModal.classList.add('hidden');
        
        window.openImageModal = (s) => { 
            const m = document.getElementById('image-modal');
            const i = document.getElementById('modal-image');
            m.classList.remove('hidden'); i.src = s;
            setTimeout(() => { i.classList.remove('scale-95', 'opacity-0'); i.classList.add('scale-100', 'opacity-100'); }, 10);
        };
        window.closeImageModal = () => {
            const i = document.getElementById('modal-image');
            i.classList.replace('scale-100', 'scale-95');
            i.classList.replace('opacity-100', 'opacity-0');
            setTimeout(() => document.getElementById('image-modal').classList.add('hidden'), 300);
        };

        fileInput.addEventListener('change', () => {
            const count = fileInput.files.length;
            const previewInfo = document.getElementById('file-preview-info');
            const nameDisplay = document.getElementById('file-name-display');
            if (count > 0) {
                previewInfo.classList.remove('hidden');
                nameDisplay.innerText = `${count}개의 사진 선택됨`;
            } else {
                if (!window.editingId) previewInfo.classList.add('hidden');
            }
        });

        function toggleAdminState(enable) {
            window.isAdminMode = enable;
            localStorage.setItem('isAdminMode', enable);
            if (enable) {
                adminToggleBtn.classList.replace('bg-stone-300', 'bg-theme-color');
                toggleCircle.classList.replace('translate-x-1', 'translate-x-5');
                adminPanelEl.classList.remove('hidden');
            } else {
                adminToggleBtn.classList.replace('bg-theme-color', 'bg-stone-300');
                toggleCircle.classList.replace('translate-x-5', 'translate-x-1');
                adminPanelEl.classList.add('hidden');
            }
            renderContents();
        }

        adminToggleBtn.addEventListener('click', () => {
            if (window.isAdminMode) toggleAdminState(false);
            else passwordModal.classList.remove('hidden');
        });

        // 앱 시작
        initialize();
        lucide.createIcons();
    </script>
</body>
</html>
