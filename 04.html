<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>태극도 법식 안내</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=Noto+Serif+KR:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bg: '#fdfbf7',       // 기본 미색 배경
                        dot: '#e6e2d3',      // 패턴 점 색상
                        ink: '#2c2c2c',      // 짙은 먹색
                        bean: '#8b3a3a',     // 팥색 (포인트)
                        stone: {
                            50: '#fafaf9',
                            100: '#f5f5f4',
                            200: '#e7e5e4',
                            300: '#d6d3d1',
                            400: '#a8a29e',
                            500: '#78716c',
                            600: '#57534e',
                            700: '#44403c',
                            800: '#292524',
                            900: '#1c1917',
                        }
                    },
                    fontFamily: {
                        serif: ['"Noto Serif KR"', 'serif'],
                        sans: ['"Noto Sans KR"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        /* 배경 한지 패턴 설정 */
        body {
            background-color: #fdfbf7;
            background-image: radial-gradient(#e6e2d3 1px, transparent 1px);
            background-size: 24px 24px;
        }

        /* 스크롤바 커스터마이징 */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #d6d3d1;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a29e;
        }

        /* 텍스트 드래그 색상 */
        ::selection {
            background-color: #8b3a3a;
            color: #ffffff;
        }
        
        /* 로딩 인디케이터 */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #8b3a3a;
            width: 24px;
            height: 24px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-ink font-sans min-h-screen flex flex-col items-center py-8 px-4 sm:px-6">

    <!-- 메인 컨테이너 -->
    <main class="w-full max-w-3xl bg-white/60 backdrop-blur-sm border border-stone-200 shadow-sm rounded-lg overflow-hidden relative transition-all duration-500">
        
        <!-- 홈 버튼 (우측 상단 고정) -->
        <a href="index.html" class="absolute top-6 right-6 sm:top-8 sm:right-8 z-20 flex items-center gap-2 text-stone-600 hover:text-stone-900 transition-colors duration-300 group">
            <i data-lucide="home" class="w-5 h-5"></i>
            <span class="hidden sm:inline font-serif text-sm font-medium pt-0.5 group-hover:underline decoration-bean underline-offset-4 decoration-1">홈으로</span>
        </a>

        <!-- 헤더 영역 -->
        <header class="pt-12 pb-8 px-6 sm:px-10 border-b border-stone-200/60 text-center sm:text-left">
            <span class="inline-block px-3 py-1 mb-3 text-xs font-serif text-bean border border-bean/30 rounded-full bg-red-50/50">
                초심 공부자를 위한 안내
            </span>
            <h1 class="text-3xl sm:text-4xl font-serif font-bold tracking-tight leading-relaxed mb-2">
                태극도 법식(法式)
            </h1>
            <p class="text-stone-600 font-light text-sm sm:text-base break-keep">
                국궁, 배례, 봉심, 강식 등 도인으로서 갖추어야 할 기본 예법을 안내합니다.
            </p>
        </header>

        <!-- 탭 네비게이션 -->
        <nav class="sticky top-0 z-10 bg-white/80 backdrop-blur-md border-b border-stone-200 px-4 sm:px-8 py-3 overflow-x-auto">
            <div class="flex gap-2 min-w-max sm:justify-start" id="category-container">
                <!-- 자바스크립트로 버튼이 생성됩니다 -->
                <div class="px-4 py-2 text-stone-400 text-sm">카테고리 로딩중...</div>
            </div>
        </nav>

        <!-- 컨텐츠 리스트 영역 -->
        <section id="content-list" class="divide-y divide-stone-100 min-h-[400px]">
            <!-- 자바스크립트로 카드가 생성됩니다 -->
            <div class="py-20 text-center flex flex-col items-center justify-center">
                <div class="loader mb-4"></div>
                <p class="text-stone-500 font-serif">데이터를 불러오고 있습니다...</p>
            </div>
        </section>

        <!-- 관리자 패널 (숨김 상태) -->
        <section id="admin-panel" class="hidden border-t-2 border-bean bg-stone-50 p-6 sm:p-8">
            <div class="flex items-center justify-between mb-6">
                <h3 class="font-serif text-xl font-bold text-ink flex items-center gap-2">
                    <i data-lucide="settings" class="w-5 h-5 text-bean"></i> 관리자 패널
                </h3>
                <button onclick="window.resetForm()" class="text-xs text-stone-500 hover:text-bean underline">입력 초기화</button>
            </div>

            <!-- 카테고리 관리 섹션 -->
            <div class="mb-8 p-5 bg-white rounded-lg border border-stone-200 shadow-sm">
                <label class="block text-xs font-bold text-stone-500 mb-3 flex items-center gap-1">
                    <i data-lucide="tags" class="w-3 h-3"></i> 카테고리 관리
                </label>
                <div class="flex flex-wrap gap-2 mb-4" id="admin-category-list">
                    <!-- 카테고리 태그들이 여기에 생성됩니다 -->
                </div>
                <div class="flex gap-2">
                    <input type="text" id="new-category-input" placeholder="새 카테고리 추가" 
                        class="flex-1 bg-stone-50 border border-stone-200 rounded p-2 text-sm focus:outline-none focus:border-bean focus:ring-1 focus:ring-bean transition-all"
                        onkeypress="if(event.key === 'Enter') window.addCategory()">
                    <button onclick="window.addCategory()" class="px-4 py-2 bg-stone-600 text-white rounded hover:bg-stone-700 text-sm font-medium transition-colors whitespace-nowrap">
                        추가
                    </button>
                </div>
            </div>
            
            <!-- 글쓰기 폼 -->
            <form id="post-form" class="space-y-4">
                <input type="hidden" id="edit-mode-id" value="">
                
                <div class="grid grid-cols-1 sm:grid-cols-4 gap-4">
                    <div class="sm:col-span-1">
                        <label class="block text-xs font-bold text-stone-500 mb-1">카테고리 선택</label>
                        <select id="input-category" class="w-full bg-white border border-stone-300 rounded p-2 text-sm focus:outline-none focus:border-bean focus:ring-1 focus:ring-bean cursor-pointer">
                            <!-- JS로 동적 생성 -->
                        </select>
                    </div>
                    <div class="sm:col-span-3">
                        <label class="block text-xs font-bold text-stone-500 mb-1">제목</label>
                        <input type="text" id="input-title" placeholder="제목을 입력하세요 (예: 국궁의 의미)" class="w-full bg-white border border-stone-300 rounded p-2 text-sm focus:outline-none focus:border-bean focus:ring-1 focus:ring-bean font-serif">
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-stone-500 mb-1">내용</label>
                    <textarea id="input-desc" rows="5" placeholder="상세 내용을 입력하세요." class="w-full bg-white border border-stone-300 rounded p-2 text-sm focus:outline-none focus:border-bean focus:ring-1 focus:ring-bean"></textarea>
                </div>

                <div>
                    <label class="block text-xs font-bold text-stone-500 mb-1">사진/영상 첨부</label>
                    <input type="file" id="input-file" accept="image/*,video/*" class="w-full bg-white border border-stone-300 rounded p-2 text-sm focus:outline-none focus:border-bean focus:ring-1 focus:ring-bean file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-stone-100 file:text-stone-700 hover:file:bg-stone-200 cursor-pointer">
                    <div id="file-preview-info" class="mt-2 text-xs text-bean font-medium hidden">
                        <i class="fa-solid fa-check mr-1"></i><span id="file-name-display"></span>
                    </div>
                    <p class="text-[10px] text-stone-400 mt-1">
                        * <span class="font-bold text-bean">사진</span>: 고화질 사진은 자동으로 압축되어 업로드됩니다.<br>
                        * <span class="font-bold text-bean">동영상</span>: 용량이 크므로 YouTube 등에 올린 후 URL을 '이미지/영상 URL' 칸에 입력하는 것을 권장합니다. (직접 업로드는 700KB 이하만 가능)
                    </p>
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-stone-500 mb-1">이미지/영상 URL (선택)</label>
                    <input type="text" id="input-image-url" placeholder="https://..." class="w-full bg-white border border-stone-300 rounded p-2 text-sm focus:outline-none focus:border-bean focus:ring-1 focus:ring-bean">
                    <p class="text-[10px] text-stone-400 mt-1">* YouTube 링크나 외부 이미지 주소가 있다면 여기에 입력하세요.</p>
                </div>

                <div class="pt-2">
                    <button type="submit" id="submit-btn" class="w-full sm:w-auto px-6 py-2 bg-bean text-white rounded hover:bg-[#6d2b2b] transition-colors text-sm font-medium shadow-sm flex items-center justify-center gap-2">
                        <i data-lucide="pen-line" class="w-4 h-4"></i>
                        <span id="submit-btn-text">게시글 등록하기</span>
                    </button>
                </div>
            </form>
        </section>

    </main>

    <!-- 푸터 -->
    <footer class="mt-8 text-center text-stone-400 text-xs font-light">
        <p class="font-serif">Taegeukdo Guide for Beginners</p>
        <p class="mt-1">&copy; 2024 태극도 법식 안내. All rights reserved.</p>
    </footer>

    <!-- 관리자 모드 토글 스위치 -->
    <div class="fixed bottom-6 right-6 z-50 flex items-center gap-2 bg-white pl-4 pr-2 py-2 rounded-full shadow-lg border border-stone-200">
        <span class="text-xs font-bold text-stone-600">관리자 모드</span>
        <button id="admin-toggle" class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none bg-stone-300 hover:bg-stone-400">
            <span class="sr-only">관리자 모드 활성화</span>
            <span id="toggle-circle" class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform translate-x-1"></span>
        </button>
    </div>

    <!-- 커스텀 모달 (비밀번호 확인) -->
    <div id="password-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/40 backdrop-blur-[2px] transition-opacity duration-300">
        <div class="bg-white p-6 rounded-lg shadow-xl w-80 max-w-[90%] border border-stone-200 animate-in fade-in zoom-in duration-200">
            <h3 class="font-serif font-bold text-lg mb-2 text-ink flex items-center gap-2">
                <i data-lucide="lock" class="w-4 h-4 text-bean"></i> 관리자 인증
            </h3>
            <p class="text-xs text-stone-500 mb-4">관리자 비밀번호를 입력해주세요.</p>
            
            <input type="password" id="admin-password-input" 
                class="w-full p-2.5 bg-stone-50 border border-stone-200 rounded text-sm mb-2 focus:outline-none focus:border-bean focus:ring-1 focus:ring-bean transition-all" 
                placeholder="비밀번호" 
                onkeypress="if(event.key === 'Enter') window.checkPassword()">
            
            <p id="password-error" class="text-xs text-red-500 mb-4 h-4 opacity-0 transition-opacity">
                <i class="fa-solid fa-circle-exclamation mr-1"></i>비밀번호가 올바르지 않습니다.
            </p>
            
            <div class="flex justify-end gap-2">
                <button onclick="window.closePasswordModal()" class="px-3 py-1.5 text-xs font-medium text-stone-500 hover:bg-stone-100 rounded transition-colors">취소</button>
                <button onclick="window.checkPassword()" class="px-4 py-1.5 text-xs font-medium bg-bean text-white rounded hover:bg-[#6d2b2b] shadow-sm transition-colors">확인</button>
            </div>
        </div>
    </div>

    <!-- 커스텀 모달 (삭제 확인) -->
    <div id="delete-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/40 backdrop-blur-[2px]">
        <div class="bg-white p-6 rounded-lg shadow-xl w-80 max-w-[90%] border border-stone-200 animate-in fade-in zoom-in duration-200">
            <h3 class="font-serif font-bold text-lg mb-2 text-ink">게시글 삭제</h3>
            <p class="text-sm text-stone-600 mb-6">정말로 이 게시글을 삭제하시겠습니까?<br>삭제 후에는 복구할 수 없습니다.</p>
            <div class="flex justify-end gap-2">
                <button onclick="window.closeDeleteModal()" class="px-3 py-1.5 text-xs font-medium text-stone-500 hover:bg-stone-100 rounded transition-colors">취소</button>
                <button id="confirm-delete-btn" class="px-4 py-1.5 text-xs font-medium bg-red-600 text-white rounded hover:bg-red-700 shadow-sm transition-colors">삭제하기</button>
            </div>
        </div>
    </div>

    <!-- 파이어베이스 및 앱 로직 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ==========================================================================
        // [중요] 깃허브 페이지(외부 배포)에서 실시간 공유를 하려면 아래 설정을 채워주세요.
        // 파이어베이스 콘솔(https://console.firebase.google.com)에서 프로젝트 생성 후
        // '웹 앱'을 추가하면 나오는 설정값(apiKey, projectId 등)을 여기에 붙여넣으면 됩니다.
        // ==========================================================================
        const YOUR_FIREBASE_CONFIG = {
            apiKey: "",
            authDomain: "",
            projectId: "",
            storageBucket: "",
            messagingSenderId: "",
            appId: ""
        };
        // ==========================================================================


        // --- 전역 변수 설정 (window 객체에 할당하여 HTML onclick 등에서 접근 가능하게 함) ---
        window.isAdminMode = false;
        window.currentCategory = '전체';
        window.editingId = null;
        window.deleteTargetId = null;
        
        let localContents = [];
        let localCategories = [];

        // DOM 요소 가져오기
        const contentListEl = document.getElementById('content-list');
        const categoryContainerEl = document.getElementById('category-container');
        const adminPanelEl = document.getElementById('admin-panel');
        const postFormEl = document.getElementById('post-form');
        const adminToggleBtn = document.getElementById('admin-toggle');
        const toggleCircle = document.getElementById('toggle-circle');
        const adminCategoryListEl = document.getElementById('admin-category-list');
        const newCategoryInput = document.getElementById('new-category-input');
        const inputCategorySelect = document.getElementById('input-category');
        const fileInput = document.getElementById('input-file');
        const imageUrlInput = document.getElementById('input-image-url');
        const submitBtn = document.getElementById('submit-btn');
        const submitBtnText = document.getElementById('submit-btn-text');
        
        const passwordModal = document.getElementById('password-modal');
        const passwordInput = document.getElementById('admin-password-input');
        const passwordError = document.getElementById('password-error');
        const deleteModal = document.getElementById('delete-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');

        // --- Firebase 초기화 및 폴백 로직 ---
        let db, auth;
        let useFirebase = false;
        let appId = 'default-app-id';

        // 기본 데이터 (로컬 모드용)
        const defaultContents = [
            {
                id: 1,
                category: '국궁',
                title: '국궁(鞠躬)의 기본 자세',
                desc: '국궁은 몸을 굽혀 존경을 표하는 동작입니다. 두 손을 공수(拱手)하고 허리를 15도 가량 굽히며, 시선은 자신의 발끝 전방 1~2미터 지점을 향합니다. 이때 마음을 차분히 가라앉히고 공경하는 마음을 담는 것이 중요합니다.',
                image: 'https://images.unsplash.com/photo-1518330666324-4286280b3328?auto=format&fit=crop&q=80&w=800', 
                date: '2023.10.15'
            },
            {
                id: 2,
                category: '배례',
                title: '배례(拜禮) 행하는 법',
                desc: '배례는 상제님께 올리는 가장 큰 경의의 표시입니다. 국궁 자세에서 시작하여 무릎을 꿇고 엎드려 절을 올립니다. 손의 위치와 일어나는 순서가 중요하며, 처음 공부하시는 분들은 무릎에 무리가 가지 않도록 천천히 연습하시기 바랍니다.',
                image: '', 
                date: '2023.10.16'
            },
            {
                id: 3,
                category: '봉심',
                title: '봉심(奉審)의 마음가짐',
                desc: '봉심은 성전을 살피고 받드는 의식입니다. 정해진 시간에 의관을 정제하고 엄숙한 마음으로 행해야 합니다. 단순히 건물을 둘러보는 것이 아니라, 도(道)와 하나 되는 경건한 마음가짐이 핵심입니다.',
                image: 'https://images.unsplash.com/photo-1598556885318-48b495922312?auto=format&fit=crop&q=80&w=800',
                date: '2023.10.20'
            },
            {
                id: 4,
                category: '강식',
                title: '강식(講式) 참여 예절',
                desc: '강식은 진리를 공부하고 토론하는 시간입니다. 경청하는 자세를 유지하며, 질문이나 발언 시에는 예의를 갖추어야 합니다. 복장은 단정해야 하며, 강의 시작 10분 전에는 착석하여 마음을 정돈합니다.',
                image: '',
                date: '2023.11.01'
            }
        ];
        const defaultCategories = ['국궁', '배례', '봉심', '강식'];

        async function initialize() {
            try {
                let firebaseConfig;

                // 1. Canvas 내부 환경 (자동 연결)
                if (typeof __firebase_config !== 'undefined' && typeof __app_id !== 'undefined') {
                    firebaseConfig = JSON.parse(__firebase_config);
                    appId = __app_id;
                    console.log("Canvas Firebase 연결");
                } 
                // 2. 외부 배포 환경 (수동 설정 연결)
                else if (YOUR_FIREBASE_CONFIG && YOUR_FIREBASE_CONFIG.apiKey) {
                    firebaseConfig = YOUR_FIREBASE_CONFIG;
                    appId = 'tgd-guide-public'; // 공용 경로 ID
                    console.log("외부 Firebase 설정 연결");
                } 
                else {
                    throw new Error("환경 설정이 없습니다. (로컬 모드 전환)");
                }

                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                useFirebase = true;

                // 인증 처리
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                
                subscribeToData();

            } catch (error) {
                console.warn("Firebase 연결 안 됨: 로컬 저장소 모드 사용", error);
                useFirebase = false;
                loadLocalData();
            }
        }

        // --- 데이터 로딩 로직 (분기 처리) ---

        // 1. Firebase 사용 시 (Canvas 환경)
        function subscribeToData() {
            // 게시글 구독
            const postsCollection = collection(db, 'artifacts', appId, 'public', 'data', 'posts');
            onSnapshot(postsCollection, (snapshot) => {
                localContents = [];
                snapshot.forEach((doc) => {
                    localContents.push({ id: doc.id, ...doc.data() });
                });
                localContents.sort((a, b) => {
                    if(a.createdAt && b.createdAt) return b.createdAt - a.createdAt;
                    return 0;
                });
                renderContents();
            });

            // 카테고리 구독
            const catsCollection = collection(db, 'artifacts', appId, 'public', 'data', 'categories');
            onSnapshot(catsCollection, (snapshot) => {
                let cats = [];
                snapshot.forEach((doc) => {
                    cats.push({ id: doc.id, ...doc.data() });
                });
                cats.sort((a, b) => a.name.localeCompare(b.name));
                localCategories = cats.map(c => c.name);
                renderCategories();
                renderCategorySelect();
                renderAdminCategories();
            });
        }

        // 2. LocalStorage 사용 시 (외부 배포 환경 - 설정 없을 때)
        function loadLocalData() {
            const savedContents = localStorage.getItem('taegeukdo_posts');
            const savedCategories = localStorage.getItem('taegeukdo_categories');

            if (savedContents) {
                localContents = JSON.parse(savedContents);
            } else {
                localContents = JSON.parse(JSON.stringify(defaultContents));
            }

            if (savedCategories) {
                localCategories = JSON.parse(savedCategories);
            } else {
                localCategories = [...defaultCategories];
            }

            renderContents();
            renderCategories();
            renderCategorySelect();
            renderAdminCategories();
        }

        function saveLocalData() {
            localStorage.setItem('taegeukdo_posts', JSON.stringify(localContents));
            localStorage.setItem('taegeukdo_categories', JSON.stringify(localCategories));
        }

        // --- 렌더링 함수들 ---
        function renderCategories() {
            const displayCategories = ['전체', ...localCategories];
            categoryContainerEl.innerHTML = displayCategories.map(cat => `
                <button onclick="window.setCategory('${cat}')" 
                    class="px-4 py-1.5 rounded-full text-sm font-medium transition-all duration-300 border ${
                        window.currentCategory === cat 
                        ? 'bg-ink text-white border-ink shadow-md' 
                        : 'bg-white text-stone-500 border-stone-200 hover:border-stone-400 hover:text-stone-700'
                    }">
                    ${cat}
                </button>
            `).join('');
        }

        function renderCategorySelect() {
            inputCategorySelect.innerHTML = localCategories.map(cat => 
                `<option value="${cat}">${cat}</option>`
            ).join('');
            if(localCategories.length === 0) {
                 inputCategorySelect.innerHTML = `<option value="" disabled selected>카테고리를 추가해주세요</option>`;
            }
        }

        function renderAdminCategories() {
            const displayCategories = ['전체', ...localCategories];
            adminCategoryListEl.innerHTML = displayCategories.map(cat => {
                const isAll = cat === '전체';
                return `
                <div class="flex items-center gap-1 px-3 py-1 bg-stone-100 border border-stone-200 rounded-full text-xs text-stone-600">
                    <span>${cat}</span>
                    ${!isAll ? `
                    <button onclick="window.deleteCategory('${cat}')" class="ml-1 text-stone-400 hover:text-red-500 p-0.5 rounded-full hover:bg-stone-200 transition-colors">
                        <i data-lucide="x" class="w-3 h-3"></i>
                    </button>
                    ` : ''}
                </div>
            `}).join('');
            lucide.createIcons();
        }

        function renderContents() {
            contentListEl.innerHTML = '';
            const filtered = window.currentCategory === '전체' 
                ? localContents 
                : localContents.filter(item => item.category === window.currentCategory);

            if (filtered.length === 0) {
                contentListEl.innerHTML = `
                    <div class="py-20 text-center">
                        <i data-lucide="scroll" class="w-12 h-12 text-stone-300 mx-auto mb-3"></i>
                        <p class="text-stone-500 font-serif">등록된 안내글이 없습니다.</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            filtered.forEach(item => {
                const div = document.createElement('div');
                div.className = 'p-6 sm:p-8 hover:bg-stone-50/50 transition-colors group relative border-b border-stone-100 last:border-0';
                
                let mediaHtml = '';
                if (item.image) {
                    if (item.image.startsWith('data:video')) {
                        mediaHtml = `
                            <div class="mt-4 rounded-lg overflow-hidden shadow-sm w-full bg-black">
                                <video src="${item.image}" controls class="w-full max-h-[400px] mx-auto"></video>
                            </div>`;
                    } else if (item.image.includes('youtube.com') || item.image.includes('youtu.be')) {
                        let embedUrl = item.image;
                        if (item.image.includes('watch?v=')) {
                            const vId = item.image.split('watch?v=')[1].split('&')[0];
                            embedUrl = `https://www.youtube.com/embed/${vId}`;
                        } else if (item.image.includes('youtu.be/')) {
                            const vId = item.image.split('youtu.be/')[1].split('?')[0];
                            embedUrl = `https://www.youtube.com/embed/${vId}`;
                        }
                        
                        mediaHtml = `
                            <div class="mt-4 aspect-video rounded overflow-hidden bg-black/5 shadow-inner">
                                <iframe src="${embedUrl}" class="w-full h-full" frameborder="0" allowfullscreen></iframe>
                            </div>`;
                    } else {
                        mediaHtml = `
                            <div class="mt-4 rounded-lg overflow-hidden shadow-sm max-h-[500px] w-full bg-stone-100 flex justify-center">
                                <img src="${item.image}" alt="${item.title}" class="max-w-full max-h-[500px] object-contain">
                            </div>`;
                    }
                }

                const adminButtons = window.isAdminMode ? `
                    <div class="absolute top-6 right-6 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="window.editPost('${item.id}')" class="p-1.5 bg-white border border-stone-200 rounded text-stone-500 hover:text-bean hover:border-bean shadow-sm">
                            <i data-lucide="edit-2" class="w-4 h-4"></i>
                        </button>
                        <button onclick="window.openDeleteModal('${item.id}')" class="p-1.5 bg-white border border-stone-200 rounded text-stone-500 hover:text-red-600 hover:border-red-600 shadow-sm">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                ` : '';

                div.innerHTML = `
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-xs font-bold text-bean bg-red-50 px-2 py-0.5 rounded border border-red-100">${item.category}</span>
                        <span class="text-xs text-stone-400">${item.date || ''}</span>
                    </div>
                    <h2 class="text-2xl font-serif font-bold mb-3 text-ink leading-tight group-hover:text-bean transition-colors duration-300 cursor-pointer" onclick="window.editPost('${item.id}')">${item.title}</h2>
                    <p class="text-stone-600 leading-relaxed text-sm sm:text-base whitespace-pre-line">${item.desc}</p>
                    ${mediaHtml}
                    ${adminButtons}
                `;
                contentListEl.appendChild(div);
            });
            lucide.createIcons();
        }

        // --- 파일 처리 및 압축 로직 ---
        function processFile(file) {
            return new Promise((resolve, reject) => {
                if (file.type.startsWith('video')) {
                    if (file.size > 700 * 1024) {
                        reject("동영상 파일은 700KB 이하여야 합니다.");
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = (e) => reject("파일 읽기 실패");
                    reader.readAsDataURL(file);
                } else if (file.type.startsWith('image')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let width = img.width;
                            let height = img.height;
                            const MAX_DIM = 1200;
                            if (width > height) {
                                if (width > MAX_DIM) {
                                    height *= MAX_DIM / width;
                                    width = MAX_DIM;
                                }
                            } else {
                                if (height > MAX_DIM) {
                                    width *= MAX_DIM / height;
                                    height = MAX_DIM;
                                }
                            }
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            let dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                            if (dataUrl.length > 800000) {
                                dataUrl = canvas.toDataURL('image/jpeg', 0.5);
                            }
                            resolve(dataUrl);
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                } else {
                    reject("지원하지 않는 파일 형식입니다.");
                }
            });
        }

        // --- 사용자 액션 (통합) ---
        window.setCategory = (cat) => {
            window.currentCategory = cat;
            renderCategories();
            renderContents();
        };

        window.addCategory = async () => {
            const newCat = newCategoryInput.value.trim();
            if (!newCat) {
                alert('카테고리 이름을 입력해주세요.');
                return;
            }
            if (localCategories.includes(newCat)) {
                alert('이미 존재하는 카테고리입니다.');
                return;
            }

            if (useFirebase) {
                try {
                    const catsCollection = collection(db, 'artifacts', appId, 'public', 'data', 'categories');
                    await addDoc(catsCollection, { name: newCat });
                } catch (e) {
                    console.error(e);
                    alert("추가 실패: " + e.message);
                    return;
                }
            } else {
                localCategories.push(newCat);
                saveLocalData();
                renderCategories();
                renderCategorySelect();
                renderAdminCategories();
            }
            newCategoryInput.value = '';
        };

        window.deleteCategory = async (catName) => {
            if (catName === '전체') return;
            if (!confirm(`'${catName}' 카테고리를 삭제하시겠습니까?`)) return;
            
            if (useFirebase) {
                alert("Firebase 모드에서 카테고리 삭제는 현재 지원하지 않습니다.");
            } else {
                localCategories = localCategories.filter(c => c !== catName);
                if (window.currentCategory === catName) {
                    window.currentCategory = '전체';
                    renderContents();
                }
                saveLocalData();
                renderCategories();
                renderCategorySelect();
                renderAdminCategories();
            }
        };

        window.openDeleteModal = (id) => {
            window.deleteTargetId = id;
            deleteModal.classList.remove('hidden');
        };

        window.closeDeleteModal = () => {
            window.deleteTargetId = null;
            deleteModal.classList.add('hidden');
        };

        confirmDeleteBtn.addEventListener('click', async () => {
            if (window.deleteTargetId) {
                if (useFirebase) {
                    try {
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'posts', window.deleteTargetId));
                        window.closeDeleteModal();
                    } catch (e) {
                        console.error(e);
                        alert("삭제 실패: " + e.message);
                    }
                } else {
                    localContents = localContents.filter(p => p.id !== window.deleteTargetId);
                    saveLocalData();
                    renderContents();
                    window.closeDeleteModal();
                }
            }
        });

        window.editPost = (id) => {
            if (!window.isAdminMode) return;
            // id가 숫자(로컬)일수도 있고 문자열(Firebase)일수도 있음. 비교 시 주의.
            const post = localContents.find(p => String(p.id) === String(id));
            if (!post) return;

            window.editingId = id;
            document.getElementById('edit-mode-id').value = id;
            document.getElementById('input-category').value = post.category;
            document.getElementById('input-title').value = post.title;
            document.getElementById('input-desc').value = post.desc;
            
            if (post.image && !post.image.startsWith('data:')) {
                imageUrlInput.value = post.image;
            } else {
                imageUrlInput.value = '';
            }
            
            const previewInfo = document.getElementById('file-preview-info');
            const nameDisplay = document.getElementById('file-name-display');
            if (post.image) {
                previewInfo.classList.remove('hidden');
                nameDisplay.innerText = "기존 첨부 파일/URL이 유지됩니다.";
            } else {
                previewInfo.classList.add('hidden');
            }
            
            fileInput.value = '';
            submitBtnText.innerText = '게시글 수정하기';
            adminPanelEl.scrollIntoView({ behavior: 'smooth' });
        };

        window.resetForm = () => {
            window.editingId = null;
            document.getElementById('edit-mode-id').value = '';
            document.getElementById('post-form').reset();
            document.getElementById('file-preview-info').classList.add('hidden');
            submitBtnText.innerText = '게시글 등록하기';
        };

        // --- 관리자 토글 ---
        adminToggleBtn.addEventListener('click', () => {
            if (window.isAdminMode) {
                toggleAdminState(false);
            } else {
                passwordModal.classList.remove('hidden');
                passwordInput.value = '';
                passwordError.classList.add('opacity-0');
                setTimeout(() => passwordInput.focus(), 100);
            }
        });

        window.checkPassword = () => {
            if (passwordInput.value === "taegeuk1909#") {
                toggleAdminState(true);
                window.closePasswordModal();
            } else {
                passwordError.classList.remove('opacity-0');
                passwordInput.classList.add('border-red-500', 'ring-1', 'ring-red-500');
            }
        };

        window.closePasswordModal = () => {
            passwordModal.classList.add('hidden');
            passwordInput.value = '';
            passwordInput.classList.remove('border-red-500', 'ring-1', 'ring-red-500');
        };

        function toggleAdminState(enable) {
            window.isAdminMode = enable;
            if (enable) {
                adminToggleBtn.classList.remove('bg-stone-300');
                adminToggleBtn.classList.add('bg-bean');
                toggleCircle.classList.add('translate-x-6');
                toggleCircle.classList.remove('translate-x-1');
                adminPanelEl.classList.remove('hidden');
                setTimeout(() => adminPanelEl.scrollIntoView({ behavior: 'smooth' }), 100);
            } else {
                adminToggleBtn.classList.add('bg-stone-300');
                adminToggleBtn.classList.remove('bg-bean');
                toggleCircle.classList.remove('translate-x-6');
                toggleCircle.classList.add('translate-x-1');
                adminPanelEl.classList.add('hidden');
                window.resetForm();
            }
            renderContents();
        }

        // --- 저장 로직 ---
        postFormEl.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const category = document.getElementById('input-category').value;
            const title = document.getElementById('input-title').value;
            const desc = document.getElementById('input-desc').value;
            const file = fileInput.files[0];
            const urlInput = imageUrlInput.value.trim();
            
            if (!title || !desc) {
                alert('제목과 내용을 입력해주세요.');
                return;
            }

            const originalBtnText = submitBtnText.innerText;
            submitBtnText.innerText = "처리 중...";
            submitBtn.disabled = true;
            submitBtn.classList.add('opacity-70');

            const today = new Date().toISOString().split('T')[0].replace(/-/g, '.');

            const executeSave = async (mediaUrl) => {
                try {
                    if (!file && urlInput) {
                        mediaUrl = urlInput;
                    }

                    const newData = {
                        category,
                        title,
                        desc,
                        image: mediaUrl || '',
                        date: today,
                        createdAt: Date.now()
                    };

                    if (window.editingId) {
                        // 수정
                        if (useFirebase) {
                            const postRef = doc(db, 'artifacts', appId, 'public', 'data', 'posts', window.editingId);
                            const updateData = { category, title, desc };
                            if (mediaUrl !== null) updateData.image = mediaUrl;
                            else if (urlInput) updateData.image = urlInput;
                            await updateDoc(postRef, updateData);
                        } else {
                            const idx = localContents.findIndex(p => String(p.id) === String(window.editingId));
                            if (idx !== -1) {
                                localContents[idx] = { 
                                    ...localContents[idx], 
                                    ...newData,
                                    image: mediaUrl !== null ? mediaUrl : (urlInput || localContents[idx].image),
                                    id: localContents[idx].id // ID 유지
                                };
                                saveLocalData();
                                renderContents();
                            }
                        }
                        alert("수정되었습니다.");
                    } else {
                        // 신규
                        if (useFirebase) {
                            const postsCollection = collection(db, 'artifacts', appId, 'public', 'data', 'posts');
                            await addDoc(postsCollection, newData);
                        } else {
                            newData.id = Date.now(); // 로컬 ID
                            localContents.unshift(newData);
                            saveLocalData();
                            renderContents();
                        }
                        alert("등록되었습니다.");
                    }
                    window.resetForm();
                } catch (error) {
                    console.error("Save Error:", error);
                    alert("저장 중 오류가 발생했습니다: " + error.message);
                } finally {
                    submitBtnText.innerText = originalBtnText;
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('opacity-70');
                }
            };

            if (file) {
                try {
                    const compressedDataUrl = await processFile(file);
                    executeSave(compressedDataUrl);
                } catch (error) {
                    alert(error);
                    submitBtnText.innerText = originalBtnText;
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('opacity-70');
                }
            } else {
                executeSave(window.editingId ? null : (urlInput || ''));
            }
        });

        // 시작
        initialize();
        lucide.createIcons();

    </script>
</body>
</html>
