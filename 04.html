<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>태극도 법식 안내</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Noto+Serif+KR:wght@500;600;700&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'k-bg': '#fdfbf7',
                        'k-text': '#1a1a1a',
                        'theme-color': '#2c3e50',
                        stone: {
                            50: '#fafaf9', 100: '#f5f5f4', 200: '#e7e5e4', 300: '#d6d3d1',
                            400: '#a8a29e', 500: '#78716c', 600: '#57534e', 700: '#44403c',
                            800: '#292524', 900: '#1c1917',
                        }
                    },
                    fontFamily: {
                        serif: ['"Noto Serif KR"', 'serif'],
                        sans: ['"Noto Sans KR"', 'sans-serif'],
                    },
                    boxShadow: {
                        'card': '0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03)',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #fdfbf7;
            background-image: radial-gradient(#e6e2d3 1px, transparent 1px);
            background-size: 24px 24px;
            word-break: keep-all; 
        }
        ::selection { background-color: #2c3e50; color: #ffffff; }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #2c3e50;
            width: 32px; height: 32px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .new-badge { animation: pulse-theme 2s infinite; }
        @keyframes pulse-theme {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(44, 62, 80, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 6px rgba(44, 62, 80, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(44, 62, 80, 0); }
        }
    </style>
</head>
<body class="text-k-text font-sans min-h-screen flex flex-col items-center py-6 px-4 sm:px-6">

    <!-- 메인 컨테이너 -->
    <main class="w-full max-w-4xl bg-white/90 backdrop-blur-md border-2 border-stone-200 shadow-xl rounded-xl overflow-hidden relative transition-all duration-500">
        
        <!-- 상단 컨트롤 (홈 버튼) -->
        <div class="absolute top-6 right-6 sm:top-8 sm:right-8 z-20 flex items-center gap-3">
            <a href="index.html" class="flex items-center gap-2 px-4 py-2 bg-white border-2 border-stone-200 rounded-full shadow-card text-stone-600 hover:text-k-text hover:border-theme-color transition-all duration-300 group">
                <i data-lucide="home" class="w-5 h-5"></i>
                <span class="hidden sm:inline font-serif text-base font-bold pt-0.5 group-hover:underline decoration-theme-color underline-offset-4 decoration-2">홈으로</span>
            </a>
        </div>

        <!-- 헤더 영역 -->
        <header class="pt-16 pb-8 px-6 sm:px-12 text-center sm:text-left bg-white">
            <div class="flex flex-col sm:items-start items-center">
                <p class="text-sm font-bold text-theme-color/80 mb-2 tracking-widest font-serif">도인들을 위한 안내</p>
                
                <div class="flex items-center gap-3 mb-2">
                    <i data-lucide="book-open" class="w-8 h-8 text-theme-color"></i>
                    <h1 class="text-4xl sm:text-5xl font-serif font-bold tracking-tight text-theme-color">
                        태극도 법식(法式)
                    </h1>
                </div>
                <div class="w-24 h-1 bg-theme-color mt-4 mb-6 rounded-full"></div>
                
                <p class="text-stone-700 font-medium text-lg sm:text-xl break-keep leading-relaxed">
                    도인들이 갖추어야 할 기본 예법과<br class="hidden sm:block"> 도인으로서의 마음가짐을 안내합니다.
                </p>
            </div>
        </header>

        <!-- 탭 네비게이션 -->
        <nav class="sticky top-0 z-10 bg-white/95 backdrop-blur border-b-2 border-stone-200 px-4 sm:px-8 py-4 overflow-x-auto shadow-sm">
            <div class="flex gap-3 min-w-max sm:justify-start" id="category-container">
                <div class="px-5 py-2.5 text-stone-400 text-base font-bold">로딩 중...</div>
            </div>
        </nav>

        <!-- 컨텐츠 리스트 영역 -->
        <section id="content-list" class="p-4 sm:p-8 space-y-6 bg-stone-50 min-h-[500px]">
            <div class="py-32 text-center flex flex-col items-center justify-center">
                <div class="loader mb-6"></div>
                <p class="text-stone-600 font-serif text-lg font-bold">데이터를 불러오고 있습니다...</p>
            </div>
        </section>

        <!-- 관리자 패널 (숨김 상태) -->
        <section id="admin-panel" class="hidden border-t-4 border-theme-color bg-stone-100 p-6 sm:p-10">
            <div class="flex items-center justify-between mb-8">
                <h3 class="font-serif text-2xl font-bold text-k-text flex items-center gap-3">
                    <div class="p-2 bg-theme-color text-white rounded-lg">
                        <i data-lucide="settings" class="w-6 h-6"></i>
                    </div>
                    관리자 패널
                </h3>
                <button onclick="window.resetForm()" class="text-sm font-bold text-stone-500 hover:text-theme-color underline decoration-2 underline-offset-4">입력 초기화</button>
            </div>

            <!-- 카테고리 관리 섹션 -->
            <div class="mb-10 p-6 bg-white rounded-xl border-2 border-stone-200 shadow-card">
                <label class="block text-sm font-bold text-stone-600 mb-4 flex items-center gap-2">
                    <i data-lucide="tags" class="w-4 h-4 text-theme-color"></i> 카테고리 관리
                </label>
                <div class="flex flex-wrap gap-3 mb-5" id="admin-category-list"></div>
                <div class="flex gap-3 h-12">
                    <input type="text" id="new-category-input" placeholder="새 카테고리 추가" 
                        class="flex-1 bg-stone-50 border-2 border-stone-300 rounded-lg px-4 text-base focus:outline-none focus:border-theme-color focus:bg-white transition-colors text-k-text placeholder-stone-400 font-medium">
                    <button onclick="window.addCategory()" class="px-6 bg-theme-color text-white rounded-lg hover:bg-stone-800 text-base font-bold transition-colors whitespace-nowrap shadow-md">
                        추가
                    </button>
                </div>
            </div>
            
            <!-- 글쓰기 폼 -->
            <form id="post-form" class="space-y-6 bg-white p-6 rounded-xl border-2 border-stone-200 shadow-card">
                <input type="hidden" id="edit-mode-id" value="">
                
                <div class="grid grid-cols-1 sm:grid-cols-4 gap-6">
                    <div class="sm:col-span-1">
                        <label class="block text-sm font-bold text-stone-600 mb-2">카테고리 선택</label>
                        <select id="input-category" class="w-full h-12 bg-stone-50 border-2 border-stone-300 rounded-lg px-3 text-base font-bold text-k-text focus:outline-none focus:border-theme-color cursor-pointer appearance-none">
                        </select>
                    </div>
                    <div class="sm:col-span-3">
                        <label class="block text-sm font-bold text-stone-600 mb-2">제목</label>
                        <input type="text" id="input-title" placeholder="제목을 입력하세요" class="w-full h-12 bg-stone-50 border-2 border-stone-300 rounded-lg px-4 text-lg font-bold text-k-text focus:outline-none focus:border-theme-color focus:bg-white font-serif placeholder-stone-400">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-bold text-stone-600 mb-2">내용</label>
                    <textarea id="input-desc" rows="6" placeholder="상세 내용을 입력하세요." class="w-full bg-stone-50 border-2 border-stone-300 rounded-lg p-4 text-base text-k-text leading-relaxed focus:outline-none focus:border-theme-color focus:bg-white placeholder-stone-400"></textarea>
                </div>

                <div class="p-4 bg-stone-50 rounded-lg border-2 border-stone-200">
                    <label class="block text-sm font-bold text-stone-600 mb-2 flex items-center gap-2">
                        <i data-lucide="image" class="w-4 h-4"></i> 사진/영상 첨부
                    </label>
                    <input type="file" id="input-file" accept="image/*,video/*" multiple class="w-full bg-white border-2 border-stone-300 rounded-lg p-2 text-sm focus:outline-none focus:border-theme-color file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-bold file:bg-stone-200 file:text-stone-700 hover:file:bg-stone-300 cursor-pointer">
                    <div id="file-preview-info" class="mt-3 text-sm text-theme-color font-bold hidden flex items-center gap-2">
                        <i data-lucide="check-circle" class="w-4 h-4"></i><span id="file-name-display"></span>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-bold text-stone-600 mb-2">URL (선택)</label>
                    <input type="text" id="input-image-url" placeholder="https://..." class="w-full h-12 bg-stone-50 border-2 border-stone-300 rounded-lg px-4 text-base focus:outline-none focus:border-theme-color focus:bg-white text-k-text font-medium">
                </div>

                <div class="pt-4">
                    <button type="submit" id="submit-btn" class="w-full py-4 bg-theme-color text-white rounded-xl hover:bg-stone-800 transition-all transform hover:-translate-y-1 text-lg font-bold shadow-lg flex items-center justify-center gap-2">
                        <i data-lucide="pen-line" class="w-5 h-5"></i>
                        <span id="submit-btn-text">게시글 저장하기</span>
                    </button>
                </div>
            </form>
        </section>

    </main>

    <!-- 푸터 -->
    <footer class="mt-10 mb-20 text-center text-stone-500 text-sm font-medium">
        <p class="font-serif text-lg text-stone-400 mb-1">Taegeukdo Guide for Do-in</p>
        <p>&copy; 2024 태극도 법식 안내. All rights reserved.</p>
    </footer>

    <!-- 플로팅 버튼 -->
    <div class="fixed bottom-8 right-8 z-40 flex flex-col gap-3">
        <button onclick="window.scrollTo({top: 0, behavior: 'smooth'})" class="p-3 bg-white border-2 border-stone-200 rounded-full shadow-card text-theme-color hover:bg-theme-color hover:text-white transition-all transform hover:-translate-y-1">
            <i data-lucide="arrow-up" class="w-6 h-6"></i>
        </button>
    </div>

    <!-- 관리자 모드 토글 -->
    <div class="fixed bottom-8 left-8 z-50 flex items-center gap-2 bg-white pl-4 pr-2 py-2 rounded-full shadow-lg border-2 border-stone-200 scale-90 opacity-80 hover:opacity-100 transition-all">
        <span class="text-xs font-bold text-stone-500">관리자 모드</span>
        <button id="admin-toggle" class="relative inline-flex h-6 w-10 items-center rounded-full bg-stone-300 transition-colors focus:outline-none">
            <span id="toggle-circle" class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform translate-x-1 shadow-sm"></span>
        </button>
    </div>

    <!-- 이미지 확대 모달 -->
    <div id="image-modal" class="hidden fixed inset-0 z-[70] flex items-center justify-center bg-black/90 backdrop-blur-sm cursor-zoom-out" onclick="window.closeImageModal()">
        <img id="modal-image" src="" alt="확대 이미지" class="max-w-[95%] max-h-[95%] object-contain rounded-lg shadow-2xl transition-all scale-95 opacity-0">
    </div>

    <!-- 비밀번호 확인 모달 -->
    <div id="password-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm transition-opacity duration-300">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-96 max-w-[90%] border-2 border-stone-200">
            <h3 class="font-serif font-bold text-2xl mb-3 text-k-text flex items-center gap-2">
                <i data-lucide="lock" class="w-6 h-6 text-theme-color"></i> 관리자 인증
            </h3>
            <p class="text-sm font-bold text-stone-500 mb-6">관리자 비밀번호를 입력해주세요.</p>
            <input type="password" id="admin-password-input" 
                class="w-full h-12 bg-stone-50 border-2 border-stone-300 rounded-lg px-4 text-lg mb-3 focus:outline-none focus:border-theme-color focus:bg-white text-center tracking-widest font-bold text-k-text" 
                placeholder="비밀번호" 
                onkeypress="if(event.key === 'Enter') window.checkPassword()">
            <p id="password-error" class="text-sm font-bold text-red-600 mb-6 opacity-0 transition-opacity text-center">
                비밀번호가 올바르지 않습니다.
            </p>
            <div class="flex justify-end gap-3">
                <button onclick="window.closePasswordModal()" class="px-5 py-2.5 text-sm font-bold text-stone-500 hover:bg-stone-100 rounded-lg transition-colors">취소</button>
                <button onclick="window.checkPassword()" class="px-6 py-2.5 text-sm font-bold bg-theme-color text-white rounded-lg hover:bg-stone-800 shadow-md transition-colors">확인</button>
            </div>
        </div>
    </div>

    <!-- 삭제 확인 모달 -->
    <div id="delete-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-96 max-w-[90%] border-2 border-stone-200 text-center">
            <div class="w-16 h-16 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-4 text-red-600">
                <i data-lucide="trash-2" class="w-8 h-8"></i>
            </div>
            <h3 class="font-serif font-bold text-2xl mb-2 text-k-text">게시글 삭제</h3>
            <p class="text-stone-600 font-medium mb-6">정말로 이 게시글을 삭제하시겠습니까?</p>
            <div class="flex gap-3">
                <button onclick="window.closeDeleteModal()" class="flex-1 py-3 text-base font-bold text-stone-600 bg-stone-100 hover:bg-stone-200 rounded-lg transition-colors">취소</button>
                <button id="confirm-delete-btn" class="flex-1 py-3 text-base font-bold bg-red-600 text-white rounded-lg hover:bg-red-700 shadow-md transition-colors">삭제</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK 및 앱 로직 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 요청하신 법식 순서 고정
        const FIX_ORDER = ['시립', '법배', '평배', '향납읍', '좌배', '국궁', '좌우진보', '법좌', '수련방법', '점호의례', '봉심의례', '부정기휘법'];

        const YOUR_FIREBASE_CONFIG = {
            apiKey: "AIzaSyAoUdyZJQjcT81_2YKzX1rzMJlNAoHcbAw",
            authDomain: "taegeuk-rules.firebaseapp.com",
            projectId: "taegeuk-rules",
            storageBucket: "taegeuk-rules.firebasestorage.app",
            messagingSenderId: "388014641769",
            appId: "1:388014641769:web:f9fd06f30a222663b448f8"
        };

        window.isAdminMode = false;
        window.currentCategory = '전체';
        window.editingId = null;
        window.deleteTargetId = null;
        let localContents = [];
        let localCategories = [];
        let localCategoriesObjects = [];

        const contentListEl = document.getElementById('content-list');
        const categoryContainerEl = document.getElementById('category-container');
        const adminPanelEl = document.getElementById('admin-panel');
        const postFormEl = document.getElementById('post-form');
        const adminToggleBtn = document.getElementById('admin-toggle');
        const toggleCircle = document.getElementById('toggle-circle');
        const adminCategoryListEl = document.getElementById('admin-category-list');
        const newCategoryInput = document.getElementById('new-category-input');
        const inputCategorySelect = document.getElementById('input-category');
        const fileInput = document.getElementById('input-file');
        const imageUrlInput = document.getElementById('input-image-url');
        const submitBtn = document.getElementById('submit-btn');
        const submitBtnText = document.getElementById('submit-btn-text');
        const passwordModal = document.getElementById('password-modal');
        const passwordInput = document.getElementById('admin-password-input');
        const passwordError = document.getElementById('password-error');
        const deleteModal = document.getElementById('delete-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');

        let db, auth;
        let useFirebase = false;
        let appId = 'tgd-guide-public';

        async function initialize() {
            try {
                const app = initializeApp(YOUR_FIREBASE_CONFIG);
                auth = getAuth(app);
                db = getFirestore(app);
                useFirebase = true;

                subscribeToData();
                console.log("Firebase connected.");
            } catch (error) {
                console.warn("Firebase offline mode.", error);
                useFirebase = false;
            }

            const savedAdminState = localStorage.getItem('isAdminMode') === 'true';
            if (savedAdminState) toggleAdminState(true);
        }

        function sortCategories(cats) {
            return cats.sort((a, b) => {
                const idxA = FIX_ORDER.indexOf(a.name);
                const idxB = FIX_ORDER.indexOf(b.name);
                if (idxA !== -1 && idxB !== -1) return idxA - idxB;
                if (idxA !== -1) return -1;
                if (idxB !== -1) return 1;
                return a.name.localeCompare(b.name);
            });
        }

        function subscribeToData() {
            const postsCollection = collection(db, 'artifacts', appId, 'public', 'data', 'posts');
            onSnapshot(postsCollection, (snapshot) => {
                localContents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderContents();
            }, (err) => console.error("Firestore Listen Error:", err));

            const catsCollection = collection(db, 'artifacts', appId, 'public', 'data', 'categories');
            onSnapshot(catsCollection, (snapshot) => {
                let cats = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                localCategoriesObjects = sortCategories(cats);
                localCategories = localCategoriesObjects.map(c => c.name);
                renderCategories();
                renderCategorySelect();
                renderAdminCategories();
                renderContents();
            });
        }

        function renderCategories() {
            const displayCategories = ['전체', ...localCategories];
            categoryContainerEl.innerHTML = displayCategories.map(cat => `
                <button onclick="window.setCategory('${cat}')" 
                    class="px-5 py-2.5 rounded-full text-base font-bold border-2 transition-all ${
                        window.currentCategory === cat 
                        ? 'bg-theme-color text-white border-theme-color scale-105 shadow-md' 
                        : 'bg-white text-stone-500 border-stone-200 hover:border-theme-color hover:text-theme-color'
                    }">${cat}</button>
            `).join('');
        }

        function renderCategorySelect() {
            inputCategorySelect.innerHTML = localCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
        }

        function renderAdminCategories() {
            adminCategoryListEl.innerHTML = ['전체', ...localCategories].map(cat => `
                <div class="flex items-center gap-1 px-4 py-2 bg-stone-100 border-2 border-stone-200 rounded-full text-sm font-bold text-stone-600">
                    <span>${cat}</span>
                    ${cat !== '전체' ? `<button onclick="window.deleteCategory('${cat}')" class="ml-2 text-stone-400 hover:text-red-600"><i data-lucide="x" class="w-4 h-4"></i></button>` : ''}
                </div>
            `).join('');
            lucide.createIcons();
        }

        function renderContents() {
            contentListEl.innerHTML = '';
            let filtered = window.currentCategory === '전체' ? [...localContents] : localContents.filter(item => item.category === window.currentCategory);

            filtered.sort((a, b) => {
                if (window.currentCategory === '전체') {
                    const idxA = FIX_ORDER.indexOf(a.category);
                    const idxB = FIX_ORDER.indexOf(b.category);
                    if (idxA !== idxB) return (idxA === -1 ? 999 : idxA) - (idxB === -1 ? 999 : idxB);
                }
                return (b.createdAt || 0) - (a.createdAt || 0);
            });

            if (filtered.length === 0) {
                contentListEl.innerHTML = '<div class="py-32 text-center text-stone-400 font-bold font-serif">등록된 안내 글이 없습니다.</div>';
                return;
            }

            filtered.forEach(item => {
                const div = document.createElement('div');
                div.className = 'p-6 sm:p-8 bg-white border-2 border-stone-200 rounded-xl shadow-card transition-all group relative mb-6 hover:border-theme-color';
                
                const images = item.images || (item.image ? [item.image] : []);
                let mediaHtml = images.length > 0 ? `
                    <div class="mb-6 w-full overflow-x-auto flex gap-3 pb-2 scrollbar-thin scrollbar-thumb-stone-300">
                        ${images.map(src => `<img src="${src}" class="h-48 rounded-lg object-cover cursor-zoom-in hover:opacity-90 transition-opacity" onclick="window.openImageModal('${src}')">`).join('')}
                    </div>` : '';

                div.innerHTML = `
                    ${mediaHtml}
                    <div class="flex items-center gap-3 mb-4">
                        <span class="text-sm font-bold text-theme-color bg-theme-color/10 px-3 py-1 rounded-full border border-theme-color/20">${item.category}</span>
                        <span class="text-sm text-stone-400 font-bold">${item.date || ''}</span>
                    </div>
                    <h2 class="text-2xl sm:text-3xl font-serif font-bold mb-4 text-k-text leading-snug break-keep group-hover:text-theme-color">${item.title}</h2>
                    <p class="text-stone-700 leading-loose text-base sm:text-lg font-medium whitespace-pre-line break-keep">${item.desc}</p>
                    ${window.isAdminMode ? `
                        <div class="absolute top-6 right-6 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="window.editPost('${item.id}')" class="p-2 bg-white border-2 rounded-lg text-stone-500 hover:text-theme-color"><i data-lucide="edit-2" class="w-5 h-5"></i></button>
                            <button onclick="window.openDeleteModal('${item.id}')" class="p-2 bg-white border-2 rounded-lg text-stone-500 hover:text-red-600"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                        </div>
                    ` : ''}
                `;
                contentListEl.appendChild(div);
            });
            lucide.createIcons();
        }

        window.checkPassword = async () => {
            if (passwordInput.value === "taegeuk1909#") {
                try {
                    await signInAnonymously(auth);
                    toggleAdminState(true);
                    window.closePasswordModal();
                } catch (e) {
                    console.error("Auth Error:", e);
                    alert("인증 오류가 발생했습니다.");
                }
            } else {
                passwordError.classList.remove('opacity-0');
            }
        };

        window.addCategory = async () => {
            const name = newCategoryInput.value.trim();
            if (!name || localCategories.includes(name)) return;
            if (useFirebase) await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'categories'), { name });
            newCategoryInput.value = '';
        };

        window.deleteCategory = async (name) => {
            if (name === '전체' || !confirm(`'${name}' 삭제하시겠습니까?`)) return;
            const obj = localCategoriesObjects.find(c => c.name === name);
            if (useFirebase && obj) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'categories', obj.id));
        };

        postFormEl.addEventListener('submit', async (e) => {
            e.preventDefault();
            const category = document.getElementById('input-category').value;
            const title = document.getElementById('input-title').value;
            const desc = document.getElementById('input-desc').value;
            const files = Array.from(fileInput.files);
            const url = imageUrlInput.value.trim();

            if (!title || !desc) return alert("제목과 내용을 입력해주세요.");

            submitBtn.disabled = true;
            submitBtnText.innerText = "저장 중...";

            try {
                let processedImages = [];
                for (const f of files) {
                    const data = await new Promise((res) => {
                        const r = new FileReader();
                        r.onload = (ev) => res(ev.target.result);
                        r.readAsDataURL(f);
                    });
                    processedImages.push(data);
                }
                if (url) processedImages.push(url);

                // --- 기존 이미지 유지 로직 복구 ---
                let finalImages = processedImages;
                let finalDate = new Date().toISOString().split('T')[0].replace(/-/g, '.');
                let finalCreatedAt = Date.now();

                if (window.editingId) {
                    const existingPost = localContents.find(p => String(p.id) === String(window.editingId));
                    if (existingPost) {
                        // 새 파일이나 URL을 입력하지 않았다면 기존 이미지를 그대로 사용합니다.
                        if (finalImages.length === 0) {
                            finalImages = existingPost.images || (existingPost.image ? [existingPost.image] : []);
                        }
                        // 수정 시 기존 작성일과 정렬 순서(createdAt)를 유지합니다.
                        finalDate = existingPost.date || finalDate;
                        finalCreatedAt = existingPost.createdAt || finalCreatedAt;
                    }
                }
                // ---------------------------------

                const postData = {
                    category, title, desc,
                    images: finalImages,
                    date: finalDate,
                    createdAt: finalCreatedAt
                };

                if (window.editingId) {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'posts', window.editingId), postData);
                } else {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'posts'), postData);
                }
                window.resetForm();
                alert("저장되었습니다.");
            } catch (err) {
                alert("오류: " + err.message);
            } finally {
                submitBtn.disabled = false;
                submitBtnText.innerText = "게시글 저장하기";
            }
        });

        // --- 수정 모드 진입 시 기존 이미지 안내 UI 추가 ---
        window.editPost = (id) => {
            const p = localContents.find(x => String(x.id) === String(id));
            if (!p) return;
            window.editingId = id;
            document.getElementById('input-category').value = p.category;
            document.getElementById('input-title').value = p.title;
            document.getElementById('input-desc').value = p.desc;
            
            // 기존 이미지/영상이 있으면 파일 입력란 아래에 안내 문구를 띄워줍니다.
            const images = p.images || (p.image ? [p.image] : []);
            const previewInfo = document.getElementById('file-preview-info');
            const nameDisplay = document.getElementById('file-name-display');
            
            if (images.length > 0) {
                previewInfo.classList.remove('hidden');
                nameDisplay.innerText = `기존 파일 ${images.length}개가 유지됩니다. (새 파일 선택 시 덮어쓰기 됨)`;
            } else {
                previewInfo.classList.add('hidden');
            }
            
            adminPanelEl.scrollIntoView({ behavior: 'smooth' });
        };

        window.openDeleteModal = (id) => { window.deleteTargetId = id; deleteModal.classList.remove('hidden'); };
        window.closeDeleteModal = () => deleteModal.classList.add('hidden');
        confirmDeleteBtn.addEventListener('click', async () => {
            if (window.deleteTargetId && useFirebase) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'posts', window.deleteTargetId));
                window.closeDeleteModal();
            }
        });

        window.setCategory = (c) => { window.currentCategory = c; renderCategories(); renderContents(); };
        window.resetForm = () => { 
            window.editingId = null; 
            postFormEl.reset(); 
            document.getElementById('file-preview-info').classList.add('hidden');
        };
        window.closePasswordModal = () => passwordModal.classList.add('hidden');
        
        window.openImageModal = (s) => { 
            const m = document.getElementById('image-modal');
            const i = document.getElementById('modal-image');
            m.classList.remove('hidden'); i.src = s;
            setTimeout(() => { i.classList.remove('scale-95', 'opacity-0'); i.classList.add('scale-100', 'opacity-100'); }, 10);
        };
        
        window.closeImageModal = () => {
            const i = document.getElementById('modal-image');
            i.classList.replace('scale-100', 'scale-95');
            i.classList.replace('opacity-100', 'opacity-0');
            setTimeout(() => document.getElementById('image-modal').classList.add('hidden'), 300);
        };

        fileInput.addEventListener('change', () => {
            const count = fileInput.files.length;
            const previewInfo = document.getElementById('file-preview-info');
            const nameDisplay = document.getElementById('file-name-display');
            if (count > 0) {
                previewInfo.classList.remove('hidden');
                nameDisplay.innerText = `${count}개의 파일 선택됨`;
            } else {
                // 수정을 취소하고 파일을 비웠을 때 상태를 원래대로
                if (!window.editingId) {
                    previewInfo.classList.add('hidden');
                }
            }
        });

        function toggleAdminState(enable) {
            window.isAdminMode = enable;
            localStorage.setItem('isAdminMode', enable);
            if (enable) {
                adminToggleBtn.classList.replace('bg-stone-300', 'bg-theme-color');
                toggleCircle.classList.replace('translate-x-1', 'translate-x-5');
                adminPanelEl.classList.remove('hidden');
            } else {
                adminToggleBtn.classList.replace('bg-theme-color', 'bg-stone-300');
                toggleCircle.classList.replace('translate-x-5', 'translate-x-1');
                adminPanelEl.classList.add('hidden');
            }
            renderContents();
        }

        adminToggleBtn.addEventListener('click', () => {
            if (window.isAdminMode) toggleAdminState(false);
            else passwordModal.classList.remove('hidden');
        });

        initialize();
        lucide.createIcons();
    </script>
</body>
</html>
