<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê³µë¶€ì ê°€ì´ë“œ</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Config: High Contrast Korean Minimalism -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Point Color: Strong Red Bean (ê°€ì‹œì„± ë†’ì€ íŒ¥ìƒ‰)
                        point: {
                            DEFAULT: '#9d2424', 
                            light: '#c13b3b',
                            dark: '#7a1b1b',
                            bg: 'rgba(157, 36, 36, 0.08)' // ì—°í•œ ë¶‰ì€ ë°°ê²½
                        },
                        // Text Color: Deep Black (íë¦¿í•˜ì§€ ì•Šì€ ì§„í•œ ê²€ì •)
                        ink: '#1a1a1a',
                        // Sub Text: Dark Gray
                        sub: '#4a4a4a',
                        // Background: Light Warm Gray
                        paper: '#f5f5f4', // stone-100
                        
                        // Roles
                        member: '#d97706',
                        oesu: '#2563eb',
                        naesu: '#dc2626',
                    },
                    fontFamily: {
                        sans: ['Noto Sans KR', 'sans-serif'],
                        serif: ['Noto Serif KR', 'serif'],
                    },
                    backgroundImage: {
                        'hanji-texture': 'radial-gradient(#d6d3d1 1px, transparent 1px)',
                    },
                    backgroundSize: {
                        'hanji-size': '24px 24px',
                    },
                    boxShadow: {
                        'card': '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
                        'floating': '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Noto+Serif+KR:wght@600;700&display=swap');
        
        body { 
            font-family: 'Noto Sans KR', sans-serif; 
            background-color: #f5f5f4; 
            color: #1a1a1a;
            background-image: radial-gradient(#d6d3d1 1px, transparent 1px);
            background-size: 24px 24px;
            word-break: keep-all; /* break-keep ê¸°ë³¸ ì ìš© */
        }
        
        h1, h2, h3, h4, h5, h6, .font-serif { font-family: 'Noto Serif KR', serif; }

        /* Custom Utilities */
        .break-keep { word-break: keep-all; }
        
        /* Card Style */
        .card-box {
            background-color: #ffffff;
            border: 2px solid #e7e5e4; /* stone-200 */
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        /* Interactive Element Style */
        .interactive-card {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            background-color: #ffffff;
            border: 2px solid #e7e5e4;
        }
        .interactive-card:hover {
            border-color: #9d2424;
            background-color: #fff1f2; /* red-50 */
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(157, 36, 36, 0.1);
        }

        /* Badge Style */
        .badge-point {
            display: inline-flex;
            align-items: center;
            background-color: rgba(157, 36, 36, 0.1);
            color: #9d2424;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 700;
            font-size: 0.875rem;
        }

        /* Timeline Line */
        .timeline-line::before {
            content: '';
            position: absolute;
            top: 24px;
            bottom: 24px;
            left: 20px; /* Adjusted for larger dots */
            width: 2px;
            background-color: #d6d3d1;
            z-index: 0;
        }

        /* Nav Button */
        .nav-btn {
            background-color: #ffffff;
            border: 2px solid #e7e5e4;
            color: #57534e;
            font-weight: 500;
            transition: all 0.2s;
        }
        .nav-active {
            border-color: #9d2424;
            background-color: #9d2424;
            color: #ffffff;
            font-weight: 700;
            box-shadow: 0 4px 6px -1px rgba(157, 36, 36, 0.3);
        }
        
        /* Current Item Highlight */
        .current-item {
            border: 2px solid #9d2424 !important;
            background-color: #ffffff !important;
            box-shadow: 0 8px 20px rgba(157, 36, 36, 0.15) !important;
            transform: scale(1.01);
        }

        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
    </style>
</head>
<body class="antialiased min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-white border-b-2 border-stone-200 sticky top-0 z-50 shadow-sm">
        <div class="container mx-auto max-w-4xl px-4 py-4 flex justify-between items-center">
            <div class="flex flex-col">
                <h1 class="text-2xl md:text-3xl font-bold font-serif text-ink flex items-center gap-2">
                    <span class="text-point">â–</span> ê³µë¶€ì ê°€ì´ë“œ
                </h1>
                <span class="text-sm text-sub mt-1 tracking-wide font-medium">ì˜¤ëŠ˜ì˜ ë§ˆìŒê°€ì§: ì •ì„±(ç²¾èª )</span>
            </div>
            
            <!-- Home Button -->
            <a href="index.html" class="flex items-center gap-2 px-4 py-2 rounded-full border-2 border-stone-200 hover:border-point hover:bg-point/5 hover:text-point transition-all duration-200 group bg-stone-50">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
                <span class="hidden sm:inline font-bold break-keep">í™ˆìœ¼ë¡œ</span>
            </a>
        </div>
    </header>

    <!-- Main Container -->
    <div class="flex-grow w-full max-w-4xl mx-auto bg-white/80 backdrop-blur-md shadow-2xl border-x-2 border-white/50 min-h-screen">
        
        <!-- Navigation -->
        <nav class="sticky top-[73px] z-40 bg-white/90 backdrop-blur border-b-2 border-stone-200 p-4">
            <div class="flex gap-3 overflow-x-auto pb-1 md:pb-0">
                <button onclick="switchTab('schedule')" id="nav-schedule" class="flex-1 py-3 px-4 rounded-xl text-center nav-btn nav-active text-lg whitespace-nowrap">ì¼ê³¼í‘œ</button>
                <button onclick="switchTab('practice')" id="nav-practice" class="flex-1 py-3 px-4 rounded-xl text-center nav-btn text-lg whitespace-nowrap">ê³µë¶€ ë° ì—­í• </button>
                <button onclick="switchTab('simulator')" id="nav-simulator" class="flex-1 py-3 px-4 rounded-xl text-center nav-btn text-lg whitespace-nowrap">ì‹œë®¬ë ˆì´í„°</button>
            </div>
        </nav>

        <!-- Main Content Area -->
        <main class="px-4 md:px-8 py-8 md:py-12">

            <!-- SECTION 1: DAILY SCHEDULE -->
            <section id="view-schedule" class="space-y-8 animate-fade-in">
                
                <div class="card-box p-6 md:p-8">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-4 border-b-2 border-stone-100 pb-6 mb-6">
                        <div>
                            <span class="badge-point mb-2">ì•ˆë‚´</span>
                            <h2 class="text-3xl font-bold text-ink font-serif mb-2">í•˜ë£¨ì˜ íë¦„</h2>
                            <p class="text-lg text-sub font-medium leading-relaxed break-keep">
                                ëª¨ë“  ì§‘í•© ì‹œê°„ <span class="text-point font-bold border-b-2 border-point/30">10~20ë¶„ ì „</span>ê¹Œì§€ ë¯¸ë¦¬ ë„ì°©í•˜ì—¬ ë§ˆìŒì„ ì •ëˆí•´ ì£¼ì„¸ìš”.
                            </p>
                        </div>
                    </div>
                    
                    <div class="flex flex-wrap gap-4">
                        <!-- Sunday Toggle -->
                        <label class="interactive-card flex items-center gap-3 px-5 py-4 rounded-xl w-full md:w-auto">
                            <input type="checkbox" id="sunday-toggle" onchange="toggleSundayMode(this.checked)" class="w-6 h-6 text-point rounded border-stone-300 focus:ring-point accent-point">
                            <span class="text-lg font-bold text-ink">ì£¼ì¼ ì¼ì • ë³´ê¸°</span>
                        </label>

                        <!-- Sasu Toggle -->
                        <label class="interactive-card flex items-center gap-3 px-5 py-4 rounded-xl w-full md:w-auto">
                            <input type="checkbox" id="sasu-toggle" onchange="renderSchedule()" class="w-6 h-6 text-point rounded border-stone-300 focus:ring-point accent-point">
                            <span class="text-lg font-bold text-ink">ì‚¬ìˆ˜ ì—­í•  í¬í•¨í•˜ê¸°</span>
                        </label>
                    </div>
                </div>

                <!-- Timeline -->
                <div class="relative timeline-line pl-4 md:pl-6" id="timeline-container">
                    <!-- Javascript will populate this -->
                </div>
            </section>

            <!-- SECTION 2: PRACTICE & ROLES -->
            <section id="view-practice" class="hidden space-y-8 animate-fade-in">
                
                <div class="card-box p-6 md:p-8 border-l-8 border-l-point">
                    <span class="badge-point mb-3">ì¤‘ìš”</span>
                    <h2 class="text-3xl font-bold text-ink font-serif mb-4">ë‚˜ì˜ ê³µë¶€ ë° ì—­í• </h2>
                    <p class="text-lg text-sub font-medium leading-relaxed break-keep">
                        ì‹œê°„ íë¦„ì— ë”°ë¥¸ êµ¬ì²´ì ì¸ ì„ë¬´ì™€ ì ˆì°¨ë¥¼ í™•ì¸í•˜ì„¸ìš”.<br>
                        <strong class="text-point text-xl block mt-2">ëª¨ë“  í–‰ë™ì€ íšŒì›ì„ ì¤‘ì‹¬ìœ¼ë¡œ ë§ì¶”ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤.</strong>
                    </p>
                </div>

                <!-- Inputs Wrapper -->
                <div class="card-box p-8 md:p-10 flex flex-col items-center gap-8">
                    
                    <div class="w-full flex justify-end">
                        <label class="interactive-card inline-flex items-center gap-2 px-4 py-2 rounded-lg">
                            <input type="checkbox" id="practice-sunday-toggle" onchange="toggleSundayMode(this.checked)" class="w-5 h-5 text-point rounded border-stone-300 focus:ring-point accent-point">
                            <span class="text-base font-bold text-sub">ì£¼ì¼ ì¼ì • ë°˜ì˜</span>
                        </label>
                    </div>

                    <!-- Time Input -->
                    <div class="flex flex-col md:flex-row items-center justify-center gap-4 w-full bg-stone-50 p-6 rounded-2xl border-2 border-stone-200">
                        <span class="text-2xl text-ink font-serif font-bold">ë‚˜ëŠ”</span>
                        <div class="relative">
                            <input type="number" id="practice-hour" min="1" max="12" value="3" onchange="generateRitualTimeline()" 
                                class="text-5xl font-bold text-center w-32 border-b-4 border-stone-300 focus:border-point focus:outline-none bg-transparent transition-colors font-serif text-ink p-2 mx-2">
                        </div>
                        <span class="text-2xl text-ink font-serif font-bold">ì‹œ ê³µë¶€ìì…ë‹ˆë‹¤.</span>
                    </div>

                    <!-- Role Filter -->
                    <div class="w-full max-w-2xl">
                        <div class="text-center mb-4">
                            <span class="badge-point">ì§ì±… ì„ íƒ</span>
                        </div>
                        <div class="grid grid-cols-4 gap-3 md:gap-4">
                            <button onclick="setRoleFilter('all')" id="btn-role-all" class="py-4 text-lg rounded-xl transition-all border-2 border-ink bg-ink text-white font-bold shadow-md hover:opacity-90">ì „ì²´</button>
                            <button onclick="setRoleFilter('member')" id="btn-role-member" class="interactive-card py-4 text-lg rounded-xl text-stone-600 font-bold hover:text-point">íšŒì›</button>
                            <button onclick="setRoleFilter('oesu')" id="btn-role-oesu" class="interactive-card py-4 text-lg rounded-xl text-stone-600 font-bold hover:text-point">ì™¸ìˆ˜</button>
                            <button onclick="setRoleFilter('naesu')" id="btn-role-naesu" class="interactive-card py-4 text-lg rounded-xl text-stone-600 font-bold hover:text-point">ë‚´ìˆ˜</button>
                        </div>
                    </div>
                </div>

                <!-- Steps Timeline -->
                <div id="ritual-steps" class="space-y-6 relative mt-12">
                    <!-- Javascript will populate this -->
                </div>

                <!-- Core Rules -->
                <div class="mt-16 pt-10 border-t-2 border-stone-200 space-y-12">
                    
                    <!-- 1. Daegangjeon Precautions -->
                    <section>
                        <h3 class="font-bold text-2xl text-ink mb-6 font-serif flex items-center gap-3">
                            <span class="text-3xl">ğŸ›ï¸</span> ëŒ€ê°•ì „ ë‚´ ì£¼ì˜ì‚¬í•­
                        </h3>
                        <div class="bg-stone-50 border-2 border-stone-200 p-6 md:p-8 rounded-2xl shadow-sm">
                            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-y-8 gap-x-6">
                                <div class="flex flex-col gap-2">
                                    <div class="flex items-center gap-2">
                                        <span class="badge-point">ë©´ìˆ˜</span>
                                    </div>
                                    <p class="text-base text-sub font-medium leading-relaxed pl-1">ë°”ë¥´ê²Œ ì„œì„œ í„±ì„ ì‚´ì§ ë‹¹ê²¨ ì‹œì„ ì„ ì•„ë˜ìª½ìœ¼ë¡œ ì²˜ë¦¬í•œ ìì„¸</p>
                                </div>
                                <div class="flex flex-col gap-2">
                                    <div class="flex items-center gap-2">
                                        <span class="badge-point">ì–‘ìˆ˜êµì§€</span>
                                    </div>
                                    <p class="text-base text-sub font-medium leading-relaxed pl-1">ì—„ì§€ ì†ê°€ë½ì„ êµì°¨í•˜ì—¬ ì†ì„ ëª¨ìœ¼ê³  ìˆëŠ” ìì„¸</p>
                                </div>
                                <div class="flex items-center gap-3 text-lg text-ink font-bold h-fit self-start sm:mt-1 bg-white px-4 py-3 rounded-xl border border-stone-200 shadow-sm w-full">
                                    <span class="text-point">â—</span> í°ì†Œë¦¬ ë‚´ì§€ ì•Šê¸°
                                </div>
                                <div class="flex items-center gap-3 text-lg text-ink font-bold h-fit self-start bg-white px-4 py-3 rounded-xl border border-stone-200 shadow-sm w-full">
                                    <span class="text-point">â—</span> ë›°ì§€ ì•Šê¸°
                                </div>
                                <div class="flex items-center gap-3 text-lg text-ink font-bold h-fit self-start bg-white px-4 py-3 rounded-xl border border-stone-200 shadow-sm w-full">
                                    <span class="text-point">â—</span> ì¡ë‹´í•˜ì§€ ì•Šê¸°
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- 2. Bongsim Major Precautions -->
                    <section>
                        <h3 class="font-bold text-2xl text-ink mb-6 font-serif flex items-center gap-3">
                            <span class="text-3xl">âš ï¸</span> ë´‰ì‹¬ ì£¼ìš” ì£¼ì˜ ì‚¬í•­
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div class="card-box p-6 flex gap-5 items-start">
                                <span class="text-point text-2xl font-bold mt-1">âœ”</span>
                                <div>
                                    <span class="font-bold text-xl text-ink block mb-2">ì‹œê°„ ì—„ìˆ˜</span>
                                    <span class="text-base text-sub font-medium">ëª¨ë“  ì§‘í•© 10~20ë¶„ ì „ ë„ì°©</span>
                                </div>
                            </div>
                            <div class="card-box p-6 flex gap-5 items-start">
                                <span class="text-point text-2xl font-bold mt-1">âœ”</span>
                                <div>
                                    <span class="font-bold text-xl text-ink block mb-2">ì™¼ë°œ ë¨¼ì €</span>
                                    <span class="text-base text-sub font-medium">ê³„ë‹¨, ë¬¸í„± ë„˜ì„ ë•Œ í•­ìƒ ì™¼ë°œë¶€í„°</span>
                                </div>
                            </div>
                            <div class="card-box p-6 flex gap-5 items-start">
                                <span class="text-point text-2xl font-bold mt-1">âœ”</span>
                                <div>
                                    <span class="font-bold text-xl text-ink block mb-2">ì •ìˆ™ (ë¬µì–¸)</span>
                                    <span class="text-base text-sub font-medium">ëŒ€ê¸° ì¤‘ ì¡ë‹´ ê¸ˆì§€</span>
                                </div>
                            </div>
                            <div class="card-box p-6 flex gap-5 items-start">
                                <span class="text-point text-2xl font-bold mt-1">âœ”</span>
                                <div>
                                    <span class="font-bold text-xl text-ink block mb-2">êµ­ê¶ ìœ ì§€</span>
                                    <span class="text-base text-sub font-medium">ì´ë™ ì™„ë£Œ ì‹œê¹Œì§€ í—ˆë¦¬ ìˆ™ì¸ ìì„¸</span>
                                </div>
                            </div>
                            <div class="card-box p-6 flex gap-5 items-start md:col-span-2 bg-red-50 border-red-100">
                                <span class="text-point text-2xl mt-1">ğŸ“¢</span>
                                <div>
                                    <span class="font-bold text-xl text-point block mb-2">ì£¼ë¬¸ ì—°ê²°</span>
                                    <span class="text-base text-ink font-medium">ì£¼ë¬¸ì´ ëŠê¸°ì§€ ì•Šë„ë¡ ì• ì‹œê°„ ê³µë¶€ìì˜ ì£¼ì„±ì— ê·€ ê¸°ìš¸ì—¬ ì£¼ì„¸ìš”.</span>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </section>

            <!-- SECTION 3: SIMULATOR -->
            <section id="view-simulator" class="hidden space-y-8 animate-fade-in">
                <div class="card-box p-6 md:p-8">
                    <span class="badge-point mb-3">êµìœ¡</span>
                    <h2 class="text-3xl font-bold text-ink font-serif mb-4">ê³µë¶€ë°© ì…ì‹¤ ì‹œë®¬ë ˆì´í„°</h2>
                    <div class="space-y-6">
                        <p class="text-lg text-sub font-medium leading-relaxed">ë³µì¡í•œ ì…ì‹¤ ë™ì„ ì„ ì‹œê°ì ìœ¼ë¡œ ìµí˜€ë³´ì„¸ìš”.<br>íšŒì›ê³¼ ë‚´ìˆ˜ëŠ” ë’¤ë¡œ ë¬¼ëŸ¬ë‚˜ê³ , ë“¤ì–´ì˜¤ëŠ” ì‚¬ëŒì€ ê¸°ì¡´ ì‚¬ëŒë“¤ì˜ ë’¤ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.</p>
                        
                        <!-- Detailed Instructions Box -->
                        <div class="bg-stone-50 border-2 border-stone-200 rounded-xl p-6 text-base text-ink font-medium leading-loose">
                            <ul class="list-disc pl-5 space-y-3">
                                <li><strong class="text-point bg-red-50 px-2 py-0.5 rounded">ê³¼í•œ ì¸ì‚¬ ì§€ì–‘</strong> ì…ì‹¤ í›„ì—ëŠ” ë„ˆë¬´ ê³¼í•œ ì¸ì‚¬ë¥¼ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì¢Œë°°(åæ‹œ)ë¡œ ì‹œì‘í•´ì„œ ì¢Œë°°ë¡œ ëë‚  ìˆ˜ ìˆë„ë¡ ê³¼í•œ ë¶€ë³µ(ì—ë“œë ¤ ì ˆí•¨)ì€ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</li>
                                <li><strong class="text-point bg-red-50 px-2 py-0.5 rounded">íšŒì›ì—ê²Œ ì†ë„ ë§ì¶¤</strong> ì˜†ì˜ íšŒì›ì´ ìë¦¬ì— ì•‰ìœ¼ë©´ ì²­ì†Œë¥¼ ë©ˆì¶”ê³  ì •ëˆí•©ë‹ˆë‹¤. ëª¨ë“  í–‰ë™ì˜ ì†ë„ëŠ” íšŒì›ì—ê²Œ ë§ì¶°ì•¼ í•©ë‹ˆë‹¤.</li>
                                <li><strong class="text-point bg-red-50 px-2 py-0.5 rounded">êµëŒ€ ì‹œ ê±°ë¦¬ í™•ë³´</strong> íšŒì›ê³¼ ë‚´ìˆ˜ê°€ ì—‰ë©ì´ë¥¼ ë’¤ë¡œ ë¬¼ë¦´ ë•Œ, ë‹¤ìŒ ê³µë¶€ìê°€ ì§€ë‚˜ê°ˆ ìˆ˜ ìˆëŠ” ê±°ë¦¬ë¥¼ í™•ë³´í•˜ê³  ë¬¼ëŸ¬ë‚˜ì•¼ í•©ë‹ˆë‹¤. ë„ˆë¬´ ë’¤ë¡œ ë¬¼ëŸ¬ë‚˜ë©´ ë²½ê³¼ì˜ ê³µê°„ì´ ì—†ì–´ í†µí–‰ì´ ì–´ë µìŠµë‹ˆë‹¤.</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="card-box p-4 shadow-lg flex flex-col items-center">
                    <div class="relative w-full max-w-[500px] aspect-square bg-[#F5F5DC] border-4 border-[#8D6E63] rounded-lg mb-6 overflow-hidden shadow-inner">
                        <!-- Adjusted Table Position -->
                        <div class="absolute top-0 left-[60%] -translate-x-1/2 w-1/3 h-3 bg-[#5D4037] rounded-b-md shadow-sm"></div>
                        <div class="absolute top-4 left-[60%] -translate-x-1/2 text-[#5D4037] text-sm font-bold bg-[#F5F5DC]/80 px-2 rounded">í–¥ íƒì (ì•)</div>
                        <div class="absolute top-1/2 left-0 -translate-y-1/2 w-3 h-20 bg-[#3E2723] rounded-r shadow-md"></div>
                        <div class="absolute top-1/2 left-5 -translate-y-1/2 text-[#3E2723] text-sm font-bold -rotate-90">ì¶œì…ë¬¸</div>
                        <canvas id="simCanvas" width="500" height="500" class="w-full h-full"></canvas>
                    </div>

                    <div class="w-full max-w-[500px] flex flex-col gap-4">
                        <div class="bg-stone-50 p-6 rounded-xl border-2 border-stone-200 min-h-[100px] flex items-center justify-center text-center shadow-sm">
                            <p id="step-description" class="text-xl font-bold text-ink transition-all break-keep leading-relaxed">ì‹œë®¬ë ˆì´ì…˜ì„ ì‹œì‘í•˜ë ¤ë©´ ì•„ë˜ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.</p>
                        </div>

                        <div class="flex justify-between gap-3">
                            <button onclick="simController.prev()" class="interactive-card flex-1 py-4 text-lg text-ink rounded-xl font-bold bg-white">â—€ ì´ì „</button>
                            <button onclick="simController.play()" class="interactive-card flex-1 py-4 text-lg text-white rounded-xl font-bold bg-point border-point hover:bg-red-800">â–¶ ì¬ìƒ/ì •ì§€</button>
                            <button onclick="simController.next()" class="interactive-card flex-1 py-4 text-lg text-ink rounded-xl font-bold bg-white">ë‹¤ìŒ â–¶</button>
                        </div>
                        <button onclick="simController.reset()" class="w-full py-3 text-sub font-medium hover:text-ink text-base underline decoration-stone-300 underline-offset-4">â†º ì²˜ìŒìœ¼ë¡œ ë¦¬ì…‹</button>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <footer class="border-t-2 border-stone-200 py-12 mt-0 text-center bg-white">
        <p class="font-bold font-serif mb-2 text-ink text-xl">íƒœê·¹ë„</p>
        <p class="text-base text-sub font-medium">ê³µë¶€ ì´ˆì‹¬ìë¥¼ ìœ„í•œ ìˆ˜ë ¨ ê°€ì´ë“œ</p>
    </footer>

    <!-- Logic -->
    <script>
        // Global State for Sunday Mode
        let isGlobalSundayMode = false;

        // Data - Weekday Schedule
        const weekdayItems = [
            { time: "01:30", title: "ì¶•ì‹œ ê¸°ë„", loc: "ëŒ€ê°•ì „ 1ì¸µ", note: "01:20ê¹Œì§€ ëŒ€ê¸° ë° ëª…ìƒ", role: "all" },
            { time: "02:00", title: "ì·¨ì¹¨", loc: "ìˆ™ì†Œ", note: "", role: "all" },
            // Removed 07:15 ê¸°ìƒ
            { time: "07:10", title: "ì²´ì¡°", loc: "ëŒ€ê°•ì „ 1ì¸µ", note: "", role: "all" },
            { time: "07:30", title: "ì§„ì‹œ ê¸°ë„", loc: "ëŒ€ê°•ì „ 1ì¸µ", note: "07:20ê¹Œì§€ ëŒ€ê¸° ë° ëª…ìƒ", role: "all" },
            { time: "07:50", title: "ì•„ì¹¨ ì‹ì‚¬", loc: "ì‹ë‹¹", note: "", role: "all" },
            { time: "08:15", title: "ë°©ì¥ íšŒì˜", loc: "ë³„ê´€", note: "ì‚¬ìˆ˜ í•„ìˆ˜ ì°¸ì„", role: "sasu" },
            { time: "08:27", title: "ì²´ì¡°", loc: "ì²­í•™ê´€", note: "", role: "all" },
            { time: "08:35", title: "ê³µì§€ì‚¬í•­", loc: "ì²­í•™ê´€", note: "08:40ê¹Œì§€", role: "all" },
            { time: "08:40", title: "ì²­ì†Œ", loc: "ì§€ì • êµ¬ì—­", note: "09:20ê¹Œì§€ ì§„í–‰", role: "learner_only" }, 
            { time: "08:50", title: "ì‚¬ìˆ˜ íšŒì˜", loc: "ë³„ê´€", note: "", role: "sasu" },
            { time: "10:05", title: "ìˆ˜ë ¨ ëŒ€ê¸° ë° í™˜ì˜", loc: "ëŒ€ê°•ì „ 2ì¸µ", note: "ê³µë¶€ì í™˜ì˜ ì¤€ë¹„", role: "sasu" },
            { time: "10:20", title: "ì‚¬ìˆ˜ ìŠ¤í”¼ì¹˜", loc: "ëŒ€ê°•ì „ 2ì¸µ", note: "", role: "sasu" },
            { time: "10:30", title: "ì˜¤ì „ ìˆ˜ë ¨", loc: "ëŒ€ê°•ì „ 2ì¸µ", note: "10:10ê¹Œì§€ ëŒ€ê¸°", role: "all" },
            { time: "11:30", title: "ì ì‹¬ ì‹ì‚¬", loc: "ì‹ë‹¹", note: "", role: "all" },
            { time: "12:00", title: "í† ë¡ ", loc: "ì²­í•™ê´€", note: "", role: "all" },
            { time: "13:30", title: "ë¯¸ì‹œ ê¸°ë„", loc: "ëŒ€ê°•ì „ 1ì¸µ", note: "13:20ê¹Œì§€ ëŒ€ê¸° ë° ëª…ìƒ", role: "all" },
            { time: "14:00", title: "ì¼ëŒ€ì¼ ë§Œë‚¨", loc: "ì²­í•™ê´€", note: "", role: "all" },
            { time: "15:00", title: "ì¼ëŒ€ì¼ ë§Œë‚¨", loc: "ì²­í•™ê´€", note: "", role: "all" },
            { time: "16:05", title: "ìˆ˜ë ¨ ëŒ€ê¸° ë° í™˜ì˜", loc: "ëŒ€ê°•ì „ 2ì¸µ", note: "ê³µë¶€ì í™˜ì˜ ì¤€ë¹„", role: "sasu" },
            { time: "16:20", title: "ì‚¬ìˆ˜ ìŠ¤í”¼ì¹˜", loc: "ëŒ€ê°•ì „ 2ì¸µ", note: "", role: "sasu" },
            { time: "16:30", title: "ì˜¤í›„ ìˆ˜ë ¨", loc: "ëŒ€ê°•ì „ 2ì¸µ", note: "16:10ê¹Œì§€ ëŒ€ê¸°", role: "all" },
            { time: "17:00", title: "ì‚¬ìˆ˜ íšŒì˜", loc: "ë³„ê´€", note: "ì‚¬ìˆ˜ ì¼ì • ì¢…ë£Œ ë³´ê³ ", role: "sasu" },
            { time: "17:30", title: "ì €ë… ì‹ì‚¬", loc: "ì‹ë‹¹", note: "", role: "all" },
            { time: "19:30", title: "ìˆ ì‹œ ê¸°ë„", loc: "ëŒ€ê°•ì „ 1ì¸µ", note: "19:20ê¹Œì§€ ëŒ€ê¸° ë° ëª…ìƒ", role: "all" },
            { time: "19:50", title: "ì²´ì¡°", loc: "ëŒ€ê°•ì „ 1ì¸µ", note: "20:00ê¹Œì§€", role: "all" },
            { time: "20:00", title: "ì‚¬ìˆ˜ êµëŒ€", loc: "ë³„ê´€", note: "ì†Œê° ë°œí‘œ", role: "sasu" },
            { time: "20:00", title: "ììœ ì‹œê°„", loc: "-", note: "í˜¹ì€ ì¼ëŒ€ì¼ ë§Œë‚¨", role: "learner_only" },
            { time: "20:30", title: "ëª…ìƒ", loc: "ëŒ€ê°•ì „ 2ì¸µ", note: "21:10ê¹Œì§€ ì§„í–‰", role: "all" },
            { time: "21:30", title: "ì í˜¸", loc: "ëŒ€ê°•ì „ 1ì¸µ", note: "21:20ê¹Œì§€ ë„ì°©", role: "all" },
            { time: "22:30", title: "ë“œëŠ” ë´‰ì‹¬", loc: "ëŒ€ê°•ì „ 2ì¸µ ìŠ¹ì •ë¬¸ ì•", note: "22:20ê¹Œì§€ ì‹œë¦½", role: "all" },
            { time: "23:30", title: "í‡´ë°° ë´‰ì‹¬", loc: "ëŒ€ê°•ì „ 2ì¸µ ìŠ¹ì •ë¬¸", note: "23:20ê¹Œì§€ ì •ë ¬, í•˜ë£¨ ì¼ê³¼ ë§ˆë¬´ë¦¬", role: "all" },
            { time: "23:50", title: "í‡´ë°° ì¢…ë£Œ", loc: "ëŒ€ê°•ì „ 1ì¸µ", note: "ì¸ì‚¬ í›„ ê·€ê°€", role: "all" },
            { time: "24:00", title: "ì·¨ì¹¨", loc: "ìˆ™ì†Œ", note: "", role: "all" },
        ];

        // Data - Sunday Schedule
        const sundayItems = [
            // Saturday Night (Eve)
            { time: "23:30", title: "ìì‹œ ê¸°ë„ (ì „ë‚ )", loc: "ëŒ€ê°•ì „ 1ì¸µ", note: "ì£¼ì¼ ë“œëŠ” ë‚ , 23:20ê¹Œì§€ ëŒ€ê¸° ë° ëª…ìƒ", role: "all" },
            { time: "23:50", title: "ì·¨ì¹¨ (ì „ë‚ )", loc: "ìˆ™ì†Œ", note: "", role: "all" },
            // Sunday Morning
            { time: "01:30", title: "ì¶•ì‹œ ê¸°ë„", loc: "ëŒ€ê°•ì „ 1ì¸µ", note: "01:20ê¹Œì§€ ëŒ€ê¸° ë° ëª…ìƒ", role: "all" },
            { time: "01:50", title: "ì·¨ì¹¨", loc: "ìˆ™ì†Œ", note: "", role: "all" },
            { time: "05:20", title: "ê¸°ìƒ", loc: "-", note: "", role: "all" },
            { time: "05:30", title: "ë¬˜ì‹œ ê¸°ë„", loc: "ëŒ€ê°•ì „ 1ì¸µ", note: "05:20ê¹Œì§€ ëŒ€ê¸° ë° ëª…ìƒ", role: "all" },
            { time: "05:50", title: "ì·¨ì¹¨", loc: "ìˆ™ì†Œ", note: "í˜¹ì€ ê°ì í•  ì¼", role: "all" },
            { time: "07:15", title: "ê¸°ìƒ", loc: "-", note: "", role: "all" },
            { time: "07:30", title: "ì§„ì‹œ ê¸°ë„", loc: "ëŒ€ê°•ì „ 1ì¸µ", note: "07:20ê¹Œì§€ ëŒ€ê¸° ë° ëª…ìƒ", role: "all" },
            { time: "07:50", title: "ì•„ì¹¨ ì‹ì‚¬", loc: "ì‹ë‹¹", note: "", role: "all" },
            { time: "08:15", title: "ë°©ì¥ íšŒì˜", loc: "ë³„ê´€", note: "ì‚¬ìˆ˜ í•„ìˆ˜ ì°¸ì„", role: "sasu" },
            { time: "09:00", title: "ì²­ì†Œ", loc: "ì§€ì • êµ¬ì—­", note: "", role: "learner_only" },
            { time: "10:30", title: "ì˜¤ì „ ìˆ˜ë ¨", loc: "ëŒ€ê°•ì „ 2ì¸µ", note: "10:10ê¹Œì§€ ëŒ€ê¸°", role: "all" },
            { time: "11:30", title: "ì˜¤ì‹œ ê¸°ë„", loc: "ëŒ€ê°•ì „ 1ì¸µ", note: "", role: "all" },
            { time: "12:00", title: "ì ì‹¬ ì‹ì‚¬", loc: "ì‹ë‹¹", note: "", role: "all" },
            { time: "12:20", title: "í† ë¡ ", loc: "ì²­í•™ê´€", note: "", role: "all" },
            { time: "13:30", title: "ë¯¸ì‹œ ê¸°ë„", loc: "ëŒ€ê°•ì „ 1ì¸µ", note: "13:20ê¹Œì§€ ëŒ€ê¸° ë° ëª…ìƒ", role: "all" },
            { time: "14:00", title: "ì¼ëŒ€ì¼ ë§Œë‚¨", loc: "ì²­í•™ê´€", note: "", role: "all" },
            { time: "15:00", title: "ì¼ëŒ€ì¼ ë§Œë‚¨", loc: "ì²­í•™ê´€", note: "", role: "all" },
            { time: "16:30", title: "ì˜¤í›„ ìˆ˜ë ¨", loc: "ëŒ€ê°•ì „ 2ì¸µ", note: "16:10ê¹Œì§€ ëŒ€ê¸°", role: "all" },
            { time: "17:30", title: "ìœ ì‹œ ê¸°ë„", loc: "ëŒ€ê°•ì „ 1ì¸µ", note: "17:20ê¹Œì§€ ëŒ€ê¸° ë° ëª…ìƒ", role: "all" },
            { time: "18:00", title: "ì €ë… ì‹ì‚¬", loc: "ì‹ë‹¹", note: "", role: "all" },
            { time: "19:30", title: "ìˆ ì‹œ ê¸°ë„", loc: "ëŒ€ê°•ì „ 1ì¸µ", note: "19:20ê¹Œì§€ ëŒ€ê¸° ë° ëª…ìƒ", role: "all" },
            { time: "19:50", title: "ì²´ì¡°", loc: "ëŒ€ê°•ì „ 1ì¸µ", note: "20:00ê¹Œì§€", role: "all" },
            { time: "20:00", title: "ììœ ì‹œê°„", loc: "-", note: "í˜¹ì€ ì¼ëŒ€ì¼ ë§Œë‚¨", role: "all" },
            { time: "21:30", title: "ì í˜¸", loc: "ëŒ€ê°•ì „ 1ì¸µ", note: "21:20ê¹Œì§€ ë„ì°©", role: "all" },
            { time: "22:30", title: "ë“œëŠ” ë´‰ì‹¬", loc: "ëŒ€ê°•ì „ 2ì¸µ", note: "22:20ê¹Œì§€ ìŠ¹ì •ë¬¸ ì• ëŒ€ê¸°", role: "all" },
            { time: "23:30", title: "í‡´ë°° ë´‰ì‹¬", loc: "ëŒ€ê°•ì „ 2ì¸µ", note: "23:20ê¹Œì§€ ìŠ¹ì •ë¬¸ ì• ëŒ€ê¸°", role: "all" },
        ];

        let currentTab = 'schedule';
        let currentRoleFilter = 'all';

        function switchTab(tabId) {
            ['schedule', 'practice', 'simulator'].forEach(id => {
                const view = document.getElementById(`view-${id}`);
                const nav = document.getElementById(`nav-${id}`);
                if(view) view.classList.add('hidden');
                if(nav) {
                    nav.classList.remove('nav-active');
                }
            });

            document.getElementById(`view-${tabId}`).classList.remove('hidden');
            const activeNav = document.getElementById(`nav-${tabId}`);
            activeNav.classList.add('nav-active');
            
            // Auto scroll to top on tab switch
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            currentTab = tabId;

            if(tabId === 'practice') {
                setRoleFilter(currentRoleFilter);
            } else if (tabId === 'schedule') {
                renderSchedule();
            } else if (tabId === 'simulator') {
                if(ctx) simController.init();
            }
        }

        function getCurrentTimeInMinutes() {
            const now = new Date();
            return now.getHours() * 60 + now.getMinutes();
        }

        function timeStringToMinutes(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

        // --- Auto Sunday Detection Logic (Today is 1/21 -> Not Sunday) ---
        // 1/20 was Sunday cycle. 1/21 is weekday.
        function isSundayCycle() {
            // For demo purpose, hardcoded to false since 1/21 is not cycle day (1/20 was)
            return false;
        }

        // --- Toggle Sunday Mode Globally ---
        function toggleSundayMode(checked) {
            isGlobalSundayMode = checked;
            
            // Update UI elements
            const sundayToggle = document.getElementById('sunday-toggle');
            if(sundayToggle) sundayToggle.checked = checked;
            
            const practiceSundayToggle = document.getElementById('practice-sunday-toggle');
            if(practiceSundayToggle) practiceSundayToggle.checked = checked;

            // Re-render current view
            if(currentTab === 'schedule') renderSchedule();
            if(currentTab === 'practice') generateRitualTimeline();
        }

        function renderSchedule() {
            const container = document.getElementById('timeline-container');
            const isSasuMode = document.getElementById('sasu-toggle').checked;
            const nowMinutes = getCurrentTimeInMinutes();
            
            // Use Global Sunday Mode State
            let itemsToRender = isGlobalSundayMode ? [...sundayItems] : [...weekdayItems];
            
            // Sort items by time
            itemsToRender.sort((a, b) => a.time.localeCompare(b.time));

            const filteredData = itemsToRender.filter(item => {
                if (item.role === 'all') return true;
                if (item.role === 'sasu') return isSasuMode;
                if (item.role === 'learner_only') return !isSasuMode;
                return false;
            });
            
            let activeIndex = -1;
            for (let i = 0; i < filteredData.length; i++) {
                const itemTime = timeStringToMinutes(filteredData[i].time);
                if (nowMinutes >= itemTime) {
                    if (i < filteredData.length - 1) {
                        const nextItemTime = timeStringToMinutes(filteredData[i+1].time);
                        if (nowMinutes < nextItemTime) {
                            activeIndex = i;
                            break;
                        }
                    } else {
                        activeIndex = i;
                    }
                }
            }

            container.innerHTML = filteredData.map((item, index) => {
                const isSasuItem = item.role === 'sasu';
                const isActive = (index === activeIndex);
                
                let activeClass = isActive ? 'current-item' : 'bg-white border-l-4 border-transparent opacity-80 hover:opacity-100';
                let activeBadge = isActive ? `<div class="mb-2 text-sm font-bold text-point bg-red-50 inline-block px-3 py-1 rounded-full border border-red-100 animate-pulse">â° í˜„ì¬ ì§„í–‰ì¤‘</div>` : '';
                let titleColor = isActive ? 'text-ink' : 'text-sub';
                
                // Override for Sasu
                if (isSasuItem && !isActive) {
                    activeClass = 'bg-[#fff1f2] border-l-4 border-red-200';
                }

                return `
                <div class="relative pl-8 md:pl-10 py-3 animate-fade-in group" id="schedule-item-${index}">
                    <!-- Dot -->
                    <div class="absolute left-[13px] top-7 w-4 h-4 rounded-full ${isActive ? 'bg-point scale-125 ring-4 ring-red-100' : (isSasuItem ? 'bg-red-300' : 'bg-stone-300')} shadow-sm z-10 transition-all">
                    </div>
                    
                    <!-- Content Card -->
                    <div class="${activeClass} card-box p-5 md:p-6 transition-all">
                        ${activeBadge}
                        <div class="flex flex-col md:flex-row md:justify-between md:items-start gap-2">
                            <div>
                                <div class="flex items-center flex-wrap gap-2 mb-2">
                                    <span class="font-bold text-2xl ${isActive ? 'text-point' : 'text-stone-500'} font-serif tracking-tight">${item.time}</span>
                                    ${item.loc !== '-' ? `<span class="text-xs font-bold text-stone-500 bg-stone-100 px-2 py-1 rounded-full border border-stone-200">${item.loc}</span>` : ''}
                                </div>
                                <h3 class="text-xl font-bold ${titleColor} ${isSasuItem ? 'text-point' : ''}">
                                    ${item.title}
                                    ${isSasuItem ? '<span class="text-xs bg-red-100 text-point px-2 py-1 rounded-full ml-2 align-middle border border-red-200">ì‚¬ìˆ˜</span>' : ''}
                                </h3>
                            </div>
                        </div>
                        ${item.note ? `<p class="text-base text-sub font-medium mt-3 p-3 bg-stone-50 rounded-lg border border-stone-100 break-keep">ğŸ’¡ ${item.note}</p>` : ''}
                    </div>
                </div>
            `}).join('');
            
            if (activeIndex !== -1 && !window.hasScrolledToActive) {
                setTimeout(() => {
                    const el = document.getElementById(`schedule-item-${activeIndex}`);
                    if (el) {
                        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        window.hasScrolledToActive = true;
                    }
                }, 500);
            }
        }

        // --- Role Filter Logic (Defined globally) ---
        function setRoleFilter(role) {
            currentRoleFilter = role;
            
            // Minimal button styles
            const defaultStyle = "interactive-card text-lg rounded-xl text-stone-600 font-bold bg-white hover:text-point";
            
            // Custom role specific active colors
            const styles = {
                all: "text-lg rounded-xl transition-all border-2 border-ink bg-ink text-white font-bold shadow-md hover:opacity-90",
                member: "text-lg rounded-xl transition-all border-2 border-member bg-member text-white font-bold shadow-md",
                oesu: "text-lg rounded-xl transition-all border-2 border-oesu bg-oesu text-white font-bold shadow-md",
                naesu: "text-lg rounded-xl transition-all border-2 border-naesu bg-naesu text-white font-bold shadow-md"
            };

            ['all', 'member', 'oesu', 'naesu'].forEach(r => {
                const btn = document.getElementById(`btn-role-${r}`);
                if (r === role) {
                    btn.className = `py-4 ${styles[r]}`;
                } else {
                    btn.className = `py-4 ${defaultStyle}`;
                }
            });

            generateRitualTimeline();
        }

        function generateRitualTimeline() {
            const inputHour = document.getElementById('practice-hour').value;
            
            if (!inputHour) return;

            const hour = parseInt(inputHour);
            const date = new Date();
            date.setHours(hour, 0, 0, 0);

            const fmt = (d) => {
                let h = d.getHours();
                let m = d.getMinutes();
                return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
            };
            
            const addMin = (min) => {
                const newD = new Date(date.getTime());
                newD.setMinutes(date.getMinutes() + min);
                return fmt(newD);
            };

            const rawSteps = [
                { time: addMin(-15), title: "ì¤€ë¹„ ë° ì£¼ì„± ì—°ìŠµ", desc: "ëŒ€ê°•ì „ 1ì¸µ ë„ì°©, ì£¼ë¬¸ ì—°ìŠµ ì‹œì‘.", roleInfo: null },
                { time: addMin(20), title: "ì´ë™ ëŒ€ê¸° ë° ì¶œë°œ", desc: "ì£¼ë¬¸ ì—°ìŠµ ì¢…ë£Œ í›„ 3ì¸µìœ¼ë¡œ ì´ë™ ì¤€ë¹„.", highlight: true, roleInfo: { member: "1ì—´ (ê°€ì¥ ë¨¼ì € ì¶œë°œ)", oesu: "2ì—´ (íšŒì› ë’¤)", naesu: "3ì—´ (ë§ˆì§€ë§‰)" } },
                { 
                    time: addMin(25), 
                    title: "ê³µë¶€ë°© ì• ëŒ€ê¸° & ì…ì¥", 
                    desc: "ê³µë¶€ë°© ì• ë„ì°© ë° ì…ì¥. (íšŒì›ê³¼ í•¨ê»˜)", 
                    roleInfo: { 
                        member: "1ë²ˆ ì…ì¥", 
                        oesu: "ì• ì‹œê°„ ì‹ ë°œ ì •ë¦¬, ë¬¸ ì—´ê¸°, 3ë²ˆ ì…ì¥. ì…ì¥ í›„ ë¹„ì¹˜ëœ ê±¸ë ˆë¥¼ ì±™ê²¨ í•˜ë‚˜ëŠ” ë³¸ì¸ì´ ë“¤ê³ , í•˜ë‚˜ëŠ” ë‚´ìˆ˜ì—ê²Œ ì „ë‹¬.", 
                        naesu: "2ë²ˆ ì…ì¥" 
                    } 
                },
                { 
                    time: addMin(27), 
                    title: "êµëŒ€ ì‹ í˜¸ ë° ì…ì‹¤ ì¤€ë¹„", 
                    desc: `<span class="text-point font-bold">27ë¶„ 30ì´ˆ</span>ê²½ ê³µë¶€ êµëŒ€ ì‹ í˜¸(í—›ê¸°ì¹¨). <span class="text-point font-bold">27ë¶„ 50ì´ˆ</span> ì¢…ì´ ìš¸ë¦¬ë©´ ì…ì‹¤.`, 
                    roleInfo: { 
                        member: `â˜… <span class="text-point font-bold">30ì´ˆ</span> í¬ê²Œ í—›ê¸°ì¹¨ ì‹ í˜¸`, 
                        oesu: "ëŒ€ê¸°", 
                        naesu: "ëŒ€ê¸°" 
                    } 
                },
                { 
                    time: addMin(30), 
                    title: "ê³µë¶€ë°© ì…ì‹¤", 
                    desc: "ì¢…ì´ ìš¸ë¦¬ë©´ ë°©ìœ¼ë¡œ ë“¤ì–´ê°‘ë‹ˆë‹¤. (íšŒì›ì„ ì¤‘ì‹¬ìœ¼ë¡œ)", 
                    roleInfo: { 
                        member: "1ë²ˆ ì…ì¥. í–¥ ë¶ˆ ë¶™ì´ê¸°. ì¢Œë°° ì£¼ë„.", 
                        oesu: "3ë²ˆ ì…ì¥. ì†Œë…/ì²­ì†Œ. ê±¸ë ˆ ë’·ì‚¬ëŒ ì „ë‹¬.", 
                        naesu: "2ë²ˆ ì…ì¥. ì™¸ê³½ ì´ë™. ì†Œë…/ì²­ì†Œ. ê±¸ë ˆ ë’·ì‚¬ëŒ ì „ë‹¬." 
                    } 
                },
                { 
                    time: addMin(88), 
                    title: "í‡´ì‹¤ ì¤€ë¹„", 
                    desc: "ë‹¤ìŒ íƒ€ì„ êµëŒ€ ë° í‡´ì‹¤ (28ë¶„ê²½). <br><span class='text-point font-bold'>ëˆˆì„ ëœ¨ê³  ì£¼ì„± ì†ë„ë¥¼ ì¡°ì ˆ</span>í•©ë‹ˆë‹¤. ì‹¬ê³ í•  ë•Œë„ ëˆˆì„ ëœ¨ê³  íšŒì›ì˜ ë™ì‘ì— ë§ì¶¥ë‹ˆë‹¤.", 
                    roleInfo: { member: "ì¢Œë°°. ë¨¼ì € ë’¤ë¡œ ì´ë™.", oesu: "ë‚˜ì¤‘ ì´ë™.", naesu: "ë¨¼ì € ì´ë™." } 
                },
                { time: addMin(90), title: "ì¢…ë£Œ ë° í•´ì‚°", desc: "ë¬¸ë‹¨ì† í›„ 1ì¸µì—ì„œ ì¸ì‚¬ (30ë¶„).", roleInfo: { member: "1ì¸µ ì´ë™.", oesu: "â˜… ë°”ê¹¥ ë¬¸ ë‹«ê¸°", naesu: "â˜… ì•ˆìª½ ë¬¸ ë‹«ê¸°" } }
            ];

            // --- ADDED LOGIC FOR SPECIAL STUDY TIMES (Now using isGlobalSundayMode for future logic) ---
            const h = parseInt(hour);
            if (h === 1 || h === 13) {
                // 1ì‹œ ê³µë¶€ì
                
                rawSteps.push({ 
                    time: addMin(90), // 1:00 + 90m = 2:30
                    title: "ë³´ì¶© ê¸°ë„ (1ì‹œ ê³µë¶€ì)",
                    desc: "ê³µë¶€ë¥¼ ë§ˆì¹˜ê³  ëŒ€ê°•ì „ 1ì¸µì—ì„œ 2:30ìœ¼ë¡œ ë³´ì¶©ê¸°ë„ë¥¼ ëª¨ì‹­ë‹ˆë‹¤. (ì˜¤í›„ì—ëŠ” 14:30)",
                    roleInfo: null,
                    special: true
                });
            }
            if (h === 5 || h === 17) {
                // 5ì‹œ ê³µë¶€ì
                rawSteps.push({
                    time: addMin(90), // 6:30
                    title: "ì €ë… ì‹ì‚¬ (5ì‹œ ê³µë¶€ì)",
                    desc: "ê³µë¶€ë¥¼ ë§ˆì¹˜ê³  ë‚˜ì™€ì„œ ì €ë… ì‹ì‚¬ë¥¼ í•©ë‹ˆë‹¤. (18:30~)",
                    roleInfo: null,
                    special: true
                });
            }
            if (h === 7 || h === 19) {
                // 7ì‹œ ê³µë¶€ì
                rawSteps.push({
                    time: addMin(90), // 8:30
                    title: "ë³´ì¶© ê¸°ë„ (7ì‹œ ê³µë¶€ì)",
                    desc: "ëŒ€ê°•ì „ 1ì¸µì—ì„œ ë³´ì¶©ê¸°ë„ë¥¼ ëª¨ì‹­ë‹ˆë‹¤. (08:30~08:45 / 20:30~20:45)",
                    roleInfo: null,
                    special: true
                });
                rawSteps.push({
                    time: addMin(105), // 8:45
                    title: "ì•„ì¹¨ ì‹ì‚¬ (7ì‹œ ê³µë¶€ì)",
                    desc: "ë³´ì¶©ê¸°ë„ í›„ ì•„ì¹¨ ì‹ì‚¬ë¥¼ í•©ë‹ˆë‹¤. (08:45~09:10)",
                    roleInfo: null,
                    special: true
                });
            }
            if (h === 11 || h === 23) {
                // 11ì‹œ ê³µë¶€ì
                rawSteps.push({
                    time: addMin(90), // 12:30
                    title: "ì ì‹¬ ì‹ì‚¬ (11ì‹œ ê³µë¶€ì)",
                    desc: "ê³µë¶€ë¥¼ ë§ˆì¹˜ê³  ë‚˜ì™€ì„œ ì ì‹¬ì„ ë¨¹ìŠµë‹ˆë‹¤. (12:30~)",
                    roleInfo: null,
                    special: true
                });
            }
            
            // Sort steps by time just in case
            rawSteps.sort((a,b) => a.time.localeCompare(b.time));

            const container = document.getElementById('ritual-steps');
            
            container.innerHTML = rawSteps.map(step => {
                let roleHTML = '';
                
                if (currentRoleFilter !== 'all' && step.roleInfo) {
                    const info = step.roleInfo[currentRoleFilter];
                    if (info) {
                        let colorClass = 'bg-stone-50 text-stone-700';
                        if(currentRoleFilter === 'member') colorClass = 'bg-amber-50 text-amber-900 border-l-4 border-member';
                        if(currentRoleFilter === 'oesu') colorClass = 'bg-blue-50 text-blue-900 border-l-4 border-oesu';
                        if(currentRoleFilter === 'naesu') colorClass = 'bg-red-50 text-red-900 border-l-4 border-naesu';

                        roleHTML = `<div class="mt-4 p-5 rounded-r-xl border-l-4 text-lg font-bold shadow-sm ${colorClass}">${info}</div>`;
                    }
                } else if (currentRoleFilter === 'all' && step.roleInfo) {
                    roleHTML = `
                        <div class="mt-4 space-y-3 text-base">
                            <div class="flex gap-3 items-start"><span class="shrink-0 w-14 text-center bg-member text-white font-bold text-sm px-1 py-1 rounded">íšŒì›</span> <span class="text-stone-700 font-medium pt-0.5">${step.roleInfo.member}</span></div>
                            <div class="flex gap-3 items-start"><span class="shrink-0 w-14 text-center bg-oesu text-white font-bold text-sm px-1 py-1 rounded">ì™¸ìˆ˜</span> <span class="text-stone-700 font-medium pt-0.5">${step.roleInfo.oesu}</span></div>
                            <div class="flex gap-3 items-start"><span class="shrink-0 w-14 text-center bg-naesu text-white font-bold text-sm px-1 py-1 rounded">ë‚´ìˆ˜</span> <span class="text-stone-700 font-medium pt-0.5">${step.roleInfo.naesu}</span></div>
                        </div>
                    `;
                }

                // Highlight special added steps
                let borderClass = step.special ? 'border-l-4 border-point' : 'border-l-4 border-stone-200';
                let dotClass = step.special ? 'bg-point ring-4 ring-red-100' : 'bg-stone-300';

                return `
                <div class="flex gap-4 group mb-4">
                    <div class="w-20 text-right pt-2 hidden md:block">
                        <span class="font-bold text-stone-500 font-serif text-2xl tracking-tighter">${step.time}</span>
                    </div>
                    <div class="relative flex-grow ${borderClass} pl-6 pb-12 last:pb-0">
                        <!-- Dot -->
                        <div class="absolute -left-[10px] top-3 w-5 h-5 rounded-full ${dotClass} border-2 border-white shadow-sm transition-colors"></div>
                        
                        <div class="card-box p-6 hover:border-point transition-colors">
                            <div class="md:hidden font-bold text-stone-500 font-serif text-xl mb-1">${step.time}</div>
                            <h4 class="font-bold text-ink text-xl font-serif mb-2">${step.title}</h4>
                            <p class="text-lg text-sub font-medium leading-relaxed break-keep">${step.desc}</p>
                            ${roleHTML}
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        // --- Simulator Engine ---
        const canvas = document.getElementById('simCanvas');
        let ctx = null;
        if(canvas) ctx = canvas.getContext('2d');
        
        const C_MEMBER = '#d97706';
        const C_OESU = '#2563eb';
        const C_NAESU = '#dc2626';

        // Steps for Animation
        const simSteps = [
            {
                text: "1. ê³µë¶€ ì§„í–‰ ì¤‘ (í˜„ì¬ ì‹œê°„)",
                setup: (s) => {
                    // Room (Right Side, 0-500 width relative coords, but let's shift)
                    // Let's redefine coord system: 
                    // Room: x 100 to 500 (400x500 box)
                    // Corridor: x 0 to 100 (100x500 box)
                    // Door: x=100, y=250 (Gap 230~270)
                    
                    // Current Team (Seated)
                    s.p_oesu = {x: 200, y: 150, label: 'í˜„ ì™¸ìˆ˜', c: C_OESU};
                    s.p_member = {x: 300, y: 150, label: 'í˜„ íšŒì›', c: C_MEMBER};
                    s.p_naesu = {x: 400, y: 150, label: 'í˜„ ë‚´ìˆ˜', c: C_NAESU};
                    
                    // Next Team (Waiting in Corridor)
                    // Requested: Oesu & Member ABOVE door, Naesu BELOW door.
                    // Door gap is ~230 to 270.
                    
                    s.n_oesu = {x: 40, y: 150, label: 'ë‹¤ìŒ ì™¸ìˆ˜', c: C_OESU, alpha: 1};   // Above
                    s.n_member = {x: 40, y: 200, label: 'ë‹¤ìŒ íšŒì›', c: C_MEMBER, alpha: 1}; // Above, closer to door
                    s.n_naesu = {x: 40, y: 320, label: 'ë‹¤ìŒ ë‚´ìˆ˜', c: C_NAESU, alpha: 1};   // Below door
                }
            },
            {
                text: "2. êµëŒ€ ì¤€ë¹„: íšŒì›ê³¼ ë‚´ìˆ˜ í›„í‡´",
                desc: "ì¢…ì´ ìš¸ë¦¬ë©´ íšŒì›ê³¼ ë‚´ìˆ˜ëŠ” ë’¤ë¡œ ë¬¼ëŸ¬ë‚˜ ì•ìë¦¬ë¥¼ ë¹„ì›ë‹ˆë‹¤. ì™¸ìˆ˜ëŠ” ê°€ë§Œíˆ ìˆìŠµë‹ˆë‹¤.",
                animate: (s, p) => {
                    s.p_member.y = lerp(150, 350, p);
                    s.p_naesu.y = lerp(150, 350, p);
                }
            },
            {
                text: "3. ë‹¤ìŒ íšŒì› ì…ì¥",
                desc: "ë‹¤ìŒ íšŒì›ì´ ë“¤ì–´ì™€ ì™¸ìˆ˜ ë’¤ë¥¼ ëŒì•„ ì¤‘ì•™ ìë¦¬ë¡œ ê°‘ë‹ˆë‹¤.",
                animate: (s, p) => {
                    // Path: Wait(40, 200) -> Door(100, 250) -> Behind Oesu(200, 250) -> Seat(300, 150)
                    
                    if(p < 0.2) {
                        // Move to Door
                        const lp = p / 0.2;
                        s.n_member.x = lerp(40, 120, lp);
                        s.n_member.y = lerp(200, 250, lp);
                    } else if (p < 0.5) {
                        // Enter & Walk behind Oesu
                        const lp = (p - 0.2) / 0.3;
                        s.n_member.x = lerp(120, 300, lp);
                        s.n_member.y = 250;
                    } else {
                        // Move to Seat
                        const lp = (p - 0.5) / 0.5;
                        s.n_member.x = 300;
                        s.n_member.y = lerp(250, 150, lp);
                    }
                }
            },
            {
                text: "4. ë‹¤ìŒ ë‚´ìˆ˜ ì…ì¥",
                desc: "ë‹¤ìŒ ë‚´ìˆ˜ê°€ ë“¤ì–´ì™€ ê¸°ì¡´ ì¸ì›ë“¤ì˜ ë“± ë’¤ë¥¼ ì§€ë‚˜, ì˜¤ë¥¸ìª½ ëìœ¼ë¡œ í¬ê²Œ ëŒì•„ ìë¦¬ë¡œ ê°‘ë‹ˆë‹¤.",
                animate: (s, p) => {
                    // Start: (40, 320)
                    // Obstacles: Old Member(300, 350), Old Naesu(400, 350)
                    // Path: Door -> Deep Back (y=450) -> Far Right (x=460) -> Up (y=150) -> Seat (400, 150)
                    
                    if(p < 0.15) {
                        // 1. To Door
                        const lp = p / 0.15;
                        s.n_naesu.x = lerp(40, 120, lp);
                        s.n_naesu.y = lerp(320, 250, lp);
                    } else if (p < 0.35) {
                        // 2. Go Deep Back (Behind existing people)
                        const lp = (p - 0.15) / 0.2;
                        s.n_naesu.x = lerp(120, 180, lp);
                        s.n_naesu.y = lerp(250, 450, lp); 
                    } else if (p < 0.65) {
                        // 3. Go Across to Far Right
                        const lp = (p - 0.35) / 0.3;
                        s.n_naesu.x = lerp(180, 460, lp);
                        s.n_naesu.y = 450;
                    } else if (p < 0.85) {
                        // 4. Move Up (Right side of room)
                        const lp = (p - 0.65) / 0.2;
                        s.n_naesu.x = 460;
                        s.n_naesu.y = lerp(450, 150, lp);
                    } else {
                        // 5. Move Left into Seat
                        const lp = (p - 0.85) / 0.15;
                        s.n_naesu.x = lerp(460, 400, lp);
                        s.n_naesu.y = 150;
                    }
                }
            },
            {
                text: "5. ì™¸ìˆ˜ êµëŒ€",
                desc: "ì´ì „ ì™¸ìˆ˜ê°€ ë’¤ë¡œ ë¬¼ëŸ¬ë‚˜ê³ , ë‹¤ìŒ ì™¸ìˆ˜ê°€ ë¬¸ì„ ë‹«ìœ¼ë©° ë“¤ì–´ì™€ ì•‰ìŠµë‹ˆë‹¤.",
                animate: (s, p) => {
                    // 1. Old Oesu retreats (0.0-0.3)
                    // 2. New Oesu enters (0.3-1.0)
                    
                    if(p < 0.3) {
                        const lp = p / 0.3;
                        s.p_oesu.y = lerp(150, 350, lp);
                    } else {
                        s.p_oesu.y = 350;
                        
                        const lp = (p - 0.3) / 0.7;
                        // Path: Wait(40, 150) -> Door(100, 250) -> Seat(200, 150)
                        if(lp < 0.3) {
                            s.n_oesu.x = lerp(40, 120, lp/0.3);
                            s.n_oesu.y = lerp(150, 250, lp/0.3);
                        } else {
                            s.n_oesu.x = lerp(120, 200, (lp-0.3)/0.7);
                            s.n_oesu.y = lerp(250, 150, (lp-0.3)/0.7);
                        }
                    }
                }
            },
            {
                text: "ì™„ë£Œ: ê³µë¶€ ì‹œì‘ / í‡´ì‹¤",
                desc: "ìƒˆë¡œìš´ ì¡°ê°€ ìë¦¬ë¥¼ ì¡ì•˜ìŠµë‹ˆë‹¤. ì´ì „ ì¡°ëŠ” í‡´ì‹¤í•©ë‹ˆë‹¤.",
                animate: (s, p) => {
                    s.p_member.alpha = 1 - p;
                    s.p_oesu.alpha = 1 - p;
                    s.p_naesu.alpha = 1 - p;
                }
            }
        ];

        const simController = {
            stepIndex: 0,
            progress: 0,
            isPlaying: false,
            lastTime: 0,
            state: {},
            
            init: function() {
                this.reset();
                requestAnimationFrame((t) => this.loop(t));
            },
            
            reset: function() {
                this.stepIndex = 0;
                this.progress = 0;
                this.isPlaying = false;
                simSteps[0].setup(this.state);
                this.draw();
                this.updateText();
            },
            
            next: function() {
                if (this.stepIndex < simSteps.length - 1) {
                    if(simSteps[this.stepIndex].animate) simSteps[this.stepIndex].animate(this.state, 1.0);
                    this.stepIndex++;
                    this.progress = 0;
                    this.updateText();
                    this.draw();
                }
            },
            
            prev: function() {
                if (this.stepIndex > 0) {
                    this.stepIndex--;
                    this.progress = 0;
                    simSteps[0].setup(this.state);
                    for(let i=1; i<this.stepIndex; i++) {
                        if(simSteps[i].animate) simSteps[i].animate(this.state, 1.0);
                    }
                    this.updateText();
                    this.draw();
                }
            },
            
            play: function() {
                this.isPlaying = !this.isPlaying;
            },
            
            updateText: function() {
                const el = document.getElementById('step-description');
                const step = simSteps[this.stepIndex];
                el.innerHTML = `<span class="block text-sm text-point font-bold mb-2">STEP ${this.stepIndex}</span>${step.text}<br><span class="text-base font-normal text-sub">${step.desc || ''}</span>`;
            },
            
            loop: function(timestamp) {
                const dt = timestamp - this.lastTime;
                this.lastTime = timestamp;
                
                if (this.isPlaying) {
                    this.progress += dt * 0.0005;
                    if (this.progress >= 1) {
                        this.progress = 1;
                        if(this.stepIndex < simSteps.length - 1) {
                            this.next();
                        } else {
                            this.isPlaying = false;
                        }
                    }
                    if(simSteps[this.stepIndex].animate) {
                        simSteps[this.stepIndex].animate(this.state, this.progress);
                    }
                    this.draw();
                }
                requestAnimationFrame((t) => this.loop(t));
            },

            draw: function() {
                if(!ctx) return;
                ctx.clearRect(0, 0, 500, 500);
                
                // Draw Corridor Area (Left 100px)
                ctx.fillStyle = '#f5f5f4'; // Light corridor color (stone-100)
                ctx.fillRect(0, 0, 100, 500);
                
                // Draw Room Area (Right 400px)
                // Grid
                ctx.strokeStyle = '#e7e5e4'; // stone-200
                ctx.lineWidth = 1;
                ctx.beginPath();
                for(let i=100; i<500; i+=50) {
                    ctx.moveTo(i, 0); ctx.lineTo(i, 500);
                }
                for(let i=0; i<500; i+=50) {
                    ctx.moveTo(100, i); ctx.lineTo(500, i);
                }
                ctx.stroke();
                
                // Wall separator
                ctx.strokeStyle = '#57534e'; // stone-600 (darker for clarity)
                ctx.lineWidth = 4;
                ctx.beginPath();
                ctx.moveTo(100, 0); ctx.lineTo(100, 230); // Top wall
                ctx.moveTo(100, 270); ctx.lineTo(100, 500); // Bottom wall
                ctx.stroke();
                
                // Door open/close visual (Optional)
                // Just gap is fine

                const drawBall = (obj) => {
                    if (obj.alpha === 0) return;
                    ctx.globalAlpha = obj.alpha !== undefined ? obj.alpha : 1;
                    ctx.fillStyle = obj.c;
                    ctx.beginPath();
                    // Increased Radius from 18 to 22
                    ctx.arc(obj.x, obj.y, 22, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.strokeStyle = '#fff';
                    ctx.lineWidth = 3; // Thicker border for contrast
                    ctx.stroke();
                    ctx.fillStyle = '#fff';
                    ctx.font = 'bold 11px Noto Sans KR'; // Bold font
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    let short = obj.label.includes('íšŒì›') ? 'íšŒ' : (obj.label.includes('ì™¸ìˆ˜') ? 'ì™¸' : 'ë‚´');
                    // Changed Labels to Korean
                    ctx.fillText(obj.label.includes('ë‹¤ìŒ') ? 'ë‹¤ìŒ' : 'ê¸°ì¡´', obj.x, obj.y - 9);
                    ctx.fillText(short, obj.x, obj.y + 7);
                    ctx.globalAlpha = 1;
                };

                drawBall(this.state.p_oesu);
                drawBall(this.state.p_member);
                drawBall(this.state.p_naesu);
                
                drawBall(this.state.n_member);
                drawBall(this.state.n_naesu);
                drawBall(this.state.n_oesu);
            }
        };
        
        function lerp(start, end, t) {
            return start * (1 - t) + end * t;
        }

        // Initialization
        window.onload = function() {
            renderSchedule();
            generateRitualTimeline();
        }
    </script>
</body>
</html>
