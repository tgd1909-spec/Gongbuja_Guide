<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>입소 및 준비 과정 | 공부자 가이드</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts Import -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Noto+Serif+KR:wght@500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'k-bg': '#fdfbf7',
                        'k-text': '#1a1a1a',
                        'theme-color': '#d97706', // 살구색 (Apricot)
                        'theme-soft': '#fff7ed',  // 연한 살구색 배경
                        'hanji-dot': '#e6e2d3',
                    },
                    fontFamily: {
                        serif: ['"Noto Serif KR"', 'serif'],
                        sans: ['"Noto Sans KR"', 'sans-serif'],
                    },
                    backgroundImage: {
                        'hanji-pattern': 'radial-gradient(#e6e2d3 1px, transparent 1px)',
                    },
                    boxShadow: {
                        'card': '0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03)',
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <style>
        /* 기본 설정 */
        body {
            background-size: 24px 24px;
            word-break: keep-all;
        }

        /* 부드러운 전환 효과 */
        .transition-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* 시뮬레이터 노드 전환 (애니메이션 핵심) */
        .formation-node, .exit-node {
            transition: all 0.8s cubic-bezier(0.34, 1.1, 0.64, 1);
        }

        /* 스크롤바 스타일 */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #d6d3d1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a29e;
        }

        /* 드롭다운(Details) 애니메이션 */
        details > summary {
            list-style: none;
        }
        details > summary::-webkit-details-marker {
            display: none;
        }
        
        /* 세로 쓰기 */
        .writing-vertical {
            writing-mode: vertical-rl;
            text-orientation: mixed;
        }
        
        /* 시뮬레이터 화살표 머리 */
        .arrow-path::after {
            content: '';
            position: absolute;
            right: -6px; 
            bottom: -5px; 
            width: 0; 
            height: 0; 
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
            border-left: 10px solid #d97706; 
        }

        /* 시뮬레이터 시작점 */
        .arrow-path::before {
            content: '';
            position: absolute;
            left: -4px;
            top: -4px;
            width: 8px;
            height: 8px;
            background-color: #d97706; 
            border-radius: 50%;
        }
        
        html {
            scroll-behavior: smooth;
        }
        
        /* 아코디언 펼침 효과 */
        details[open] summary ~ * {
            animation: slideDown 0.3s ease-out;
        }
        @keyframes slideDown {
            0% { opacity: 0; transform: translateY(-10px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        /* 탭 활성화 스타일 */
        .tab-btn.active {
            background-color: #d97706;
            color: white;
            font-weight: 700;
            border-color: #d97706;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
            animation: fadeIn 0.4s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="font-sans text-k-text antialiased text-lg bg-k-bg bg-hanji-pattern relative">

    <!-- 헤더 -->
    <header class="sticky top-0 z-50 w-full bg-white/95 border-b border-stone-200 shadow-sm h-20" id="main-header">
        <div class="max-w-4xl mx-auto px-6 h-full flex items-center justify-between">
            <div class="flex flex-col justify-center h-full pt-1">
                <div class="flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 text-theme-color">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9" />
                    </svg>
                    <h1 class="text-2xl font-serif font-bold tracking-tight text-k-text">입소 및 준비 과정</h1>
                </div>
                <div class="w-full h-1 bg-theme-color mt-1 rounded-full opacity-80"></div>
            </div>

            <!-- 홈버튼 수정됨 -->
            <a href="index.html" class="flex items-center gap-2 px-4 py-2 bg-stone-50 hover:bg-stone-100 text-k-text font-bold rounded-full border border-stone-200 transition-colors shadow-sm group">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 text-stone-400 group-hover:text-theme-color transition-colors">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
                </svg>
                <span class="font-serif text-sm">홈으로</span>
            </a>
        </div>
    </header>

    <!-- 메인 컨테이너 -->
    <main class="max-w-4xl mx-auto mt-6 mb-16 px-4 md:px-6 py-8 bg-white/90 backdrop-blur-sm border border-stone-200 rounded-xl shadow-lg min-h-screen">

        <!-- 인트로 섹션 -->
        <section class="mb-10">
            <div class="bg-white p-6 md:p-8 border border-stone-100 rounded-xl shadow-card">
                <h2 class="text-3xl md:text-5xl font-serif font-bold text-k-text mb-4 leading-tight">
                    환영합니다.<br>
                    <span class="text-theme-color">공부의 시작</span>을 안내합니다.
                </h2>
                <p class="text-lg md:text-xl text-stone-600 leading-relaxed mb-6 font-medium">
                    본부 도착부터 <strong class="text-theme-color border-b-2 border-theme-color/30 px-1">'드는 봉심'</strong>까지의 순서입니다.<br>
                    아래 단계(Step)를 순서대로 눌러 확인해 주세요.
                </p>

                <!-- 준비물 (요약) -->
                <div class="bg-theme-soft/50 p-4 rounded-lg border border-theme-color/10 flex items-start gap-4">
                    <span class="flex-shrink-0 w-12 h-12 flex items-center justify-center bg-white rounded-full text-theme-color border border-theme-color/20 shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 10.5V6a3.75 3.75 0 10-7.5 0v4.5m11.356-1.993l1.263 12c.07.665-.45 1.243-1.119 1.243H4.25a1.125 1.125 0 01-1.12-1.243l1.264-12A1.125 1.125 0 015.513 7.5h12.974c.576 0 1.059.435 1.119 1.007zM8.625 10.5a.375.375 0 11-.75 0 .375.375 0 01.75 0zm7.5 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
                        </svg>
                    </span>
                    <div>
                        <strong class="block text-theme-color font-bold text-lg mb-1">필수 준비물 챙기셨나요?</strong>
                        <p class="text-stone-700 text-base">한복, 세면도구, 흰신발, 개인 컵, 상비약</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- 단계별 아코디언 리스트 -->
        <div id="steps-container" class="space-y-4">
            <!-- JS로 내용 주입됨 -->
        </div>

    </main>

    <!-- 공통 푸터 -->
    <div class="text-center py-8 text-stone-400 text-sm font-medium">
        &copy; Gongbu Guide. All rights reserved.
    </div>

    <!-- 플로팅 버튼 (우측 하단 고정) -->
    <div class="fixed bottom-8 right-8 z-50 flex flex-col gap-3">
        <!-- Top Scroll -->
        <button onclick="window.scrollTo({top: 0, behavior: 'smooth'})" class="p-3 bg-white border-2 border-stone-200 rounded-full shadow-lg text-theme-color hover:bg-theme-color hover:text-white hover:border-theme-color transition-all duration-300 group" aria-label="맨 위로">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" />
            </svg>
        </button>
        <!-- Bottom Scroll -->
        <button onclick="window.scrollTo({top: document.body.scrollHeight, behavior: 'smooth'})" class="p-3 bg-white border-2 border-stone-200 rounded-full shadow-lg text-theme-color hover:bg-theme-color hover:text-white hover:border-theme-color transition-all duration-300 group" aria-label="맨 아래로">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
            </svg>
        </button>
    </div>

    <!-- JavaScript 로직 -->
    <script>
        const phases = [
            {
                id: 0,
                title: "도착 및 준비",
                timeRange: "20:00 ~ 21:20",
                description: "본부에 도착하여 행정 절차를 마치고 몸과 마음을 정돈하는 시간입니다.",
                steps: [
                    { time: "20:00 이전", title: "본부 도착 및 국궁", desc: "도착 즉시 <strong>대강전 앞마당</strong>에서 국궁(인사)을 드립니다. 이후 정급실에서 숙소를 배정받고 휴대폰을 제출합니다. <span class='text-theme-color font-bold bg-theme-soft px-1 rounded'>알람을 끄고 제출해 주세요.</span>" },
                    { time: "20:10", title: "환복", desc: "숙소에 짐을 풀고 정갈한 한복으로 갈아입습니다." },
                    { time: "20:30", title: "공지사항 청취", desc: "사무실에서 전달하는 중요 공지사항을 듣습니다." },
                    { time: "21:20 전", title: "혈압 체크", desc: "점호 전까지 <strong class='text-theme-color'>'청학관'</strong>에서 반드시 혈압을 측정하고 기재를 완료합니다." }
                ]
            },
            {
                id: 1,
                title: "점호",
                timeRange: "21:20 ~ 22:20",
                description: "인원 점검을 마치고, 입소 의식인 '드는 봉심'을 위해 경건하게 준비합니다.",
                steps: [
                    { time: "21:20 까지", title: "대기 완료", desc: "대강전 1층에 도착하여 대기합니다. <strong>점호시 다다미 2칸에 3명 시립합니다.</strong><br><br><ul class='list-disc list-inside space-y-1 pl-1 text-stone-600'><li>회원은 시간표의 번호 확인 후 정렬</li><li>외수/내수는 공부 시간에 맞게 정렬</li></ul>" },
                    { time: "21:30", title: "점호 진행", desc: "대강전 1층에서 전체 점호를 실시합니다.<br><span class='text-theme-color font-bold bg-theme-soft px-1 rounded inline-block my-2'>주의: 호명 시 고개를 숙이지 않고 바른 자세로 '네'하고 답합니다.</span><br><div class='bg-stone-50 p-4 rounded-lg border border-stone-200 mt-2'><strong class='block text-theme-color mb-2'>[진행 순서]</strong><ol class='list-decimal list-inside space-y-1.5 text-stone-700 font-medium'><li><strong>호명</strong></li><li><strong>향전배례</strong> (구령에 맞춰 배례)</li><li><strong>공지사항 청취</strong> (시학원의 지시에 따라)</li><li><strong>좌배 후 일동 흥, 국궁, 예필 퇴</strong> 순으로 진행</li></ol></div>" }
                ]
            },
            {
                id: 2,
                title: "드는 봉심",
                timeRange: "22:20 ~ 종료",
                description: "공부의 시작을 알리는 가장 중요한 의식입니다. 복잡한 이동과 예법이 있으니 주의 깊게 확인하세요.",
                isBongsim: true, // 플래그: 봉심 단계는 탭 UI 사용
                tabs: [
                    { id: 'enter', label: '1. 입장' },
                    { id: 'bow', label: '2. 봉심' },
                    { id: 'exit', label: '3. 퇴장' }
                ],
                content: {
                    'enter': `
                        <div class="space-y-6">
                            <!-- 중요 수칙 강조 박스 (애니메이션 제거됨) -->
                            <div class="bg-red-50 border-l-4 border-red-500 p-5 rounded-r-lg shadow-sm">
                                <h4 class="flex items-center gap-2 text-red-700 font-bold text-lg mb-3">
                                    <span class="text-2xl">⚠️</span> [필독] 입장 시 절대 수칙
                                </h4>
                                <ul class="space-y-2 text-red-800 font-medium">
                                    <li class="flex items-start gap-2">
                                        <span class="mt-1">👣</span>
                                        <span><strong>왼발 먼저:</strong> 문턱을 넘을 때는 반드시 왼발부터 넘습니다.</span>
                                    </li>
                                    <li class="flex items-start gap-2">
                                        <span class="mt-1">📐</span>
                                        <span><strong>직각 보행:</strong> 이동 시 각을 지켜 보행합니다.</span>
                                    </li>
                                    <li class="flex items-start gap-2">
                                        <span class="mt-1">🙏</span>
                                        <span><strong>국궁 유지:</strong> 입장부터 '정렬 취석 면수' 구령 전까지 국궁 자세를 유지합니다.</span>
                                    </li>
                                </ul>
                            </div>

                            <!-- 절차 리스트 -->
                            <div class="space-y-4">
                                <div class="bg-white p-5 rounded-xl border border-stone-200">
                                    <div class="flex items-center justify-between mb-2">
                                        <strong class="text-theme-color text-xl font-bold">1. 시립 및 대기</strong>
                                        <span class="text-sm font-medium text-stone-400">22:20 경</span>
                                    </div>
                                    <p class="text-stone-700 mb-2"><strong>장소:</strong> 대강전 2층 승정문 앞</p>
                                    <p class="text-stone-700"><strong>대형:</strong> 3열 종대 (회원 - 외수 - 내수 순)</p>
                                </div>

                                <div class="bg-white p-5 rounded-xl border border-stone-200">
                                    <div class="flex items-center justify-between mb-2">
                                        <strong class="text-theme-color text-xl font-bold">2. 3층으로 이동</strong>
                                        <span class="text-sm font-medium text-stone-400">22:28 경</span>
                                    </div>
                                    <p class="text-stone-700 mb-3">소종이 울리면 시학원의 구령에 따라 이동합니다.</p>
                                    <div class="bg-stone-50 p-3 rounded-lg border border-stone-200 text-center">
                                        <span class="block text-sm text-stone-400 mb-1">시학원 구령</span>
                                        <span class="font-serif font-bold text-lg text-theme-color">"정렬 면수" → "1열 앞으로(회원)" → "2열 앞으로(외수)"  → "3열 앞으로(내수)"</span>
                                    </div>
                                </div>

                                <div class="bg-white p-5 rounded-xl border border-stone-200">
                                    <strong class="block text-theme-color text-xl font-bold mb-2">3. 대동문 앞 정렬</strong>
                                    <p class="text-stone-700 mb-1"><strong>장소:</strong> 3층 대강전 대동문 앞</p>
                                    <p class="text-stone-700 mb-1"><strong>대형:</strong> 2층과 동일한 순서(회원-외수-내수)</p>
                                    <p class="text-stone-700"><strong>시학원:</strong> 맨 앞 중앙에서 대동문을 등지고 전체를 바라봄</p>
                                </div>

                                <div class="bg-white p-5 rounded-xl border border-stone-200">
                                    <strong class="block text-theme-color text-xl font-bold mb-2">4. 영대 입장</strong>
                                    <div class="bg-stone-50 p-3 rounded-lg border border-stone-200 text-center mb-3">
                                        <span class="block text-sm text-stone-400 mb-1">시학원 구령</span>
                                        <span class="font-serif font-bold text-lg text-theme-color">"국궁 ~ 1열 앞으로 나솨"</span>
                                    </div>
                                    <p class="text-stone-700 mb-2"><strong>행동:</strong> 전원 국궁 자세 취함 → 회원 줄부터 대동문 통과 → 영대 진입</p>
                                    <p class="text-stone-600 bg-theme-soft/50 p-2 rounded text-sm">📍 <strong>위치:</strong> 영대 앞 다다미 1장에 2명씩 정렬</p>
                                </div>
                            </div>
                        </div>
                    `,
                    'bow': `
                        <div class="space-y-8">
                            <!-- 1. 영대 배례 -->
                            <div>
                                <h4 class="font-serif text-2xl font-bold text-k-text mb-4 flex items-center gap-2">
                                    <span class="w-8 h-8 rounded-full bg-theme-color text-white flex items-center justify-center text-sm">1</span>
                                    영대 배례 (15배)
                                </h4>
                                <div class="bg-white p-6 rounded-xl border border-stone-200 shadow-sm space-y-4">
                                    <p class="text-stone-600 mb-2">시학원의 <strong class="text-theme-color">"일동 배례"</strong> 구령에 맞춥니다.</p>
                                    
                                    <!-- 배례 스텝 시각화 -->
                                    <div class="space-y-3">
                                        <div class="flex items-center gap-3 p-3 bg-stone-50 rounded-lg">
                                            <span class="font-bold text-stone-500 w-16">기본</span>
                                            <div class="flex-1 font-bold text-k-text">법배 4배 <span class="text-stone-400 text-sm font-normal">(제자리)</span></div>
                                        </div>
                                        <div class="flex items-center gap-3 p-3 bg-theme-soft/50 rounded-lg border border-theme-color/20">
                                            <span class="font-bold text-theme-color w-16">👣 →</span>
                                            <div class="flex-1">
                                                <div class="text-xs text-theme-color font-bold">우진 1보 (오른쪽 1걸음)</div>
                                                <div class="font-bold text-k-text">법배 4배</div>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-3 p-3 bg-blue-50 rounded-lg border border-blue-100">
                                            <span class="font-bold text-blue-600 w-16">← 👣</span>
                                            <div class="flex-1">
                                                <div class="text-xs text-blue-600 font-bold">좌진 2보 (왼쪽 2걸음)</div>
                                                <div class="font-bold text-k-text">평배 3배</div>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-3 p-3 bg-stone-50 rounded-lg">
                                            <span class="font-bold text-stone-500 w-16">👣 ↑</span>
                                            <div class="flex-1">
                                                <div class="text-xs text-stone-500 font-bold">갱진 1보 (왼쪽 1걸음)</div>
                                                <div class="font-bold text-k-text">평배 2배</div>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-3 p-3 bg-theme-soft/50 rounded-lg border border-theme-color/20">
                                            <span class="font-bold text-theme-color w-16">👣 →</span>
                                            <div class="flex-1">
                                                <div class="text-xs text-theme-color font-bold">우진 4보 (오른쪽 4걸음)</div>
                                                <div class="font-bold text-k-text">평배 2배</div>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-3 p-3 bg-blue-50 rounded-lg border border-blue-100">
                                            <span class="font-bold text-blue-600 w-16">← 👣</span>
                                            <div class="flex-1">
                                                <div class="text-xs text-blue-600 font-bold">좌진 2보, 향남읍, 바로</div>
                                                <div class="font-bold text-k-text">왼쪽 두 걸음, 남쪽 향해 읍하고 바로</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-center bg-stone-100 p-2 rounded text-stone-500 text-sm">
                                        구령: "국궁 예필" (국궁 자세 유지)
                                    </div>
                                </div>
                            </div>

                            <!-- 2. 대형 전환 시뮬레이터 -->
                            <div>
                                <h4 class="font-serif text-2xl font-bold text-k-text mb-4 flex items-center gap-2">
                                    <span class="w-8 h-8 rounded-full bg-theme-color text-white flex items-center justify-center text-sm">2</span>
                                    대형 전환 (3열 → 6열)
                                </h4>
                                <div class="bg-white p-5 rounded-xl border border-stone-200 shadow-sm mb-4">
                                    <div class="mb-5 space-y-2 text-stone-700">
                                        <p class="mb-3">구령 <strong class="text-theme-color">"6열로 우향우"</strong>에 맞춰 다음과 같이 행동합니다.</p>
                                        <ul class="list-disc list-inside space-y-1 pl-2 bg-stone-50 p-3 rounded-lg border border-stone-100">
                                            <li><strong>모든 공부자</strong>는 오른쪽(법단 방향)으로 섭니다.</li>
                                            <li><strong>3열 횡대 → 6열 종대</strong>로 변경됩니다.</li>
                                            <li class="text-stone-500 text-sm mt-1 list-none pl-4">💡 (홀수 번호는 제자리에서 우향우, 짝수 번호는 앞사람 우측으로 이동)</li>
                                        </ul>
                                    </div>
                                    <div id="simulation-placeholder"></div> <!-- 시뮬레이터 주입 위치 -->
                                </div>
                            </div>

                            <!-- 3. 법단 배례 -->
                            <div>
                                <h4 class="font-serif text-2xl font-bold text-k-text mb-4 flex items-center gap-2">
                                    <span class="w-8 h-8 rounded-full bg-theme-color text-white flex items-center justify-center text-sm">3</span>
                                    법단 배례 (8배)
                                </h4>
                                <div class="bg-white p-5 rounded-xl border border-stone-200 shadow-sm space-y-3">
                                    <div class="flex items-center gap-3 p-3 bg-stone-50 rounded-lg">
                                        <span class="font-bold text-stone-500 w-16">기본</span>
                                        <div class="flex-1 font-bold text-k-text">법배 4배 <span class="text-stone-400 text-sm">(구천상제님)</span></div>
                                    </div>
                                    <div class="flex items-center gap-3 p-3 bg-theme-soft/50 rounded-lg border border-theme-color/20">
                                        <span class="font-bold text-theme-color w-16">👣 →</span>
                                        <div class="flex-1">
                                            <div class="text-xs text-theme-color font-bold">우진 1보</div>
                                            <div class="font-bold text-k-text">법배 4배 <span class="text-stone-400 text-sm">(도주님)</span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 4. 원위치 -->
                            <div>
                                <h4 class="font-serif text-2xl font-bold text-k-text mb-4 flex items-center gap-2">
                                    <span class="w-8 h-8 rounded-full bg-theme-color text-white flex items-center justify-center text-sm">4</span>
                                    원위치 복귀 (시립)
                                </h4>
                                <div class="bg-white p-6 rounded-xl border border-stone-200 shadow-sm">
                                    <p class="text-stone-700 leading-relaxed mb-2">
                                        구령 <strong class="text-theme-color">"3열로 좌향좌"</strong>에 맞춰 왼쪽(영대 방향)으로 돕니다.
                                    </p>
                                    <ul class="list-disc list-inside space-y-1 pl-1 text-stone-600">
                                        <li>6열 종대에서 다시 <strong>3열 횡대 (원래 위치)</strong>로 복귀합니다.</li>
                                        <li>면수 자세로 영대를 향해 시립합니다.</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    `,
                    'exit': `
                        <div class="space-y-6">
                            <div class="bg-white p-5 rounded-xl border border-stone-200">
                                <strong class="block text-theme-color text-xl font-bold mb-3">1. 퇴장 대형 갖추기</strong>
                                <div class="bg-stone-50 p-3 rounded-lg border border-stone-200 mb-3 text-center">
                                    <span class="block text-sm text-stone-400 mb-1">시학원 구령</span>
                                    <span class="font-serif font-bold text-lg text-theme-color">"국궁 예필 퇴"</span>
                                </div>
                                <ul class="space-y-2 text-stone-700">
                                    <li>1. <strong>전체 좌향좌:</strong> <span class="text-red-600 font-bold">왼쪽 방향으로</span> 뒤로 돕니다.</li>
                                    <li>2. <strong>전진 3보:</strong> 앞으로 3발짝 이동하여 출구 방향과 정렬합니다.</li>
                                    <li>3. <strong>대열 정비:</strong> 앞쪽 5명(8~12번)은 다시 왼쪽 방향으로 뒤로 돌아, 6-7번 도인은 출구를 향해 섭니다.</li>
                                </ul>
                            </div>

                            <div class="bg-white p-5 rounded-xl border border-stone-200">
                                <strong class="block text-theme-color text-xl font-bold mb-3">2. 퇴장 시작</strong>
                                <p class="text-stone-700 mb-2">가장 안쪽 줄인 <strong>내수(여성)</strong> 줄부터 퇴장합니다.</p>
                                <p class="text-stone-700 mb-3 bg-stone-50 p-2 rounded"><strong>방법:</strong> 중앙의 2명(6번, 7번)을 선두로 <strong>2명씩 짝을 지어</strong> 나갑니다.</p>
                                <div class="flex items-center gap-2 text-sm font-bold text-stone-500 bg-stone-100 p-3 rounded-lg justify-center">
                                    <span class="text-red-600">내수 줄</span>
                                    <span>→</span>
                                    <span class="text-blue-600">외수 줄</span>
                                    <span>→</span>
                                    <span class="text-yellow-600">회원 줄</span>
                                </div>
                                <div class="mt-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 font-bold text-center">
                                    ⚠️ 문턱은 반드시 '왼발'부터 넘습니다!
                                </div>
                            </div>
                            
                            <!-- 퇴장 시뮬레이터가 삽입될 영역 -->
                            <div class="mt-6 border-t border-stone-200 pt-6">
                                <h5 class="text-lg font-bold text-theme-color mb-3 flex items-center gap-2">
                                    <span>🏃 퇴장 순서 시뮬레이터</span>
                                </h5>
                                <div id="exit-simulation-placeholder"></div>
                            </div>

                            <div class="bg-white p-5 rounded-xl border border-stone-200">
                                <strong class="block text-theme-color text-xl font-bold mb-3">3. 나가기</strong>
                                <p class="text-stone-700">정급(당번)이 정리해 둔 신발을 신고, 지체 없이 계단을 내려갑니다.</p>
                            </div>
                        </div>
                    `
                }
            }
        ];

        document.addEventListener('DOMContentLoaded', () => {
            renderAllSteps();
        });

        function getPhaseTimeRange(index) {
            return phases[index].timeRange || "";
        }

        // 전체 단계 렌더링
        function renderAllSteps() {
            const container = document.getElementById('steps-container');
            let html = '';

            phases.forEach((phase, index) => {
                const isOpen = index === 0 ? 'open' : '';
                
                html += `
                    <details class="phase-details group bg-white border border-stone-200 rounded-xl shadow-sm mb-4 overflow-hidden" ${isOpen}>
                        <summary class="phase-summary flex items-center justify-between p-5 md:p-6 cursor-pointer bg-white hover:bg-theme-soft/30 transition-colors list-none select-none border-l-4 border-transparent group-open:border-theme-color">
                            <div class="flex items-center gap-4 md:gap-5 flex-1">
                                <span class="flex-shrink-0 flex items-center justify-center w-12 h-12 rounded-full bg-stone-100 text-stone-500 font-bold font-serif text-xl group-open:bg-theme-color group-open:text-white transition-all shadow-sm border border-stone-200 group-open:border-theme-color">
                                    ${index + 1}
                                </span>
                                <div class="flex flex-col">
                                    <span class="text-xs font-bold text-stone-400 uppercase tracking-wider mb-0.5 group-open:text-theme-color">Step 0${index + 1}</span>
                                    <h3 class="text-xl md:text-2xl font-serif font-bold text-k-text group-open:text-theme-color transition-colors">${phase.title}</h3>
                                    <span class="md:hidden text-sm font-medium text-stone-400 mt-1">${getPhaseTimeRange(index)}</span>
                                </div>
                            </div>
                            
                            <div class="flex items-center gap-4">
                                <span class="hidden md:inline-block text-sm font-bold text-stone-500 bg-stone-100 px-3 py-1 rounded-full border border-stone-200 group-open:bg-theme-soft group-open:text-theme-color group-open:border-theme-color/20">
                                    ${getPhaseTimeRange(index)}
                                </span>
                                <span class="transform transition-transform duration-300 group-open:rotate-180 text-stone-400 group-open:text-theme-color">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                                    </svg>
                                </span>
                            </div>
                        </summary>
                        
                        <div class="border-t border-stone-100 bg-stone-50/50 p-5 md:p-8">
                            <p class="text-lg text-k-text font-medium mb-6 leading-relaxed bg-white p-4 rounded-lg border border-stone-200 shadow-sm">
                                ${phase.description}
                            </p>
                            
                            <!-- 분기 처리: 일반 스텝 vs 봉심 탭 -->
                            ${phase.isBongsim ? renderBongsimTabs(phase) : getPhaseContentHTML(phase)}
                        </div>
                    </details>
                `;
            });

            container.innerHTML = html;
            
            // 시뮬레이터 초기화 (탭 안에 주입)
            attachTabEvents();
            
            // 아코디언 상호작용
            const phaseDetails = container.querySelectorAll('.phase-details');
            phaseDetails.forEach((targetDetail) => {
                targetDetail.addEventListener('click', (e) => {
                    const clickedSummary = e.target.closest('summary');
                    if (clickedSummary && clickedSummary.parentElement === targetDetail) {
                        phaseDetails.forEach((detail) => {
                            if (detail !== targetDetail) detail.removeAttribute('open');
                        });
                    }
                });
            });
        }

        // 일반 단계 내용 생성
        function getPhaseContentHTML(phase) {
            let html = '<div class="space-y-4">';
            if (phase.steps && phase.steps.length > 0) {
                phase.steps.forEach(step => {
                    html += `
                        <div class="bg-white p-5 rounded-xl border border-stone-200 flex flex-col md:flex-row gap-4 md:items-start group hover:border-theme-color/50 transition-colors shadow-sm">
                            <div class="md:w-32 flex-shrink-0">
                                <span class="inline-block px-3 py-1 bg-theme-soft text-theme-color font-bold rounded-full text-sm border border-theme-color/20">
                                    ${step.time}
                                </span>
                            </div>
                            <div class="flex-grow">
                                <h4 class="font-serif text-xl font-bold text-k-text mb-2 group-hover:text-theme-color transition-colors">
                                    ${step.title}
                                </h4>
                                <p class="text-stone-600 text-lg leading-relaxed font-medium">${step.desc}</p>
                            </div>
                        </div>
                    `;
                });
            }
            html += '</div>';
            return html;
        }

        // 봉심 단계 탭 UI 생성
        function renderBongsimTabs(phase) {
            let tabsHtml = `<div class="bg-white rounded-xl border border-stone-200 overflow-hidden shadow-sm">`;
            
            // 탭 헤더
            tabsHtml += `<div class="flex border-b border-stone-200">`;
            phase.tabs.forEach((tab, idx) => {
                const isActive = idx === 0 ? 'active' : '';
                tabsHtml += `
                    <button class="tab-btn flex-1 py-4 text-center font-medium text-stone-500 hover:bg-stone-50 transition-colors border-b-2 border-transparent ${isActive}" data-tab="${tab.id}">
                        ${tab.label}
                    </button>
                `;
            });
            tabsHtml += `</div>`;

            // 탭 내용
            tabsHtml += `<div class="p-5 md:p-8 bg-white min-h-[300px]">`;
            phase.tabs.forEach((tab, idx) => {
                const isActive = idx === 0 ? 'active' : '';
                tabsHtml += `
                    <div id="tab-${tab.id}" class="tab-content ${isActive}">
                        ${phase.content[tab.id]}
                    </div>
                `;
            });
            tabsHtml += `</div></div>`;
            return tabsHtml;
        }

        // 시뮬레이터 생성 확인용 플래그
        let isSimInitialized = false;
        let isExitSimInitialized = false;

        // 탭 이벤트 및 시뮬레이터 주입
        function attachTabEvents() {
            const buttons = document.querySelectorAll('.tab-btn');
            const contents = document.querySelectorAll('.tab-content');

            // 1. 대형 전환 시뮬레이터 주입
            const simContainer = document.getElementById('simulation-placeholder');
            if (simContainer) {
                simContainer.innerHTML = renderSimulationUI();
                isSimInitialized = false; 
                setTimeout(() => updateSim('initial'), 100);
            }

            // 2. 퇴장 시뮬레이터 주입
            const exitSimContainer = document.getElementById('exit-simulation-placeholder');
            if (exitSimContainer) {
                exitSimContainer.innerHTML = renderExitSimulationUI();
                isExitSimInitialized = false;
                setTimeout(() => updateExitSim('initial'), 100);
            }

            // 3. 탭 클릭 이벤트
            buttons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetId = btn.getAttribute('data-tab');

                    // 버튼 활성화 처리
                    buttons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    // 내용 전환
                    contents.forEach(c => c.classList.remove('active'));
                    document.getElementById(`tab-${targetId}`).classList.add('active');
                });
            });
        }

        /* -----------------------------------------------------------------
           1. 봉심 대형 전환 시뮬레이터 관련 로직
           ----------------------------------------------------------------- */
        // 시뮬레이터 기본 껍데기 UI
        function renderSimulationUI() {
            return `
                <div class="mt-2 border-t border-stone-200 pt-4">
                    <div class="flex gap-2 mb-4 justify-center">
                        <button onclick="updateSim('initial')" class="flex-1 px-4 py-3 bg-white text-k-text font-bold rounded-lg border border-stone-300 shadow-sm text-sm active:bg-stone-100 hover:bg-stone-50 transition-colors">초기 정렬 (3열)</button>
                        <button onclick="updateSim('final')" class="flex-1 px-4 py-3 bg-theme-color text-white font-bold rounded-lg shadow-md text-sm active:bg-[#b45309] hover:bg-[#c26a05] transition-colors">6열 전환</button>
                    </div>

                    <div id="sim-container" class="bg-white border border-stone-200 rounded-xl mx-auto w-full relative h-[350px] overflow-hidden shadow-inner">
                        <div class="absolute inset-0 pointer-events-none opacity-10" style="background-image: linear-gradient(#1a1a1a 1px, transparent 1px), linear-gradient(90deg, #1a1a1a 1px, transparent 1px); background-size: 40px 40px;"></div>
                        
                        <div class="absolute right-0 top-0 h-full w-8 md:w-10 bg-stone-50 border-l border-stone-200 flex flex-col items-center justify-center z-20">
                            <span class="writing-vertical text-theme-color font-serif font-bold text-sm tracking-widest">법단</span>
                        </div>
                        <div class="absolute top-0 left-0 w-full h-8 md:h-10 bg-stone-50 border-b border-stone-200 flex items-center justify-center z-20">
                            <span class="text-theme-color font-serif font-bold text-sm tracking-widest pr-8 md:pr-10">영대</span>
                        </div>
                        
                        <!-- 애니메이션 요소들이 올라갈 바탕 -->
                        <div id="nodes-area" class="relative w-full h-full"></div>
                    </div>
                </div>
            `;
        }

        function initSimNodes() {
            const area = document.getElementById('nodes-area');
            if (!area) return;
            
            area.innerHTML = '';
            
            const roles = [
                { name: 'member', colorClass: 'bg-yellow-100 text-yellow-900 border border-yellow-400' },
                { name: 'oesu', colorClass: 'bg-blue-100 text-blue-900 border border-blue-400' },
                { name: 'naesu', colorClass: 'bg-red-100 text-red-900 border border-red-400' }
            ];

            const labelsRow1 = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12];
            const labelsRow23 = [11, 12, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10];

            roles.forEach((role, rIndex) => {
                const currentLabels = (rIndex === 0) ? labelsRow1 : labelsRow23;

                for (let i = 0; i < 12; i++) {
                    const num = currentLabels[i]; 

                    if (num % 2 === 0) {
                        const path = document.createElement('div');
                        path.id = `path-${role.name}-${num}`;
                        path.className = 'absolute z-0 arrow-path transition-opacity duration-700 opacity-0';
                        area.appendChild(path);
                    }

                    const node = document.createElement('div');
                    node.id = `node-${role.name}-${num}`;
                    node.className = `formation-node absolute w-6 h-6 md:w-8 md:h-8 rounded-full flex items-center justify-center text-xs md:text-sm font-bold shadow-md z-10 ${role.colorClass}`;
                    node.innerText = num;
                    if (num % 2 === 0) {
                        node.style.boxShadow = 'inset 0 0 0 2px rgba(255,255,255,0.7)'; 
                    }
                    area.appendChild(node);
                }
            });

            isSimInitialized = true;
        }

        function updateSim(state) {
            if (!isSimInitialized) initSimNodes();

            const roles = ['member', 'oesu', 'naesu'];
            const labelsRow1 = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12];
            const labelsRow23 = [11, 12, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10];

            const startLeft = 76; 
            const horizontalSpacing = 6.2; 

            roles.forEach((roleName, rIndex) => {
                const currentLabels = (rIndex === 0) ? labelsRow1 : labelsRow23;

                for (let i = 0; i < 12; i++) {
                    const colIndexFromRight = i; 
                    const num = currentLabels[i]; 
                    
                    let effectiveColIndex = colIndexFromRight;
                    if (state === 'final' && num % 2 === 0) {
                        effectiveColIndex = colIndexFromRight - 1; 
                    }
                    
                    let leftVal = (startLeft - (colIndexFromRight * horizontalSpacing)); 
                    let finalLeftVal = (startLeft - (effectiveColIndex * horizontalSpacing)); 
                    
                    let left = (state === 'final') ? finalLeftVal + '%' : leftVal + '%';
                    const rowBaseTop = 15 + (rIndex * 26); 
                    let top = rowBaseTop + '%';

                    const node = document.getElementById(`node-${roleName}-${num}`);
                    if (node) {
                        if (state === 'final') {
                            node.style.transform = 'rotate(90deg)'; 
                            if (num % 2 === 0) {
                                top = (rowBaseTop + 12) + '%';
                            }
                        } else {
                            node.style.transform = 'rotate(0deg)';
                        }
                        node.style.left = left;
                        node.style.top = top;
                    }

                    if (num % 2 === 0) {
                        const path = document.getElementById(`path-${roleName}-${num}`);
                        if (path) {
                            const offset = 2.5;
                            path.style.left = (leftVal + offset) + '%';
                            path.style.top = (rowBaseTop + offset) + '%';
                            path.style.width = ((finalLeftVal - leftVal)) + '%';
                            path.style.height = '12%'; 
                            path.style.borderLeft = '2px dotted #d97706'; 
                            path.style.borderBottom = '2px dotted #d97706';
                            path.style.borderBottomLeftRadius = '12px'; 

                            if (state === 'final') {
                                setTimeout(() => { path.style.opacity = '1'; }, 300);
                            } else {
                                path.style.opacity = '0';
                            }
                        }
                    }
                }
            });
        }

        /* -----------------------------------------------------------------
           2. 퇴장 (3. 퇴장) 시뮬레이터 관련 로직
           ----------------------------------------------------------------- */
        let exitTimeouts = [];

        function clearExitTimeouts() {
            exitTimeouts.forEach(clearTimeout);
            exitTimeouts = [];
        }

        function renderExitSimulationUI() {
            return `
                <div class="flex flex-wrap gap-2 mb-4 justify-center">
                    <button onclick="updateExitSim('initial')" class="px-3 py-2 bg-white text-k-text font-bold rounded-lg border border-stone-300 shadow-sm text-sm hover:bg-stone-50 transition-colors">1. 초기 정렬</button>
                    <button onclick="updateExitSim('shift')" class="px-3 py-2 bg-stone-100 text-k-text font-bold rounded-lg border border-stone-300 shadow-sm text-sm hover:bg-stone-200 transition-colors">2. 좌측 이동</button>
                    <button onclick="updateExitSim('exitNaesu')" class="px-3 py-2 bg-red-50 text-red-900 font-bold rounded-lg border border-red-300 shadow-sm text-sm hover:bg-red-100 transition-colors">3. 내수 퇴장</button>
                    <button onclick="updateExitSim('exitOesu')" class="px-3 py-2 bg-blue-50 text-blue-900 font-bold rounded-lg border border-blue-300 shadow-sm text-sm hover:bg-blue-100 transition-colors">4. 외수 퇴장</button>
                    <button onclick="updateExitSim('exitMember')" class="px-3 py-2 bg-yellow-50 text-yellow-900 font-bold rounded-lg border border-yellow-400 shadow-sm text-sm hover:bg-yellow-100 transition-colors">5. 회원 퇴장</button>
                </div>

                <div class="bg-white border border-stone-200 rounded-xl mx-auto w-full relative h-[420px] md:h-[450px] overflow-hidden shadow-inner" style="background-image: linear-gradient(#f5f5f4 1px, transparent 1px), linear-gradient(90deg, #f5f5f4 1px, transparent 1px); background-size: 40px 40px;">
                    
                    <!-- 영대 (상단) -->
                    <div class="absolute top-0 left-0 w-full h-8 md:h-10 bg-stone-50 border-b border-stone-200 flex items-center justify-center z-20">
                        <span class="text-theme-color font-serif font-bold text-sm tracking-widest pr-8 md:pr-10">영대</span>
                    </div>

                    <!-- 법단 (우측) -->
                    <div class="absolute right-0 top-0 h-full w-8 md:w-10 bg-stone-50 border-l border-stone-200 flex flex-col items-center justify-center z-20">
                        <span class="writing-vertical text-theme-color font-serif font-bold text-sm tracking-widest">법단</span>
                    </div>

                    <!-- 출구 (하단 좌측 치우침) -->
                    <div class="absolute bottom-0 left-[34%] w-[12%] h-8 bg-[#e5e5e5] border-t-2 border-x-2 border-stone-300 rounded-t-lg flex items-center justify-center z-20 shadow-sm">
                        <span class="text-stone-600 font-bold text-xs tracking-wider">출구</span>
                    </div>
                    
                    <!-- 애니메이션 노드 영역 -->
                    <div id="exit-nodes-area" class="relative w-full h-full"></div>
                </div>
            `;
        }

        function initExitSimNodes() {
            const area = document.getElementById('exit-nodes-area');
            if (!area) return;
            area.innerHTML = '';
            
            const roles = [
                { name: 'member', colorClass: 'bg-yellow-100 text-yellow-900 border border-yellow-400' },
                { name: 'oesu', colorClass: 'bg-blue-100 text-blue-900 border border-blue-400' },
                { name: 'naesu', colorClass: 'bg-red-100 text-red-900 border border-red-400' }
            ];

            const labelsRow1 = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]; // 회원 (오른쪽부터 1~12)
            const labelsRow23 = [11, 12, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10]; // 외수/내수 (오른쪽부터 11,12,1~10)

            roles.forEach((role, rIndex) => {
                const currentLabels = (rIndex === 0) ? labelsRow1 : labelsRow23;
                for (let i = 0; i < 12; i++) {
                    const num = currentLabels[i];
                    const node = document.createElement('div');
                    node.id = `exit-node-${role.name}-${num}`;
                    // 원활한 이동을 위해 transition 클래스 추가
                    node.className = `exit-node absolute w-6 h-6 md:w-8 md:h-8 rounded-full flex items-center justify-center text-xs md:text-sm font-bold shadow-md z-10 ${role.colorClass}`;
                    node.innerText = num;
                    area.appendChild(node);
                }
            });
            isExitSimInitialized = true;
        }

        function updateExitSim(state) {
            if (!isExitSimInitialized) initExitSimNodes();
            clearExitTimeouts(); // 새 버튼 클릭 시 기존 애니메이션 초기화
            
            const roles = ['member', 'oesu', 'naesu'];
            const labelsRow1 = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12];
            const labelsRow23 = [11, 12, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
            
            const baseLeft = 85; 
            const spacing = 6.2; 
            const shiftOffset = 11; // 중앙 쌍(인덱스 5,6)이 문(40%)에 오도록 좌측 이동 
            const rowTops = [20, 45, 70]; // 회원, 외수, 내수 Y 좌표 (영대에서 먼 순)
            
            const doorTop = 90; // 문 위치 Y

            // 1. 모든 사람 위치 및 상태 초기 설정
            roles.forEach((roleName, rIndex) => {
                const currentLabels = (rIndex === 0) ? labelsRow1 : labelsRow23;
                
                let isExited = false;
                if (state === 'exitOesu' && roleName === 'naesu') isExited = true;
                if (state === 'exitMember' && (roleName === 'naesu' || roleName === 'oesu')) isExited = true;

                for (let i = 0; i < 12; i++) {
                    const num = currentLabels[i];
                    const node = document.getElementById(`exit-node-${roleName}-${num}`);
                    if (!node) continue;
                    
                    node.style.transition = 'all 0.8s cubic-bezier(0.34, 1.1, 0.64, 1)';
                    
                    let left = baseLeft - (i * spacing);
                    if (state === 'shift' || state.startsWith('exit')) {
                        left -= shiftOffset;
                    }

                    if (isExited) {
                        // 이미 퇴장한 줄은 즉시 사라지게 처리
                        node.style.transition = 'none';
                        node.style.opacity = '0';
                        node.style.transform = 'scale(0.5)';
                        node.style.top = `${doorTop}%`;
                        void node.offsetWidth; // Force Reflow
                        node.style.transition = 'all 0.8s cubic-bezier(0.34, 1.1, 0.64, 1)';
                    } else {
                        // 대기 또는 전체 좌측 이동 세팅
                        node.style.left = `${left}%`;
                        node.style.top = `${rowTops[rIndex]}%`;
                        node.style.opacity = '1';
                        node.style.transform = 'scale(1)';
                    }
                }
            });

            // 2. 선택된 줄의 순차적 퇴장 + 보충 시퀀스 시작
            if (state.startsWith('exit')) {
                let roleIndex = state === 'exitMember' ? 0 : (state === 'exitOesu' ? 1 : 2);
                let roleName = roles[roleIndex];
                const currentLabels = (roleIndex === 0) ? labelsRow1 : labelsRow23;
                
                // 퇴장하는 짝의 인덱스 배열 (중앙에서 양 끝으로)
                const pairs = [[6, 5], [7, 4], [8, 3], [9, 2], [10, 1], [11, 0]];
                
                // 좌측 이동(shift)이 먼저 끝나도록 800ms 대기 후 시퀀스 시작
                const seqDelay = 800; 

                pairs.forEach((pair, step) => {
                    // ① 중앙 짝 아래로 수직 이동 (직각 하강)
                    let t1 = setTimeout(() => {
                        const leftNode = document.getElementById(`exit-node-${roleName}-${currentLabels[pair[0]]}`);
                        const rightNode = document.getElementById(`exit-node-${roleName}-${currentLabels[pair[1]]}`);
                        
                        // left값은 그대로 유지하고 top만 바꾸어 완벽한 수직(직각) 움직임 구현
                        if (leftNode) leftNode.style.top = `${doorTop}%`;
                        if (rightNode) rightNode.style.top = `${doorTop}%`;
                    }, seqDelay + step * 2000);
                    
                    // ② 문 도착 즈음 페이드아웃 처리
                    let t2 = setTimeout(() => {
                        const leftNode = document.getElementById(`exit-node-${roleName}-${currentLabels[pair[0]]}`);
                        const rightNode = document.getElementById(`exit-node-${roleName}-${currentLabels[pair[1]]}`);
                        
                        if (leftNode) { leftNode.style.opacity = '0'; leftNode.style.transform = 'scale(0.5)'; }
                        if (rightNode) { rightNode.style.opacity = '0'; rightNode.style.transform = 'scale(0.5)'; }
                    }, seqDelay + step * 2000 + 700);
                    
                    // ③ 남아 있는 도인들 중앙 빈자리로 수평 이동 (수직 이동 끝난 뒤 시작하여 직각 형태 보장)
                    let t3 = setTimeout(() => {
                        // 왼쪽 남은 사람들 (우측으로 1칸 수평 이동)
                        for (let i = pair[0] + 1; i <= 11; i++) {
                            const node = document.getElementById(`exit-node-${roleName}-${currentLabels[i]}`);
                            if (node) {
                                let currentLeft = baseLeft - i * spacing - shiftOffset + (step * spacing);
                                node.style.left = `${currentLeft + spacing}%`;
                            }
                        }
                        // 오른쪽 남은 사람들 (좌측으로 1칸 수평 이동)
                        for (let i = pair[1] - 1; i >= 0; i--) {
                            const node = document.getElementById(`exit-node-${roleName}-${currentLabels[i]}`);
                            if (node) {
                                let currentLeft = baseLeft - i * spacing - shiftOffset - (step * spacing);
                                node.style.left = `${currentLeft - spacing}%`;
                            }
                        }
                    }, seqDelay + step * 2000 + 1000);

                    exitTimeouts.push(t1, t2, t3);
                });
            }
        }
    </script>
<!-- 검색어 형광펜 및 자동 스크롤 기능 (수정됨) -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    const params = new URLSearchParams(window.location.search);
    const keyword = params.get('search');
    
    if (keyword) {
        // 본문이 자바스크립트로 생성될 시간을 벌어주기 위해 0.5초 대기합니다.
        setTimeout(() => {
            const walk = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT, null, false);
            let node;
            const textNodes = [];
            while (node = walk.nextNode()) {
                if (node.parentNode.nodeName !== 'SCRIPT' && node.parentNode.nodeName !== 'STYLE') {
                    textNodes.push(node);
                }
            }
            
            let found = false;
            textNodes.forEach(textNode => {
                if (textNode.nodeValue.includes(keyword)) {
                    const span = document.createElement('span');
                    const regex = new RegExp(`(${keyword})`, 'gi');
                    span.innerHTML = textNode.nodeValue.replace(regex, '<mark class="search-highlight" style="background-color: #fef08a; color: #1a1a1a; padding: 0 2px; border-radius: 2px; font-weight: bold;">$1</mark>');
                    textNode.parentNode.replaceChild(span, textNode);
                    found = true;
                }
            });

            if (found) {
                setTimeout(() => {
                    const firstMark = document.querySelector('mark.search-highlight');
                    if (firstMark) {
                        // 1. 숨겨진 아코디언(리스트) 안에 있다면 자동으로 열어주기
                        const detailsParent = firstMark.closest('details');
                        if (detailsParent) {
                            detailsParent.setAttribute('open', '');
                        }
                        
                        // 2. 숨겨진 탭 안에 있다면 해당 탭 클릭해서 열어주기
                        const tabParent = firstMark.closest('.tab-content');
                        if (tabParent) {
                            const tabId = tabParent.id.replace('tab-', '');
                            const tabBtn = document.querySelector(`.tab-btn[data-tab="${tabId}"]`);
                            if (tabBtn) tabBtn.click();
                        }

                        // 3. 해당 위치로 부드럽게 스크롤
                        firstMark.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 100);
            }
        }, 500); // 0.5초(500ms) 대기 후 실행
    }
});
</script>
</body>
</html>
